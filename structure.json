{
  "assets": {
    "alert.wav": "(binary)",
    "logo.png": "(binary)"
  },
  "config": {
    "camera_config.yaml": "cameras:\r\n  - id: 0\r\n    name: \"Front Camera\"\r\n    source: 0  # Camera index or RTSP URL # Camera index or \"rtsp://...\"\r\n    enabled: true\r\n    resolution:\r\n      width: 1280\r\n      height: 720\r\n    fps: 30\r\n    rotate: 0 # Degrees (0,90,180,270)\r\n  \r\n  - id: 1\r\n    name: \"Mobile Phone\"\r\n    source: \"http://192.168.1.100:8080/video\"  # URL de IP Webcam\r\n    enabled: true\r\n    resolution:\r\n      width: 1280\r\n      height: 720\r\n    fps: 30\r\n    rotate: 0 \r\n\r\n  - id: 2\r\n    name: \"Mobile Phone 2\"\r\n    source: \"http://192.168.1.101:8080/video\"  # Segundo telÃ©fono (diferente IP)\r\n    enabled: true\r\n    resolution:\r\n      width: 1280\r\n      height: 720\r\n    fps: 30\r\n    rotate: 0",
    "config.yaml": "app:\r\n  name: \"DSIP Recognition System\"\r\n  version: \"1.0.0\"\r\n  threshold: 0.6\r\n  screenshot_dir: \"data/screenshots\"\r\n  known_faces_dir: \"data/known_faces\"\r\n  database_path: \"data/database.db\"\r\n  alert_sound: \"assets/alert.wav\"\r\n  logo: \"assets/logo.png\"\r\n  log_dir: \"logs\"\r\n\r\nrecognition:\r\n  detection_threshold: 0.5\r\n  recognition_threshold: 0.6\r\n  max_batch_size: 8\r\n  device: \"cpu\"  # or \"cuda\"\r\n  analysis_enabled: true  # Enable age/gender/emotion\r\n  age_estimation: true\r\n  gender_detection: true\r\n\r\ntelegram:\r\n  enabled: true\r\n  bot_token: \"YOUR_BOT_TOKEN\"  # From @BotFather\r\n  chat_id: \"YOUR_CHAT_ID\"      # Get from @getidsbot\r\n  rate_limit: 30",
    "users.yaml": ""
  },
  "core": {
    "__init__.py": "",
    "__pycache__": {
      "__init__.cpython-310.pyc": "(binary)",
      "alert_system.cpython-310.pyc": "(binary)",
      "auth_manager.cpython-310.pyc": "(binary)",
      "camera_manager.cpython-310.pyc": "(binary)",
      "database.cpython-310.pyc": "(binary)",
      "face_detection.cpython-310.pyc": "(binary)",
      "telegram_manager.cpython-310.pyc": "(binary)",
      "utils.cpython-310.pyc": "(binary)"
    },
    "alert_system.py": "import os\r\nimport time\r\nfrom dataclasses import dataclass\r\nfrom typing import List, Dict, Optional\r\nfrom loguru import logger\r\n# from playsound import playsound\r\nimport cv2\r\nimport numpy as np\r\nfrom pathlib import Path\r\nfrom pygame import mixer\r\n\r\nfrom .telegram_manager import TelegramManager\r\nfrom .face_detection import Face\r\n\r\n# The `@dataclass` decorator in Python is used to automatically generate special methods such as\r\n# `__init__`, `__repr__`, `__eq__`, and `__hash__` for a class. In this specific case, the\r\n# `AlertEvent` class is a data class that represents an alert event with the following attributes:\r\n@dataclass\r\nclass AlertEvent:\r\n    camera_id: int\r\n    camera_name: str\r\n    face_name: str\r\n    confidence: float\r\n    timestamp: float\r\n    age: Optional[int] = None\r\n    gender: Optional[str] = None  # 'Male' or 'Female'\r\n    screenshot_path: Optional[str] = None\r\n\r\nclass AlertSystem:\r\n    def __init__(self, config: dict):\r\n        self.config = config\r\n        self.alert_sound = config['app']['alert_sound']\r\n        self.screenshot_dir = Path(config['app']['screenshot_dir'])\r\n        self.screenshot_dir.mkdir(parents=True, exist_ok=True)\r\n        self.alert_history: List[AlertEvent] = []\r\n        self.alert_enabled = True\r\n        self.screenshot_enabled = True\r\n        self.telegram = None\r\n        if config.get('telegram', {}).get('enabled', False):\r\n            self.telegram = TelegramManager(\r\n                config['telegram']['bot_token'],\r\n                config['telegram']['chat_id'],\r\n                config['telegram']['rate_limit']\r\n            )\r\n        mixer.init()  # Add this at the start of your application\r\n\r\n        \r\n    def trigger_alert(self, camera_id: int, camera_name: str, face_name: str, face: Face, confidence: float, frame: np.ndarray) -> AlertEvent:\r\n        \"\"\"Trigger an alert for a recognized face\"\"\"\r\n        timestamp = time.time()\r\n        screenshot_path = None\r\n        \r\n        if self.screenshot_enabled:\r\n            screenshot_path = self._capture_screenshot(frame, camera_id, face_name, timestamp)\r\n         # Ensure the path is converted to string and is not None when empty\r\n        \r\n        event = AlertEvent(\r\n            camera_id=camera_id,\r\n            camera_name=camera_name,\r\n            face_name=face_name,\r\n            age=face.age,\r\n            gender=face.gender,\r\n            confidence=confidence,\r\n            timestamp=timestamp,\r\n            screenshot_path=str(screenshot_path) if screenshot_path is not None else None\r\n        )\r\n        logger.debug(f\"Event created with screenshot path: {event.screenshot_path}\")  # Debug log\r\n        self.alert_history.append(event)\r\n\r\n        if self.alert_enabled:\r\n            self._play_alert_sound()\r\n        \r\n        if self.telegram:\r\n            message_lines = [\r\n                \"ðŸš¨ Face detected!\",\r\n                f\"ðŸ‘¤ Name: {face_name}\"\r\n            ]\r\n\r\n            if face.age:\r\n                message_lines.append(f\"ðŸ‘¶ Age: ~{face.age} years\")\r\n            if face.gender:\r\n                message_lines.append(f\"ðŸš» Gender: {face.gender}\")\r\n                \r\n            message_lines.extend([\r\n                f\"ðŸ“· Camera: {camera_name}\",\r\n                f\"ðŸŽ¯ Confidence: {confidence:.2%}\",\r\n                f\"â° Time: {time.strftime('%Y-%m-%d %H:%M:%S')}\"\r\n            ])\r\n\r\n            message = \"\\n\".join(message_lines)\r\n            \r\n            self.telegram.send_alert(\r\n                message=message,\r\n                image_path=screenshot_path\r\n            )\r\n            \r\n        logger.info(f\"Alert triggered: {face_name} detected on {camera_name} with confidence {confidence:.2f}\")\r\n        return event\r\n        \r\n    def _play_alert_sound(self) -> None:\r\n        \"\"\"\r\n        The function `_play_alert_sound` attempts to play an alert sound file using the `mixer.music`\r\n        module in Python, logging an error if there is an exception.\r\n        \"\"\"\r\n        try:\r\n            if os.path.exists(self.alert_sound):\r\n                # playsound(self.alert_sound, block=False)\r\n                  mixer.music.load(self.alert_sound)\r\n                  mixer.music.play()\r\n        except Exception as e:\r\n            logger.error(f\"Error playing alert sound: {e}\")\r\n\r\n    def _capture_screenshot(self, frame: np.ndarray, camera_id: int, face_name: str, timestamp: float) -> Optional[Path]:\r\n        \"\"\"Capture and save a screenshot of the alert\"\"\"\r\n        try:\r\n            timestamp_str = time.strftime(\"%Y%m%d_%H%M%S\", time.localtime(timestamp))\r\n            filename = f\"{timestamp_str}_cam{camera_id}_{face_name}.jpg\"\r\n            filepath = self.screenshot_dir / filename\r\n            \r\n            # Ensure directory exists\r\n            filepath.parent.mkdir(parents=True, exist_ok=True)\r\n            \r\n            # Save the image\r\n            success = cv2.imwrite(str(filepath), frame)\r\n            if not success:\r\n                logger.error(f\"Failed to save screenshot to {filepath}\")\r\n                return None\r\n                \r\n            logger.info(f\"Screenshot saved: {filepath}\")\r\n            return filepath\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error capturing screenshot: {e}\")\r\n            return None\r\n\r\n    def get_recent_alerts(self, limit: int = 10) -> List[AlertEvent]:\r\n        \"\"\"Get most recent alerts\"\"\"\r\n        return sorted(self.alert_history, key=lambda x: x.timestamp, reverse=True)[:limit]\r\n\r\n    def clear_alerts(self) -> None:\r\n        \"\"\"Clear alert history\"\"\"\r\n        self.alert_history.clear()\r\n\r\n    def enable_alerts(self, enabled: bool) -> None:\r\n        \"\"\"Enable or disable alerts\"\"\"\r\n        self.alert_enabled = enabled\r\n        logger.info(f\"Alerts {'enabled' if enabled else 'disabled'}\")\r\n\r\n    def enable_screenshots(self, enabled: bool) -> None:\r\n        \"\"\"Enable or disable screenshot capture\"\"\"\r\n        self.screenshot_enabled = enabled\r\n        logger.info(f\"Screenshots {'enabled' if enabled else 'disabled'}\")\r\n    \r\n    def shutdown(self):\r\n        \"\"\"Cleanup alert system resources\"\"\"\r\n        if hasattr(self, 'telegram') and self.telegram:\r\n            self.telegram.shutdown()",
    "auth_manager.py": "import bcrypt\r\nimport time\r\nfrom dataclasses import dataclass\r\nfrom typing import Optional, Dict\r\nfrom loguru import logger\r\nfrom datetime import datetime, timedelta\r\n\r\n@dataclass\r\nclass User:\r\n    id: int\r\n    username: str\r\n    email: str\r\n    role: str  # 'admin', 'operator', 'viewer'\r\n    created_at: float\r\n    last_login: Optional[float] = None\r\n    is_active: bool = True\r\n\r\n@dataclass\r\nclass Session:\r\n    user: User\r\n    login_time: float\r\n    last_activity: float\r\n    \r\n    def is_expired(self, timeout_minutes: int = 60) -> bool:\r\n        \"\"\"Check if session has expired\"\"\"\r\n        current_time = time.time()\r\n        elapsed = (current_time - self.last_activity) / 60\r\n        return elapsed > timeout_minutes\r\n    \r\n    def update_activity(self):\r\n        \"\"\"Update last activity timestamp\"\"\"\r\n        self.last_activity = time.time()\r\n\r\nclass AuthManager:\r\n    def __init__(self, database):\r\n        self.database = database\r\n        self.current_session: Optional[Session] = None\r\n        self.session_timeout = 60  # minutes\r\n        self.max_login_attempts = 5\r\n        self.lockout_duration = 300  # 5 minutes in seconds\r\n        self.failed_attempts: Dict[str, list] = {}\r\n        \r\n    def hash_password(self, password: str) -> str:\r\n        \"\"\"Hash a password using bcrypt\"\"\"\r\n        salt = bcrypt.gensalt()\r\n        hashed = bcrypt.hashpw(password.encode('utf-8'), salt)\r\n        return hashed.decode('utf-8')\r\n    \r\n    def verify_password(self, password: str, hashed: str) -> bool:\r\n        \"\"\"Verify a password against its hash\"\"\"\r\n        try:\r\n            return bcrypt.checkpw(password.encode('utf-8'), hashed.encode('utf-8'))\r\n        except Exception as e:\r\n            logger.error(f\"Error verifying password: {e}\")\r\n            return False\r\n    \r\n    def is_locked_out(self, username: str) -> bool:\r\n        \"\"\"Check if user is temporarily locked out\"\"\"\r\n        if username not in self.failed_attempts:\r\n            return False\r\n        \r\n        attempts = self.failed_attempts[username]\r\n        if len(attempts) < self.max_login_attempts:\r\n            return False\r\n        \r\n        # Check if lockout period has expired\r\n        last_attempt = attempts[-1]\r\n        if time.time() - last_attempt > self.lockout_duration:\r\n            # Reset attempts\r\n            self.failed_attempts[username] = []\r\n            return False\r\n        \r\n        return True\r\n    \r\n    def record_failed_attempt(self, username: str):\r\n        \"\"\"Record a failed login attempt\"\"\"\r\n        if username not in self.failed_attempts:\r\n            self.failed_attempts[username] = []\r\n        self.failed_attempts[username].append(time.time())\r\n        \r\n        # Keep only recent attempts\r\n        cutoff = time.time() - self.lockout_duration\r\n        self.failed_attempts[username] = [\r\n            t for t in self.failed_attempts[username] if t > cutoff\r\n        ]\r\n    \r\n    def clear_failed_attempts(self, username: str):\r\n        \"\"\"Clear failed login attempts for user\"\"\"\r\n        if username in self.failed_attempts:\r\n            self.failed_attempts[username] = []\r\n    \r\n    def login(self, username: str, password: str) -> tuple[bool, str, Optional[User]]:\r\n        \"\"\"\r\n        Authenticate user\r\n        Returns: (success, message, user)\r\n        \"\"\"\r\n        try:\r\n            # Check if locked out\r\n            if self.is_locked_out(username):\r\n                remaining = self.lockout_duration - (time.time() - self.failed_attempts[username][-1])\r\n                return False, f\"Account locked. Try again in {int(remaining/60)} minutes\", None\r\n            \r\n            # Get user from database\r\n            user_data = self.database.get_user_by_username(username)\r\n            if not user_data:\r\n                self.record_failed_attempt(username)\r\n                return False, \"Invalid username or password\", None\r\n            \r\n            # Check if user is active\r\n            if not user_data['is_active']:\r\n                return False, \"Account is disabled\", None\r\n            \r\n            # Verify password\r\n            if not self.verify_password(password, user_data['password_hash']):\r\n                self.record_failed_attempt(username)\r\n                attempts_left = self.max_login_attempts - len(self.failed_attempts.get(username, []))\r\n                return False, f\"Invalid username or password. {attempts_left} attempts remaining\", None\r\n            \r\n            # Clear failed attempts on successful login\r\n            self.clear_failed_attempts(username)\r\n            \r\n            # Create user object\r\n            user = User(\r\n                id=user_data['id'],\r\n                username=user_data['username'],\r\n                email=user_data['email'],\r\n                role=user_data['role'],\r\n                created_at=user_data['created_at'],\r\n                last_login=user_data['last_login'],\r\n                is_active=user_data['is_active']\r\n            )\r\n            \r\n            # Create session\r\n            self.current_session = Session(\r\n                user=user,\r\n                login_time=time.time(),\r\n                last_activity=time.time()\r\n            )\r\n            \r\n            # Update last login in database\r\n            self.database.update_last_login(user.id)\r\n            \r\n            # Log successful login\r\n            logger.info(f\"User {username} logged in successfully\")\r\n            \r\n            return True, \"Login successful\", user\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error during login: {e}\")\r\n            return False, \"An error occurred during login\", None\r\n    \r\n    def logout(self):\r\n        \"\"\"Logout current user\"\"\"\r\n        if self.current_session:\r\n            logger.info(f\"User {self.current_session.user.username} logged out\")\r\n            self.current_session = None\r\n    \r\n    def is_authenticated(self) -> bool:\r\n        \"\"\"Check if there's an active session\"\"\"\r\n        if not self.current_session:\r\n            return False\r\n        \r\n        if self.current_session.is_expired(self.session_timeout):\r\n            logger.warning(f\"Session expired for user {self.current_session.user.username}\")\r\n            self.current_session = None\r\n            return False\r\n        \r\n        self.current_session.update_activity()\r\n        return True\r\n    \r\n    def get_current_user(self) -> Optional[User]:\r\n        \"\"\"Get currently logged in user\"\"\"\r\n        if self.is_authenticated():\r\n            return self.current_session.user\r\n        return None\r\n    \r\n    def has_permission(self, required_role: str) -> bool:\r\n        \"\"\"\r\n        Check if current user has required permission\r\n        Role hierarchy: admin > operator > viewer\r\n        \"\"\"\r\n        if not self.is_authenticated():\r\n            return False\r\n        \r\n        user = self.current_session.user\r\n        role_hierarchy = {'viewer': 1, 'operator': 2, 'admin': 3}\r\n        \r\n        user_level = role_hierarchy.get(user.role, 0)\r\n        required_level = role_hierarchy.get(required_role, 0)\r\n        \r\n        return user_level >= required_level\r\n    \r\n    def change_password(self, old_password: str, new_password: str) -> tuple[bool, str]:\r\n        \"\"\"Change password for current user\"\"\"\r\n        if not self.is_authenticated():\r\n            return False, \"Not authenticated\"\r\n        \r\n        user = self.current_session.user\r\n        \r\n        # Verify old password\r\n        user_data = self.database.get_user_by_username(user.username)\r\n        if not self.verify_password(old_password, user_data['password_hash']):\r\n            return False, \"Current password is incorrect\"\r\n        \r\n        # Validate new password\r\n        if len(new_password) < 8:\r\n            return False, \"New password must be at least 8 characters\"\r\n        \r\n        # Update password\r\n        new_hash = self.hash_password(new_password)\r\n        if self.database.update_user_password(user.id, new_hash):\r\n            logger.info(f\"Password changed for user {user.username}\")\r\n            return True, \"Password changed successfully\"\r\n        \r\n        return False, \"Failed to update password\"",
    "camera_manager.py": "import cv2\r\nimport numpy as np\r\nfrom typing import List, Dict, Optional, Tuple\r\nfrom dataclasses import dataclass\r\nfrom loguru import logger\r\nimport time\r\nimport threading\r\nimport queue\r\nimport yaml\r\nfrom pathlib import Path\r\n\r\n@dataclass\r\nclass CameraConfig:\r\n    id: int\r\n    name: str\r\n    source: str\r\n    enabled: bool\r\n    width: int\r\n    height: int\r\n    fps: int\r\n    rotate: int\r\n\r\nclass CameraManager:\r\n    def __init__(self, config_path: str):\r\n        self.cameras: Dict[int, CameraConfig] = {}\r\n        self.capture_threads: Dict[int, threading.Thread] = {}\r\n        self.capture_objects: Dict[int, cv2.VideoCapture] = {}\r\n        self.stop_events: Dict[int, threading.Event] = {}\r\n        self.frame_queues: Dict[int, queue.Queue] = {}\r\n        self.thread_lock = threading.Lock()\r\n        self.load_config(config_path)\r\n\r\n    def _cleanup_camera_thread(self, cam_id: int, timeout: float = 5.0):\r\n        \"\"\"Clean up camera thread resources with improved timeout handling\"\"\"\r\n        try:\r\n            with self.thread_lock:\r\n                # Signal thread to stop\r\n                if cam_id in self.stop_events:\r\n                    self.stop_events[cam_id].set()\r\n                \r\n                # Wait for thread to finish with timeout\r\n                if cam_id in self.capture_threads:\r\n                    thread = self.capture_threads[cam_id]\r\n                    if thread.is_alive():\r\n                        logger.debug(f\"Waiting for camera {cam_id} thread to stop...\")\r\n                        thread.join(timeout=timeout)\r\n                        \r\n                        if thread.is_alive():\r\n                            logger.error(f\"Camera {cam_id} thread did not stop within {timeout}s timeout\")\r\n                            # Thread is still alive but we'll proceed with cleanup\r\n                        else:\r\n                            logger.debug(f\"Camera {cam_id} thread stopped successfully\")\r\n                    \r\n                    del self.capture_threads[cam_id]\r\n                \r\n                # Close video capture object\r\n                if cam_id in self.capture_objects:\r\n                    try:\r\n                        cap = self.capture_objects[cam_id]\r\n                        if cap.isOpened():\r\n                            cap.release()\r\n                        del self.capture_objects[cam_id]\r\n                        logger.debug(f\"Released video capture for camera {cam_id}\")\r\n                    except Exception as e:\r\n                        logger.error(f\"Error releasing video capture for camera {cam_id}: {e}\")\r\n                \r\n                # Clean up queue\r\n                if cam_id in self.frame_queues:\r\n                    try:\r\n                        # Empty the queue\r\n                        while not self.frame_queues[cam_id].empty():\r\n                            try:\r\n                                self.frame_queues[cam_id].get_nowait()\r\n                            except queue.Empty:\r\n                                break\r\n                        del self.frame_queues[cam_id]\r\n                    except Exception as e:\r\n                        logger.error(f\"Error cleaning queue for camera {cam_id}: {e}\")\r\n                \r\n                # Clean up stop event\r\n                if cam_id in self.stop_events:\r\n                    del self.stop_events[cam_id]\r\n                    \r\n                logger.info(f\"Cleaned up resources for camera {cam_id}\")\r\n                \r\n        except Exception as e:\r\n            logger.error(f\"Error during cleanup of camera {cam_id}: {e}\")\r\n\r\n    def load_config(self, config_path: str) -> None:\r\n        \"\"\"Load camera configuration from YAML file\"\"\"\r\n        try:\r\n            with open(config_path, 'r') as f:\r\n                config = yaml.safe_load(f)\r\n                \r\n            self.cameras.clear()\r\n            for cam_config in config.get('cameras', []):\r\n                cam_id = cam_config['id']\r\n                self.cameras[cam_id] = CameraConfig(\r\n                    id=cam_id,\r\n                    name=cam_config.get('name', f'Camera {cam_id}'),\r\n                    source=cam_config['source'],\r\n                    enabled=cam_config.get('enabled', True),\r\n                    width=cam_config['resolution']['width'],\r\n                    height=cam_config['resolution']['height'],\r\n                    fps=cam_config.get('fps', 30),\r\n                    rotate=cam_config.get('rotate', 0)\r\n                )\r\n                \r\n            logger.info(f\"Loaded {len(self.cameras)} camera configurations\")\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error loading camera config: {e}\")\r\n            raise\r\n\r\n    def _validate_camera_source(self, cam_id: int, source) -> bool:\r\n        \"\"\"Validate camera source before attempting to connect\"\"\"\r\n        try:\r\n            # For HTTP/RTSP sources\r\n            if isinstance(source, str) and (source.startswith('http') or source.startswith('rtsp')):\r\n                logger.info(f\"Validating network camera {cam_id}: {source}\")\r\n                \r\n                # Try a quick connection test\r\n                import requests\r\n                from urllib.parse import urlparse\r\n                \r\n                try:\r\n                    # Extract base URL for ping test\r\n                    parsed = urlparse(source)\r\n                    base_url = f\"{parsed.scheme}://{parsed.netloc}\"\r\n                    \r\n                    # Quick HEAD request with short timeout\r\n                    response = requests.head(base_url, timeout=3)\r\n                    if response.status_code >= 400:\r\n                        logger.warning(f\"Camera {cam_id} returned status {response.status_code}\")\r\n                        return False\r\n                    \r\n                    logger.info(f\"Network camera {cam_id} is reachable\")\r\n                    return True\r\n                    \r\n                except requests.RequestException as e:\r\n                    logger.warning(f\"Camera {cam_id} validation failed: {e}\")\r\n                    return False\r\n            \r\n            # For local cameras (integer index)\r\n            elif isinstance(source, int):\r\n                logger.info(f\"Local camera index {source} detected\")\r\n                return True\r\n            \r\n            return True\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error validating camera {cam_id} source: {e}\")\r\n            return False\r\n\r\n    def start_all_cameras(self) -> None:\r\n        \"\"\"Start all enabled cameras\"\"\"\r\n        for cam_id, cam_config in self.cameras.items():\r\n            if cam_config.enabled:\r\n                self.start_camera(cam_id)\r\n\r\n    def stop_all_cameras(self) -> None:\r\n        \"\"\"Stop all camera threads\"\"\"\r\n        with self.thread_lock:\r\n            cam_ids = list(self.capture_threads.keys())\r\n        \r\n        for cam_id in cam_ids:\r\n            self.stop_camera(cam_id)\r\n        \r\n        logger.info(\"All camera threads stopped\")\r\n\r\n    def start_camera(self, cam_id: int) -> bool:\r\n        \"\"\"Start a single camera with validation\"\"\"\r\n        if cam_id not in self.cameras:\r\n            logger.error(f\"Camera ID {cam_id} not found in configuration\")\r\n            return False\r\n            \r\n        cam_config = self.cameras[cam_id]\r\n        \r\n        if not cam_config.enabled:\r\n            logger.warning(f\"Camera ID {cam_id} is disabled in configuration\")\r\n            return False\r\n        \r\n        # Validate source before starting\r\n        if not self._validate_camera_source(cam_id, cam_config.source):\r\n            logger.error(f\"Camera ID {cam_id} source validation failed\")\r\n            return False\r\n        \r\n        # Clean up any existing thread first\r\n        if cam_id in self.capture_threads:\r\n            logger.info(f\"Stopping existing thread for camera {cam_id}\")\r\n            self._cleanup_camera_thread(cam_id)\r\n        \r\n        try:\r\n            # Create new resources\r\n            self.frame_queues[cam_id] = queue.Queue(maxsize=2)\r\n            self.stop_events[cam_id] = threading.Event()\r\n            \r\n            # Create and start thread\r\n            thread = threading.Thread(\r\n                target=self._capture_frames,\r\n                args=(cam_id,),\r\n                daemon=True,\r\n                name=f\"CameraThread-{cam_id}\"\r\n            )\r\n            \r\n            with self.thread_lock:\r\n                self.capture_threads[cam_id] = thread\r\n            \r\n            thread.start()\r\n            logger.info(f\"Started camera ID {cam_id}\")\r\n            return True\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Failed to start camera {cam_id}: {e}\")\r\n            self._cleanup_camera_thread(cam_id)\r\n            return False\r\n\r\n    def stop_camera(self, cam_id: int) -> bool:\r\n        \"\"\"Stop a single camera\"\"\"\r\n        if cam_id in self.capture_threads:\r\n            self._cleanup_camera_thread(cam_id, timeout=5.0)\r\n            logger.info(f\"Stopped camera ID {cam_id}\")\r\n            return True\r\n        return False\r\n\r\n    def _capture_frames(self, cam_id: int) -> None:\r\n        \"\"\"Thread function to capture frames from a camera\"\"\"\r\n        cam_config = self.cameras[cam_id]\r\n        cap = None\r\n        retry_count = 0\r\n        max_retries = 3\r\n        retry_delay = 2.0\r\n        \r\n        try:\r\n            # Handle different source types\r\n            source = int(cam_config.source) if str(cam_config.source).isdigit() else cam_config.source\r\n            \r\n            # Try to open camera with retries\r\n            while retry_count < max_retries and not self.stop_events[cam_id].is_set():\r\n                try:\r\n                    cap = cv2.VideoCapture(source)\r\n                    \r\n                    if not cap.isOpened():\r\n                        raise RuntimeError(f\"Failed to open camera source: {source}\")\r\n                    \r\n                    # Store capture object for cleanup\r\n                    with self.thread_lock:\r\n                        self.capture_objects[cam_id] = cap\r\n                    \r\n                    # Set camera properties\r\n                    cap.set(cv2.CAP_PROP_FRAME_WIDTH, cam_config.width)\r\n                    cap.set(cv2.CAP_PROP_FRAME_HEIGHT, cam_config.height)\r\n                    cap.set(cv2.CAP_PROP_FPS, cam_config.fps)\r\n                    \r\n                    # Additional settings for better performance\r\n                    cap.set(cv2.CAP_PROP_BUFFERSIZE, 1)  # Minimize buffering\r\n                    \r\n                    logger.info(f\"Camera ID {cam_id} opened successfully\")\r\n                    break\r\n                    \r\n                except Exception as e:\r\n                    retry_count += 1\r\n                    if retry_count < max_retries:\r\n                        logger.warning(f\"Camera {cam_id} open attempt {retry_count} failed: {e}. Retrying in {retry_delay}s...\")\r\n                        time.sleep(retry_delay)\r\n                    else:\r\n                        logger.error(f\"Failed to open camera ID {cam_id} after {max_retries} attempts\")\r\n                        return\r\n            \r\n            if cap is None or not cap.isOpened():\r\n                logger.error(f\"Failed to open camera ID {cam_id} with source {cam_config.source}\")\r\n                return\r\n            \r\n            # Frame capture loop\r\n            consecutive_failures = 0\r\n            max_consecutive_failures = 10\r\n            \r\n            while not self.stop_events[cam_id].is_set():\r\n                try:\r\n                    ret, frame = cap.read()\r\n                    \r\n                    if not ret or frame is None:\r\n                        consecutive_failures += 1\r\n                        logger.warning(f\"Camera ID {cam_id} read failed (attempt {consecutive_failures}/{max_consecutive_failures})\")\r\n                        \r\n                        if consecutive_failures >= max_consecutive_failures:\r\n                            logger.error(f\"Camera ID {cam_id} exceeded maximum consecutive failures\")\r\n                            break\r\n                        \r\n                        time.sleep(0.5)\r\n                        continue\r\n                    \r\n                    # Reset failure counter on success\r\n                    consecutive_failures = 0\r\n                    \r\n                    # Apply rotation if needed\r\n                    if cam_config.rotate == 90:\r\n                        frame = cv2.rotate(frame, cv2.ROTATE_90_CLOCKWISE)\r\n                    elif cam_config.rotate == 180:\r\n                        frame = cv2.rotate(frame, cv2.ROTATE_180)\r\n                    elif cam_config.rotate == 270:\r\n                        frame = cv2.rotate(frame, cv2.ROTATE_90_COUNTERCLOCKWISE)\r\n                    \r\n                    # Put frame in queue (non-blocking)\r\n                    if cam_id in self.frame_queues:\r\n                        # Remove old frame if queue is full\r\n                        if self.frame_queues[cam_id].full():\r\n                            try:\r\n                                self.frame_queues[cam_id].get_nowait()\r\n                            except queue.Empty:\r\n                                pass\r\n                        \r\n                        try:\r\n                            self.frame_queues[cam_id].put(frame, block=False)\r\n                        except queue.Full:\r\n                            pass  # Frame dropped, continue to next\r\n                    \r\n                    # Small delay to prevent CPU overload\r\n                    time.sleep(0.001)\r\n                    \r\n                except Exception as e:\r\n                    logger.error(f\"Error in camera ID {cam_id} capture loop: {e}\")\r\n                    consecutive_failures += 1\r\n                    if consecutive_failures >= max_consecutive_failures:\r\n                        break\r\n                    time.sleep(0.5)\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Fatal error in camera ID {cam_id} capture thread: {e}\")\r\n            \r\n        finally:\r\n            # Cleanup\r\n            if cap is not None:\r\n                try:\r\n                    cap.release()\r\n                    logger.debug(f\"Released VideoCapture for camera {cam_id}\")\r\n                except Exception as e:\r\n                    logger.error(f\"Error releasing VideoCapture for camera {cam_id}: {e}\")\r\n            \r\n            logger.info(f\"Camera ID {cam_id} capture thread exiting\")\r\n\r\n    def get_frame(self, cam_id: int) -> Optional[np.ndarray]:\r\n        \"\"\"Get the latest frame from a camera\"\"\"\r\n        if cam_id not in self.frame_queues:\r\n            return None\r\n            \r\n        try:\r\n            return self.frame_queues[cam_id].get_nowait()\r\n        except queue.Empty:\r\n            return None\r\n\r\n    def get_all_frames(self) -> Dict[int, np.ndarray]:\r\n        \"\"\"Get latest frames from all cameras\"\"\"\r\n        frames = {}\r\n        for cam_id in list(self.frame_queues.keys()):\r\n            frame = self.get_frame(cam_id)\r\n            if frame is not None:\r\n                frames[cam_id] = frame\r\n        return frames\r\n\r\n    def get_camera_status(self, cam_id: int) -> Dict:\r\n        \"\"\"Get camera status information\"\"\"\r\n        if cam_id not in self.cameras:\r\n            return {}\r\n        \r\n        with self.thread_lock:\r\n            is_running = cam_id in self.capture_threads and self.capture_threads[cam_id].is_alive()\r\n            \r\n        status = {\r\n            'id': cam_id,\r\n            'name': self.cameras[cam_id].name,\r\n            'running': is_running,\r\n            'frame_queue_size': self.frame_queues[cam_id].qsize() if cam_id in self.frame_queues else 0,\r\n            'enabled': self.cameras[cam_id].enabled,\r\n            'source': self.cameras[cam_id].source\r\n        }\r\n        return status\r\n\r\n    def get_all_camera_status(self) -> List[Dict]:\r\n        \"\"\"Get status for all cameras\"\"\"\r\n        return [self.get_camera_status(cam_id) for cam_id in self.cameras]\r\n\r\n    def __del__(self):\r\n        \"\"\"Destructor to ensure all cameras are stopped\"\"\"\r\n        try:\r\n            self.stop_all_cameras()\r\n        except Exception as e:\r\n            logger.error(f\"Error in CameraManager destructor: {e}\")",
    "database.py": "import sqlite3\r\nfrom dataclasses import dataclass\r\nfrom typing import List, Optional, Dict\r\nfrom pathlib import Path\r\nfrom loguru import logger\r\nimport time\r\n\r\n@dataclass\r\nclass FaceLogEntry:\r\n    id: int\r\n    timestamp: float\r\n    camera_id: int\r\n    camera_name: str\r\n    face_name: str\r\n    age: Optional[int]\r\n    gender: Optional[str]\r\n    confidence: float\r\n    screenshot_path: Optional[str]\r\n    user_id: Optional[int] = None\r\n\r\n    def __post_init__(self):\r\n        if isinstance(self.timestamp, bytes):\r\n            self.timestamp = float(self.timestamp.decode('utf-8'))\r\n        elif isinstance(self.timestamp, str):\r\n            self.timestamp = float(self.timestamp)\r\n\r\nclass FaceDatabase:\r\n    def __init__(self, db_path: str):\r\n        self.db_path = Path(db_path)\r\n        self._init_db()\r\n\r\n    def _init_db(self) -> None:\r\n        \"\"\"Initialize the database with required tables and handle migrations\"\"\"\r\n        try:\r\n            self.db_path.parent.mkdir(parents=True, exist_ok=True)\r\n            \r\n            with sqlite3.connect(self.db_path) as conn:\r\n                cursor = conn.cursor()\r\n                \r\n                # Create users table\r\n                cursor.execute('''\r\n                    CREATE TABLE IF NOT EXISTS users (\r\n                        id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n                        username TEXT NOT NULL UNIQUE,\r\n                        email TEXT NOT NULL UNIQUE,\r\n                        password_hash TEXT NOT NULL,\r\n                        role TEXT NOT NULL DEFAULT 'viewer',\r\n                        is_active BOOLEAN NOT NULL DEFAULT 1,\r\n                        created_at REAL NOT NULL,\r\n                        last_login REAL,\r\n                        created_by INTEGER,\r\n                        FOREIGN KEY (created_by) REFERENCES users(id)\r\n                    )\r\n                ''')\r\n                \r\n                # Create face_logs table with user_id\r\n                cursor.execute('''\r\n                    CREATE TABLE IF NOT EXISTS face_logs (\r\n                        id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n                        timestamp REAL NOT NULL,\r\n                        camera_id INTEGER NOT NULL,\r\n                        camera_name TEXT NOT NULL,\r\n                        face_name TEXT NOT NULL,\r\n                        age INTEGER,\r\n                        gender TEXT,\r\n                        confidence REAL NOT NULL,\r\n                        screenshot_path TEXT,\r\n                        user_id INTEGER,\r\n                        FOREIGN KEY (user_id) REFERENCES users(id)\r\n                    )\r\n                ''')\r\n                \r\n                # Create known_faces table with new columns\r\n                cursor.execute('''\r\n                    CREATE TABLE IF NOT EXISTS known_faces (\r\n                        id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n                        name TEXT NOT NULL,\r\n                        lastname TEXT,\r\n                        age INTEGER,\r\n                        cedula TEXT UNIQUE,\r\n                        birth_date TEXT,\r\n                        crime TEXT,\r\n                        case_number TEXT,\r\n                        embedding BLOB NOT NULL,\r\n                        image_path TEXT NOT NULL,\r\n                        created_at REAL NOT NULL,\r\n                        created_by INTEGER,\r\n                        FOREIGN KEY (created_by) REFERENCES users(id)\r\n                    )\r\n                ''')\r\n                \r\n                # Create audit_log table\r\n                cursor.execute('''\r\n                    CREATE TABLE IF NOT EXISTS audit_log (\r\n                        id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n                        timestamp REAL NOT NULL,\r\n                        user_id INTEGER NOT NULL,\r\n                        action TEXT NOT NULL,\r\n                        details TEXT,\r\n                        FOREIGN KEY (user_id) REFERENCES users(id)\r\n                    )\r\n                ''')\r\n                \r\n                # ====== MIGRATION SECTION ======\r\n                # Check and add missing columns to known_faces\r\n                cursor.execute(\"PRAGMA table_info(known_faces)\")\r\n                columns = [row[1] for row in cursor.fetchall()]\r\n                \r\n                required_columns = {\r\n                    'lastname': 'TEXT',\r\n                    'age': 'INTEGER',\r\n                    'cedula': 'TEXT',\r\n                    'birth_date': 'TEXT',\r\n                    'crime': 'TEXT',\r\n                    'case_number': 'TEXT'\r\n                }\r\n                \r\n                for col_name, col_type in required_columns.items():\r\n                    if col_name not in columns:\r\n                        logger.warning(f\"Migrating known_faces table: adding {col_name} column\")\r\n                        try:\r\n                            cursor.execute(f'ALTER TABLE known_faces ADD COLUMN {col_name} {col_type}')\r\n                            logger.info(f\"âœ… Column {col_name} added successfully\")\r\n                        except sqlite3.OperationalError as e:\r\n                            logger.error(f\"Migration failed for {col_name}: {e}\")\r\n                \r\n                # Ensure cedula has values (migrate existing records)\r\n                cursor.execute(\"SELECT COUNT(*) FROM known_faces WHERE cedula IS NULL OR cedula = ''\")\r\n                result = cursor.fetchone()\r\n                null_count = result[0] if result else 0\r\n                \r\n                if null_count > 0:\r\n                    logger.warning(f\"Populating {null_count} records with default cedula values\")\r\n                    cursor.execute('''\r\n                        UPDATE known_faces \r\n                        SET cedula = 'UNKNOWN_' || id\r\n                        WHERE cedula IS NULL OR cedula = ''\r\n                    ''')\r\n                    logger.info(f\"âœ… Updated {null_count} records\")\r\n                \r\n                # Create indexes for better performance\r\n                cursor.execute('''\r\n                    CREATE INDEX IF NOT EXISTS idx_face_logs_timestamp \r\n                    ON face_logs(timestamp)\r\n                ''')\r\n                cursor.execute('''\r\n                    CREATE INDEX IF NOT EXISTS idx_face_logs_camera_id \r\n                    ON face_logs(camera_id)\r\n                ''')\r\n                cursor.execute('''\r\n                    CREATE INDEX IF NOT EXISTS idx_face_logs_face_name \r\n                    ON face_logs(face_name)\r\n                ''')\r\n                cursor.execute('''\r\n                    CREATE INDEX IF NOT EXISTS idx_face_logs_user_id \r\n                    ON face_logs(user_id)\r\n                ''')\r\n                cursor.execute('''\r\n                    CREATE INDEX IF NOT EXISTS idx_known_faces_cedula \r\n                    ON known_faces(cedula)\r\n                ''')\r\n                cursor.execute('''\r\n                    CREATE INDEX IF NOT EXISTS idx_known_faces_case_number \r\n                    ON known_faces(case_number)\r\n                ''')\r\n                \r\n                # Check if user_id column exists in face_logs (MIGRATION)\r\n                cursor.execute(\"PRAGMA table_info(face_logs)\")\r\n                face_logs_columns = [row[1] for row in cursor.fetchall()]\r\n                \r\n                if 'user_id' not in face_logs_columns:\r\n                    logger.warning(\"Migrating face_logs table: adding user_id column\")\r\n                    try:\r\n                        cursor.execute('''\r\n                            ALTER TABLE face_logs \r\n                            ADD COLUMN user_id INTEGER REFERENCES users(id)\r\n                        ''')\r\n                        logger.info(\"âœ… Column user_id added to face_logs\")\r\n                    except sqlite3.OperationalError as e:\r\n                        logger.error(f\"Migration failed: {e}\")\r\n                \r\n                # Create default admin user if no users exist\r\n                cursor.execute('SELECT COUNT(*) FROM users')\r\n                if cursor.fetchone()[0] == 0:\r\n                    import bcrypt\r\n                    import secrets\r\n                    import string\r\n                    \r\n                    random_password = ''.join(secrets.choice(string.ascii_letters + string.digits) for _ in range(16))\r\n                    \r\n                    salt = bcrypt.gensalt()\r\n                    hashed = bcrypt.hashpw(random_password.encode('utf-8'), salt)\r\n                    \r\n                    cursor.execute('''\r\n                        INSERT INTO users (username, email, password_hash, role, created_at)\r\n                        VALUES (?, ?, ?, ?, ?)\r\n                    ''', ('admin', 'admin@system.local', hashed.decode('utf-8'), 'admin', time.time()))\r\n                    \r\n                    logger.warning(\"=\" * 60)\r\n                    logger.warning(\"DEFAULT ADMIN USER CREATED\")\r\n                    logger.warning(f\"Username: admin\")\r\n                    logger.warning(f\"Password: {random_password}\")\r\n                    logger.warning(\"SAVE THIS PASSWORD - IT WILL NOT BE SHOWN AGAIN!\")\r\n                    logger.warning(\"=\" * 60)\r\n                    \r\n                    credentials_file = self.db_path.parent / \"ADMIN_CREDENTIALS.txt\"\r\n                    with open(credentials_file, 'w') as f:\r\n                        f.write(f\"Admin Credentials (Created: {time.strftime('%Y-%m-%d %H:%M:%S')})\\n\")\r\n                        f.write(f\"Username: admin\\n\")\r\n                        f.write(f\"Password: {random_password}\\n\")\r\n                        f.write(\"\\nDELETE THIS FILE AFTER FIRST LOGIN AND PASSWORD CHANGE!\\n\")\r\n                    logger.info(f\"Credentials saved to: {credentials_file}\")\r\n                \r\n                conn.commit()\r\n                logger.success(\"Database initialized successfully\")\r\n                \r\n        except Exception as e:\r\n            logger.error(f\"Error initializing database: {e}\")\r\n            raise\r\n\r\n    # ============ USER MANAGEMENT ============\r\n    \r\n    def create_user(self, username: str, email: str, password_hash: str, \r\n                   role: str = 'viewer', created_by: Optional[int] = None) -> Optional[int]:\r\n        \"\"\"Create a new user\"\"\"\r\n        try:\r\n            with sqlite3.connect(self.db_path) as conn:\r\n                cursor = conn.cursor()\r\n                cursor.execute('''\r\n                    INSERT INTO users (username, email, password_hash, role, created_at, created_by)\r\n                    VALUES (?, ?, ?, ?, ?, ?)\r\n                ''', (username, email, password_hash, role, time.time(), created_by))\r\n                conn.commit()\r\n                user_id = cursor.lastrowid\r\n                \r\n                # Log audit\r\n                if created_by:\r\n                    self.log_audit(created_by, 'create_user', f\"Created user: {username}\")\r\n                \r\n                return user_id\r\n        except sqlite3.IntegrityError as e:\r\n            logger.error(f\"User already exists: {e}\")\r\n            return None\r\n        except Exception as e:\r\n            logger.error(f\"Error creating user: {e}\")\r\n            return None\r\n    \r\n    def get_user_by_username(self, username: str) -> Optional[Dict]:\r\n        \"\"\"Get user by username\"\"\"\r\n        try:\r\n            with sqlite3.connect(self.db_path) as conn:\r\n                conn.row_factory = sqlite3.Row\r\n                cursor = conn.cursor()\r\n                cursor.execute('''\r\n                    SELECT * FROM users WHERE username = ?\r\n                ''', (username,))\r\n                row = cursor.fetchone()\r\n                return dict(row) if row else None\r\n        except Exception as e:\r\n            logger.error(f\"Error getting user: {e}\")\r\n            return None\r\n    \r\n    def get_user_by_id(self, user_id: int) -> Optional[Dict]:\r\n        \"\"\"Get user by ID\"\"\"\r\n        try:\r\n            with sqlite3.connect(self.db_path) as conn:\r\n                conn.row_factory = sqlite3.Row\r\n                cursor = conn.cursor()\r\n                cursor.execute('''\r\n                    SELECT * FROM users WHERE id = ?\r\n                ''', (user_id,))\r\n                row = cursor.fetchone()\r\n                return dict(row) if row else None\r\n        except Exception as e:\r\n            logger.error(f\"Error getting user: {e}\")\r\n            return None\r\n    \r\n    def get_all_users(self) -> List[Dict]:\r\n        \"\"\"Get all users\"\"\"\r\n        try:\r\n            with sqlite3.connect(self.db_path) as conn:\r\n                conn.row_factory = sqlite3.Row\r\n                cursor = conn.cursor()\r\n                cursor.execute('''\r\n                    SELECT id, username, email, role, is_active, created_at, last_login\r\n                    FROM users\r\n                    ORDER BY username\r\n                ''')\r\n                return [dict(row) for row in cursor.fetchall()]\r\n        except Exception as e:\r\n            logger.error(f\"Error getting users: {e}\")\r\n            return []\r\n    \r\n    def update_user(self, user_id: int, **kwargs) -> bool:\r\n        \"\"\"Update user fields\"\"\"\r\n        try:\r\n            allowed_fields = ['email', 'role', 'is_active']\r\n            updates = {k: v for k, v in kwargs.items() if k in allowed_fields}\r\n            \r\n            if not updates:\r\n                return False\r\n            \r\n            set_clause = ', '.join([f\"{k} = ?\" for k in updates.keys()])\r\n            values = list(updates.values()) + [user_id]\r\n            \r\n            with sqlite3.connect(self.db_path) as conn:\r\n                cursor = conn.cursor()\r\n                cursor.execute(f'''\r\n                    UPDATE users SET {set_clause} WHERE id = ?\r\n                ''', values)\r\n                conn.commit()\r\n                return cursor.rowcount > 0\r\n        except Exception as e:\r\n            logger.error(f\"Error updating user: {e}\")\r\n            return False\r\n    \r\n    def update_user_password(self, user_id: int, password_hash: str) -> bool:\r\n        \"\"\"Update user password\"\"\"\r\n        try:\r\n            with sqlite3.connect(self.db_path) as conn:\r\n                cursor = conn.cursor()\r\n                cursor.execute('''\r\n                    UPDATE users SET password_hash = ? WHERE id = ?\r\n                ''', (password_hash, user_id))\r\n                conn.commit()\r\n                return cursor.rowcount > 0\r\n        except Exception as e:\r\n            logger.error(f\"Error updating password: {e}\")\r\n            return False\r\n    \r\n    def update_last_login(self, user_id: int) -> bool:\r\n        \"\"\"Update last login timestamp\"\"\"\r\n        try:\r\n            with sqlite3.connect(self.db_path) as conn:\r\n                cursor = conn.cursor()\r\n                cursor.execute('''\r\n                    UPDATE users SET last_login = ? WHERE id = ?\r\n                ''', (time.time(), user_id))\r\n                conn.commit()\r\n                return True\r\n        except Exception as e:\r\n            logger.error(f\"Error updating last login: {e}\")\r\n            return False\r\n    \r\n    def delete_user(self, user_id: int) -> bool:\r\n        \"\"\"Delete user (soft delete - sets is_active to False)\"\"\"\r\n        try:\r\n            with sqlite3.connect(self.db_path) as conn:\r\n                cursor = conn.cursor()\r\n                cursor.execute('''\r\n                    UPDATE users SET is_active = 0 WHERE id = ?\r\n                ''', (user_id,))\r\n                conn.commit()\r\n                return cursor.rowcount > 0\r\n        except Exception as e:\r\n            logger.error(f\"Error deleting user: {e}\")\r\n            return False\r\n    \r\n    # ============ AUDIT LOG ============\r\n    \r\n    def log_audit(self, user_id: int, action: str, details: Optional[str] = None):\r\n        \"\"\"Log user action for audit trail\"\"\"\r\n        try:\r\n            with sqlite3.connect(self.db_path) as conn:\r\n                cursor = conn.cursor()\r\n                cursor.execute('''\r\n                    INSERT INTO audit_log (timestamp, user_id, action, details)\r\n                    VALUES (?, ?, ?, ?)\r\n                ''', (time.time(), user_id, action, details))\r\n                conn.commit()\r\n        except Exception as e:\r\n            logger.error(f\"Error logging audit: {e}\")\r\n    \r\n    def get_audit_logs(self, user_id: Optional[int] = None, limit: int = 100) -> List[Dict]:\r\n        \"\"\"Get audit logs\"\"\"\r\n        try:\r\n            with sqlite3.connect(self.db_path) as conn:\r\n                conn.row_factory = sqlite3.Row\r\n                cursor = conn.cursor()\r\n                \r\n                if user_id:\r\n                    cursor.execute('''\r\n                        SELECT a.*, u.username \r\n                        FROM audit_log a\r\n                        JOIN users u ON a.user_id = u.id\r\n                        WHERE a.user_id = ?\r\n                        ORDER BY a.timestamp DESC\r\n                        LIMIT ?\r\n                    ''', (user_id, limit))\r\n                else:\r\n                    cursor.execute('''\r\n                        SELECT a.*, u.username \r\n                        FROM audit_log a\r\n                        JOIN users u ON a.user_id = u.id\r\n                        ORDER BY a.timestamp DESC\r\n                        LIMIT ?\r\n                    ''', (limit,))\r\n                \r\n                return [dict(row) for row in cursor.fetchall()]\r\n        except Exception as e:\r\n            logger.error(f\"Error getting audit logs: {e}\")\r\n            return []\r\n\r\n    # ============ FACE LOGS ============\r\n    \r\n    def log_face_event(self, event, user_id: Optional[int] = None) -> int:\r\n        \"\"\"Log a face recognition event\"\"\"\r\n        try:\r\n            with sqlite3.connect(self.db_path) as conn:\r\n                cursor = conn.cursor()\r\n                cursor.execute('''\r\n                    INSERT INTO face_logs (\r\n                        timestamp, camera_id, camera_name, face_name,\r\n                        age, gender, confidence, screenshot_path, user_id\r\n                    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n                ''', (\r\n                    float(event.timestamp),\r\n                    int(event.camera_id),\r\n                    str(event.camera_name),\r\n                    str(event.face_name),\r\n                    int(event.age) if event.age else None,\r\n                    str(event.gender) if event.gender else None,\r\n                    float(event.confidence),\r\n                    str(event.screenshot_path) if event.screenshot_path else None,\r\n                    user_id\r\n                ))\r\n                conn.commit()\r\n                return cursor.lastrowid\r\n        except Exception as e:\r\n            logger.error(f\"Error logging face event: {e}\")\r\n            raise\r\n\r\n    def get_face_logs(self, limit: int = 100, \r\n                 camera_id: Optional[int] = None,\r\n                 face_name: Optional[str] = None,\r\n                 start_time: Optional[float] = None,\r\n                 end_time: Optional[float] = None) -> List[FaceLogEntry]:\r\n        \"\"\"Retrieve face logs with optional filters\"\"\"\r\n        try:\r\n            query = '''\r\n                SELECT id, timestamp, camera_id, camera_name, face_name, \r\n                       age, gender, confidence, screenshot_path, user_id\r\n                FROM face_logs\r\n            '''\r\n            params = []\r\n            conditions = []\r\n            \r\n            if camera_id is not None:\r\n                conditions.append(\"camera_id = ?\")\r\n                params.append(camera_id)\r\n                \r\n            if face_name is not None:\r\n                conditions.append(\"face_name = ?\")\r\n                params.append(face_name)\r\n                \r\n            if start_time is not None:\r\n                conditions.append(\"timestamp >= ?\")\r\n                params.append(float(start_time))\r\n                \r\n            if end_time is not None:\r\n                conditions.append(\"timestamp <= ?\")\r\n                params.append(float(end_time))\r\n                \r\n            if conditions:\r\n                query += \" WHERE \" + \" AND \".join(conditions)\r\n                \r\n            query += \" ORDER BY timestamp DESC LIMIT ?\"\r\n            params.append(limit)\r\n            \r\n            with sqlite3.connect(self.db_path) as conn:\r\n                conn.row_factory = sqlite3.Row\r\n                cursor = conn.cursor()\r\n                cursor.execute(query, params)\r\n                \r\n                entries = []\r\n                for row in cursor.fetchall():\r\n                    try:\r\n                        entries.append(FaceLogEntry(\r\n                            id=row['id'],\r\n                            timestamp=float(row['timestamp']),\r\n                            camera_id=row['camera_id'],\r\n                            camera_name=row['camera_name'],\r\n                            face_name=row['face_name'],\r\n                            age=row['age'],\r\n                            gender=row['gender'],\r\n                            confidence=float(row['confidence']),\r\n                            screenshot_path=row['screenshot_path'],\r\n                            user_id=row['user_id']\r\n                        ))\r\n                    except Exception as e:\r\n                        logger.error(f\"Error converting row {dict(row)}: {e}\")\r\n                        continue\r\n                        \r\n                return entries\r\n                \r\n        except Exception as e:\r\n            logger.error(f\"Error retrieving face logs: {e}\")\r\n            return []\r\n\r\n    # ============ KNOWN FACES ============\r\n    \r\n    def add_known_face(self, name: str, lastname: str, age: int, cedula: str,\r\n                      birth_date: str, crime: str, case_number: str,\r\n                      embedding: bytes, image_path: str, \r\n                      created_by: Optional[int] = None) -> bool:\r\n        \"\"\"Add a known face to the database\"\"\"\r\n        try:\r\n            with sqlite3.connect(self.db_path) as conn:\r\n                cursor = conn.cursor()\r\n                cursor.execute('''\r\n                    INSERT INTO known_faces (name, lastname, age, cedula, birth_date, \r\n                                            crime, case_number, embedding, image_path, \r\n                                            created_at, created_by)\r\n                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n                ''', (name, lastname, age, cedula, birth_date, crime, case_number,\r\n                      embedding, image_path, time.time(), created_by))\r\n                conn.commit()\r\n                \r\n                if created_by:\r\n                    self.log_audit(created_by, 'add_face', \r\n                                 f\"Added face: {name} {lastname} - Cedula: {cedula}\")\r\n                \r\n                return True\r\n        except sqlite3.IntegrityError:\r\n            logger.warning(f\"Face with cedula '{cedula}' already exists\")\r\n            return False\r\n        except Exception as e:\r\n            logger.error(f\"Error adding known face: {e}\")\r\n            return False\r\n\r\n    def get_known_faces(self) -> List[dict]:\r\n        \"\"\"Retrieve all known faces from the database\"\"\"\r\n        try:\r\n            with sqlite3.connect(self.db_path) as conn:\r\n                conn.row_factory = sqlite3.Row\r\n                cursor = conn.cursor()\r\n                cursor.execute('''\r\n                    SELECT id, name, lastname, age, cedula, birth_date, crime, \r\n                           case_number, embedding, image_path \r\n                    FROM known_faces\r\n                ''')\r\n                return [dict(row) for row in cursor.fetchall()]\r\n        except Exception as e:\r\n            logger.error(f\"Error retrieving known faces: {e}\")\r\n            return []\r\n\r\n    def delete_known_face(self, cedula: str, deleted_by: Optional[int] = None) -> bool:\r\n        \"\"\"Delete a known face from the database\"\"\"\r\n        try:\r\n            with sqlite3.connect(self.db_path) as conn:\r\n                cursor = conn.cursor()\r\n                cursor.execute('''\r\n                    DELETE FROM known_faces WHERE cedula = ?\r\n                ''', (cedula,))\r\n                conn.commit()\r\n                \r\n                if deleted_by and cursor.rowcount > 0:\r\n                    self.log_audit(deleted_by, 'delete_face', f\"Deleted face: {cedula}\")\r\n                \r\n                return cursor.rowcount > 0\r\n        except Exception as e:\r\n            logger.error(f\"Error deleting known face: {e}\")\r\n            return False",
    "face_detection.py": "import os\r\nimport cv2\r\nimport numpy as np\r\nimport insightface\r\nfrom insightface.app import FaceAnalysis\r\nfrom insightface.data import get_image as ins_get_image\r\nfrom loguru import logger\r\nfrom typing import List, Dict, Tuple, Optional\r\nfrom dataclasses import dataclass\r\nfrom PIL import Image\r\nfrom pathlib import Path\r\nimport time\r\n\r\n@dataclass\r\nclass Face:\r\n    bbox: np.ndarray  # [x1, y1, x2, y2]\r\n    kps: np.ndarray   # 5 key points\r\n    det_score: float  # detection score\r\n    embedding: np.ndarray\r\n    age: Optional[int] = None\r\n    gender: Optional[str] = None  # 'Male' or 'Female'\r\n    face_img: Optional[np.ndarray] = None\r\n\r\n@dataclass\r\nclass KnownFace:\r\n    name: str\r\n    lastname: str\r\n    age: int\r\n    cedula: str\r\n    birth_date: str\r\n    crime: str\r\n    case_number: str\r\n    embedding: np.ndarray\r\n    image_path: str\r\n\r\nclass FaceDetector:\r\n    def __init__(self, config: dict):\r\n        self.config = config\r\n        self.recognition_threshold = config['recognition']['recognition_threshold']\r\n        self.detection_threshold = config['recognition']['detection_threshold']\r\n        self.max_batch_size = config['recognition']['max_batch_size']\r\n        self.device = config['recognition']['device']\r\n        self.analysis_enabled = config['recognition'].get('analysis_enabled', True)\r\n        self.model = self._load_model()\r\n        self.known_faces: List[KnownFace] = []\r\n        \r\n    def _load_model(self) -> FaceAnalysis:\r\n        \"\"\"Load Model insightface\"\"\"\r\n        try:\r\n            model = FaceAnalysis(\r\n                name='buffalo_l',\r\n                root='./models',\r\n                allowed_modules=['detection', 'recognition', 'genderage']\r\n            )\r\n            model.prepare(\r\n                ctx_id=0 if self.device == 'cuda' else -1,\r\n                det_thresh=self.detection_threshold,\r\n                det_size=(640, 640)\r\n            )\r\n            logger.success(\"Face detection model loaded successfully\")\r\n            return model\r\n        except Exception as e:\r\n            logger.error(f\"Failed to load face detection model: {e}\")\r\n            raise\r\n\r\n    def load_known_faces(self, known_faces_dir: str) -> None:\r\n        \"\"\"Load known faces from directory (backward compatibility)\"\"\"\r\n        try:\r\n            self.known_faces.clear()\r\n            known_faces_dir = Path(known_faces_dir)\r\n            \r\n            if not known_faces_dir.exists():\r\n                logger.warning(f\"Known faces directory {known_faces_dir} does not exist\")\r\n                return\r\n                \r\n            for face_file in known_faces_dir.glob('*.*'):\r\n                if face_file.suffix.lower() not in ['.jpg', '.jpeg', '.png']:\r\n                    continue\r\n                    \r\n                try:\r\n                    img = cv2.imread(str(face_file))\r\n                    if img is None:\r\n                        logger.warning(f\"Could not read image {face_file}\")\r\n                        continue\r\n                        \r\n                    faces = self.model.get(img)\r\n                    if len(faces) == 0:\r\n                        logger.warning(f\"No faces found in {face_file}\")\r\n                        continue\r\n                        \r\n                    face = faces[0]\r\n                    name = face_file.stem\r\n                    \r\n                    # Parse filename to extract information\r\n                    # Format: cedula_timestamp.jpg\r\n                    parts = name.rsplit('_', 1)\r\n                    cedula = parts[0] if len(parts) > 1 else name\r\n                    \r\n                    self.known_faces.append(KnownFace(\r\n                        name=name,\r\n                        lastname=\"\",\r\n                        age=0,\r\n                        cedula=cedula,\r\n                        birth_date=\"\",\r\n                        crime=\"\",\r\n                        case_number=\"\",\r\n                        embedding=face.embedding,\r\n                        image_path=str(face_file)\r\n                    ))\r\n                    logger.info(f\"Loaded known face: {name}\")\r\n                    \r\n                except Exception as e:\r\n                    logger.error(f\"Error processing {face_file}: {e}\")\r\n                    \r\n            logger.info(f\"Loaded {len(self.known_faces)} known faces\")\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error loading known faces: {e}\")\r\n            raise\r\n\r\n    def load_known_faces_from_db(self, database) -> None:\r\n        \"\"\"Load known faces from database\"\"\"\r\n        try:\r\n            self.known_faces.clear()\r\n            db_faces = database.get_known_faces()\r\n            \r\n            for face_data in db_faces:\r\n                try:\r\n                    embedding = np.frombuffer(face_data['embedding'], dtype=np.float32)\r\n                    \r\n                    self.known_faces.append(KnownFace(\r\n                        name=face_data['name'],\r\n                        lastname=face_data['lastname'],\r\n                        age=face_data['age'],\r\n                        cedula=face_data['cedula'],\r\n                        birth_date=face_data['birth_date'],\r\n                        crime=face_data['crime'],\r\n                        case_number=face_data['case_number'],\r\n                        embedding=embedding,\r\n                        image_path=face_data['image_path']\r\n                    ))\r\n                except Exception as e:\r\n                    logger.error(f\"Error processing face data: {e}\")\r\n                    continue\r\n            \r\n            logger.info(f\"Loaded {len(self.known_faces)} known faces from database\")\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error loading known faces from database: {e}\")\r\n\r\n    def detect_faces(self, image: np.ndarray) -> List[Face]:\r\n        \"\"\"Detect faces in an image\"\"\"\r\n        try:\r\n            faces = self.model.get(image)\r\n            results = []\r\n            \r\n            for face in faces:\r\n                face_img = self._extract_face_image(image, face.bbox)\r\n\r\n                results.append(Face(\r\n                    bbox=face.bbox,\r\n                    kps=face.kps,\r\n                    det_score=face.det_score,\r\n                    embedding=face.embedding,\r\n                    age=self._get_age(face),\r\n                    gender=self._get_gender(face),\r\n                    face_img=face_img\r\n                ))\r\n            return results\r\n        except Exception as e:\r\n            logger.error(f\"Error detecting faces: {e}\")\r\n            return []\r\n\r\n    def recognize_faces(self, faces: List[Face]) -> List[Tuple[Face, Optional[KnownFace], float]]:\r\n        \"\"\"Recognize faces against known faces database\"\"\"\r\n        results = []\r\n        \r\n        if not self.known_faces:\r\n            return [(face, None, 0.0) for face in faces]\r\n            \r\n        try:\r\n            known_embeddings = np.array([kf.embedding for kf in self.known_faces])\r\n            \r\n            for face in faces:\r\n                if face.embedding is None or len(face.embedding) == 0:\r\n                    results.append((face, None, 0.0))\r\n                    continue\r\n                    \r\n                similarities = np.dot(known_embeddings, face.embedding) / (\r\n                    np.linalg.norm(known_embeddings, axis=1) * np.linalg.norm(face.embedding)\r\n                )\r\n                \r\n                max_idx = np.argmax(similarities)\r\n                max_similarity = similarities[max_idx]\r\n                \r\n                if max_similarity > self.recognition_threshold:\r\n                    results.append((face, self.known_faces[max_idx], max_similarity))\r\n                else:\r\n                    results.append((face, None, max_similarity))\r\n                    \r\n        except Exception as e:\r\n            logger.error(f\"Error recognizing faces: {e}\")\r\n            return [(face, None, 0.0) for face in faces]\r\n            \r\n        return results\r\n\r\n    def _extract_face_image(self, image: np.ndarray, bbox: np.ndarray) -> np.ndarray:\r\n        \"\"\"Extract face region from image\"\"\"\r\n        x1, y1, x2, y2 = map(int, bbox)\r\n        x1 = max(0, x1)\r\n        y1 = max(0, y1)\r\n        x2 = min(image.shape[1], x2)\r\n        y2 = min(image.shape[0], y2)\r\n        \r\n        if x1 >= x2 or y1 >= y2:\r\n            return np.array([])\r\n            \r\n        return image[y1:y2, x1:x2].copy()\r\n\r\n    def add_known_face(self, image: np.ndarray, name: str, lastname: str,\r\n                      age: int, cedula: str, birth_date: str,\r\n                      crime: str, case_number: str,\r\n                      save_dir: str, database=None, created_by=None) -> bool:\r\n        \"\"\"Add a new known face to the database\"\"\"\r\n        try:\r\n            save_dir = Path(save_dir)\r\n            save_dir.mkdir(parents=True, exist_ok=True)\r\n            \r\n            faces = self.detect_faces(image)\r\n            if not faces:\r\n                logger.warning(\"No faces found in the provided image\")\r\n                return False\r\n                \r\n            face = faces[0]\r\n            timestamp = int(time.time())\r\n            face_path = save_dir / f\"{cedula}_{timestamp}.jpg\"\r\n            cv2.imwrite(str(face_path), image)\r\n            \r\n            # Save to database if provided\r\n            if database:\r\n                embedding_bytes = face.embedding.tobytes()\r\n                success = database.add_known_face(\r\n                    name, lastname, age, cedula, birth_date,\r\n                    crime, case_number, embedding_bytes,\r\n                    str(face_path), created_by\r\n                )\r\n                if not success:\r\n                    return False\r\n            \r\n            # Add to memory\r\n            self.known_faces.append(KnownFace(\r\n                name=name,\r\n                lastname=lastname,\r\n                age=age,\r\n                cedula=cedula,\r\n                birth_date=birth_date,\r\n                crime=crime,\r\n                case_number=case_number,\r\n                embedding=face.embedding,\r\n                image_path=str(face_path)\r\n            ))\r\n            \r\n            logger.info(f\"Added new known face: {name} {lastname} - Cedula: {cedula}\")\r\n            return True\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error adding known face: {e}\")\r\n            return False\r\n\r\n    def _get_age(self, face) -> Optional[int]:\r\n        \"\"\"Extract age estimation if available\"\"\"\r\n        if not self.analysis_enabled:\r\n            return None\r\n        return int(face.age) if hasattr(face, 'age') else None\r\n    \r\n    def _get_gender(self, face) -> Optional[str]:\r\n        \"\"\"Extract gender prediction if available\"\"\"\r\n        if not self.analysis_enabled:\r\n            return None\r\n        if not hasattr(face, 'sex') or face.sex is None:\r\n            return None\r\n        return 'Female' if np.argmax(face.sex) == 1 else 'Male'\r\n    ",
    "telegram_manager.py": "import logging\r\nfrom telegram import Bot\r\nfrom telegram.error import TelegramError\r\nfrom typing import Optional\r\nfrom pathlib import Path\r\nimport asyncio\r\nimport time\r\n\r\nclass TelegramManager:\r\n    def __init__(self, token: str, chat_id: str, rate_limit: int):\r\n        self.token = token\r\n        self.chat_id = chat_id\r\n        self.bot = None\r\n        self.last_sent = 0\r\n        self.min_interval = rate_limit\r\n        self.loop = asyncio.new_event_loop()\r\n\r\n    async def _initialize_bot(self):\r\n        \"\"\"Initialize the Telegram bot asynchronously\"\"\"\r\n        try:\r\n            self.bot = Bot(token=self.token)\r\n            await self.bot.get_me()  # Test connection\r\n            logging.info(\"Telegram bot initialized successfully\")\r\n        except TelegramError as e:\r\n            logging.error(f\"Failed to initialize Telegram bot: {e}\")\r\n            self.bot = None\r\n\r\n    def send_alert(self, message: str, image_path: Optional[Path] = None):\r\n        \"\"\"Send alert to Telegram (blocking wrapper)\"\"\"\r\n        if not self.bot:\r\n            try:\r\n                self.loop.run_until_complete(self._initialize_bot())\r\n            except Exception as e:\r\n                logging.error(f\"Telegram connection failed: {e}\")\r\n                return\r\n\r\n        async def _send():\r\n            now = time.time()\r\n            if now - self.last_sent < self.min_interval:\r\n                logging.warning(f\"Telegram rate limit reached ({self.min_interval}s)\")\r\n                return\r\n            try:\r\n                if image_path and image_path.exists():\r\n                    with open(image_path, 'rb') as photo:\r\n                        await self.bot.send_photo(\r\n                            chat_id=self.chat_id,\r\n                            photo=photo,\r\n                            caption=message\r\n                        )\r\n                else:\r\n                    await self.bot.send_message(\r\n                        chat_id=self.chat_id,\r\n                        text=message\r\n                    )\r\n                self.last_sent = now\r\n                logging.info(\"Telegram alert sent successfully\")\r\n            except TelegramError as e:\r\n                logging.error(f\"Failed to send Telegram alert: {e}\")\r\n\r\n        try:\r\n            self.loop.run_until_complete(_send())\r\n        except Exception as e:\r\n            logging.error(f\"Telegram alert failed: {str(e)}\")\r\n            # Fallback to saving alert locally\r\n            with open(\"failed_alerts.log\", \"a\") as f:\r\n                f.write(f\"{time.ctime()}: {message}\\n\")\r\n            if image_path:\r\n                backup_dir = Path(\"failed_alert_images\")\r\n                backup_dir.mkdir(exist_ok=True)\r\n                new_path = backup_dir / f\"alert_{int(time.time())}.jpg\"\r\n                try:\r\n                    image_path.rename(new_path)\r\n                except Exception as e:\r\n                    logging.error(f\"Failed to backup alert image: {e}\")\r\n    \r\n    def shutdown(self):\r\n        \"\"\"Cleanup resources\"\"\"\r\n        self._shutdown = True\r\n        self.last_sent = 0\r\n        if self.loop.is_running():\r\n            self.loop.stop()\r\n        \r\n        # Close all pending tasks\r\n        pending = asyncio.all_tasks(loop=self.loop)\r\n        for task in pending:\r\n            task.cancel()\r\n        \r\n        self.loop.close()",
    "user_manager.py": "",
    "utils.py": "import cv2\r\nimport numpy as np\r\nfrom typing import Tuple, Optional\r\nfrom loguru import logger\r\nimport time\r\nfrom PyQt5.QtGui import QPixmap\r\n\r\ndef draw_face_info(image: np.ndarray, \r\n                  face_bbox: Tuple[int, int, int, int],\r\n                  name: Optional[str] = None,\r\n                  confidence: Optional[float] = None,\r\n                  age: Optional[int] = None,\r\n                  gender: Optional[str] = None,\r\n                  camera_name: Optional[str] = None,\r\n                  timestamp: Optional[float] = None) -> np.ndarray:\r\n    \"\"\"\r\n    Draw face bounding box and information on the image\r\n    \"\"\"\r\n    try:\r\n        img = image.copy()\r\n        x1, y1, x2, y2 = map(int, face_bbox)\r\n        \r\n        # Draw bounding box\r\n        color = (0, 255, 0) if name else (0, 0, 255)\r\n        cv2.rectangle(img, (x1, y1), (x2, y2), color, 2)\r\n        \r\n        # Create info text\r\n        info_text = []\r\n        if name:\r\n            info_text.append(f\"Name: {name}\")\r\n        if confidence is not None:\r\n            info_text.append(f\"Confidence: {confidence:.2f}\")\r\n        if age:\r\n            info_text.append(f\"Age: {age}\")\r\n        if gender:\r\n            info_text.append(f\"Gender: {gender}\")\r\n        if camera_name:\r\n            info_text.append(f\"Camera: {camera_name}\")\r\n        if timestamp:\r\n            time_str = time.strftime(\"%Y-%m-%d %H:%M:%S\", time.localtime(timestamp))\r\n            info_text.append(f\"Time: {time_str}\")\r\n        \r\n        # Draw text background\r\n        text_y = y1 - 10 if y1 - 10 > 10 else y2 + 20\r\n        for i, text in enumerate(info_text):\r\n            text_size = cv2.getTextSize(text, cv2.FONT_HERSHEY_SIMPLEX, 0.5, 1)[0]\r\n            cv2.rectangle(img, \r\n                         (x1, text_y - 15 - i * 20),\r\n                         (x1 + text_size[0] + 5, text_y - i * 20),\r\n                         color, -1)\r\n            \r\n            # Draw text\r\n            cv2.putText(img, text, \r\n                       (x1 + 3, text_y - 5 - i * 20),\r\n                       cv2.FONT_HERSHEY_SIMPLEX, 0.5, \r\n                       (0, 0, 0), 1)\r\n                       \r\n        return img\r\n        \r\n    except Exception as e:\r\n        logger.error(f\"Error drawing face info: {e}\")\r\n        return image\r\n\r\ndef numpy_to_pixmap(image: np.ndarray) -> 'QPixmap':\r\n    \"\"\"Convert numpy array to QPixmap\"\"\"\r\n    try:\r\n        from PyQt5.QtGui import QImage, QPixmap\r\n        from PyQt5.QtCore import Qt\r\n        \r\n        if image is None:\r\n            return QPixmap()\r\n            \r\n        if len(image.shape) == 2:  # Grayscale\r\n            h, w = image.shape\r\n            qimg = QImage(image.data, w, h, w, QImage.Format_Grayscale8)\r\n        else:  # BGR\r\n            h, w, ch = image.shape\r\n            bytes_per_line = ch * w\r\n            qimg = QImage(image.data, w, h, bytes_per_line, QImage.Format_BGR888)\r\n            \r\n        return QPixmap.fromImage(qimg).scaled(\r\n            w, h, Qt.KeepAspectRatio, Qt.SmoothTransformation)\r\n            \r\n    except Exception as e:\r\n        logger.error(f\"Error converting numpy to QPixmap: {e}\")\r\n        return QPixmap()\r\n\r\ndef resize_image(image: np.ndarray, max_width: int = 800, max_height: int = 600) -> np.ndarray:\r\n    \"\"\"Resize image while maintaining aspect ratio\"\"\"\r\n    try:\r\n        if image is None:\r\n            return None\r\n            \r\n        h, w = image.shape[:2]\r\n        \r\n        if w <= max_width and h <= max_height:\r\n            return image\r\n            \r\n        ratio = min(max_width / w, max_height / h)\r\n        new_w = int(w * ratio)\r\n        new_h = int(h * ratio)\r\n        \r\n        return cv2.resize(image, (new_w, new_h), interpolation=cv2.INTER_AREA)\r\n        \r\n    except Exception as e:\r\n        logger.error(f\"Error resizing image: {e}\")\r\n        return image"
  },
  "data": {
    "database_backup_20251121_135214.db": "(binary)",
    "database.db": "(binary)",
    "known_faces": {
      "24450026_1763746231.jpg": "(binary)",
      "28450026_1763747916.jpg": "(binary)"
    },
    "screenshots": {
      "20251007_185244_cam0_chris 'el puto'.jpg": "(binary)",
      "20251007_185256_cam0_chris 'el puto'.jpg": "(binary)",
      "20251007_185302_cam0_chris 'el puto'.jpg": "(binary)",
      "20251007_185335_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_161904_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_161923_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_161935_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_161941_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_161945_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_161954_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_161958_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162001_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162015_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162018_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162027_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162036_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162045_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162056_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162100_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162104_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162108_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162116_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162119_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162122_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162902_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162914_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162927_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162932_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162936_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162941_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162946_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162950_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_162956_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163002_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163019_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163023_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163027_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163035_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163041_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163045_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163050_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163054_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163059_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163104_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163109_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163118_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163123_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163129_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163134_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163141_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163147_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163153_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163158_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163204_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163212_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163217_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163222_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163227_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163232_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163237_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163300_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163307_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_163313_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_175344_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_175400_cam0_chris 'el puto'.jpg": "(binary)",
      "20251117_175404_cam0_chris 'el puto'.jpg": "(binary)",
      "20251119_142650_cam0_chris 'el puto'.jpg": "(binary)",
      "20251119_142706_cam0_chris 'el puto'.jpg": "(binary)",
      "20251119_142712_cam0_chris 'el puto'.jpg": "(binary)",
      "20251119_142719_cam0_chris 'el puto'.jpg": "(binary)",
      "20251119_142725_cam0_chris 'el puto'.jpg": "(binary)",
      "20251119_142731_cam0_chris 'el puto'.jpg": "(binary)",
      "20251119_142752_cam0_chris 'el puto'.jpg": "(binary)",
      "20251119_150107_cam0_chris 'el puto'.jpg": "(binary)",
      "20251119_150303_cam0_chris 'el puto'.jpg": "(binary)",
      "20251121_131005_cam0_28450026_1763586336.jpg": "(binary)",
      "20251121_133449_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_135841_cam0_christian.jpg": "(binary)",
      "20251121_135905_cam0_christian.jpg": "(binary)",
      "20251121_135911_cam0_christian.jpg": "(binary)",
      "20251121_135915_cam0_christian.jpg": "(binary)",
      "20251121_135918_cam0_christian.jpg": "(binary)",
      "20251121_135929_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_135933_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_135937_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_135942_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_135950_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_135955_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140001_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140007_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140011_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140035_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140105_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140109_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140118_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140134_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140150_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140154_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140203_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140208_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140223_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140232_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140236_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140251_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140259_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140305_cam0_24450026_1763746231.jpg": "(binary)",
      "20251121_140550_cam0_christian.jpg": "(binary)",
      "20251121_140557_cam0_christian.jpg": "(binary)",
      "20251121_140601_cam0_christian.jpg": "(binary)",
      "20251121_140606_cam0_christian.jpg": "(binary)",
      "20251121_140619_cam0_christian.jpg": "(binary)",
      "20251121_140623_cam0_christian.jpg": "(binary)",
      "20251121_140627_cam0_christian.jpg": "(binary)",
      "20251121_140631_cam0_christian.jpg": "(binary)",
      "20251121_140637_cam0_christian.jpg": "(binary)",
      "20251121_140707_cam0_christian.jpg": "(binary)",
      "20251121_140711_cam0_christian.jpg": "(binary)",
      "20251121_140715_cam0_christian.jpg": "(binary)",
      "20251121_140730_cam0_christian.jpg": "(binary)",
      "20251121_140738_cam0_christian.jpg": "(binary)",
      "20251121_140743_cam0_christian.jpg": "(binary)",
      "20251121_140749_cam0_christian.jpg": "(binary)",
      "20251121_140841_cam0_christian.jpg": "(binary)",
      "20251121_140849_cam0_christian.jpg": "(binary)",
      "20251121_140901_cam0_christian.jpg": "(binary)",
      "20251121_140908_cam0_christian.jpg": "(binary)",
      "20251121_140935_cam0_christian.jpg": "(binary)",
      "20251121_141001_cam0_christian.jpg": "(binary)",
      "20251121_141005_cam0_christian.jpg": "(binary)",
      "20251121_141009_cam0_christian.jpg": "(binary)",
      "20251121_141038_cam0_christian.jpg": "(binary)",
      "20251121_141046_cam0_christian.jpg": "(binary)",
      "20251121_141054_cam0_christian.jpg": "(binary)",
      "20251121_141100_cam0_christian.jpg": "(binary)",
      "20251121_141112_cam0_christian.jpg": "(binary)",
      "20251121_141124_cam0_christian.jpg": "(binary)",
      "20251121_141155_cam0_christian.jpg": "(binary)",
      "20251121_141207_cam0_christian.jpg": "(binary)",
      "20251121_141210_cam0_christian.jpg": "(binary)",
      "20251121_141219_cam0_christian.jpg": "(binary)",
      "20251121_141225_cam0_christian.jpg": "(binary)",
      "20251121_141231_cam0_christian.jpg": "(binary)",
      "20251121_141237_cam0_christian.jpg": "(binary)",
      "20251121_141248_cam0_christian.jpg": "(binary)",
      "20251121_141255_cam0_christian.jpg": "(binary)",
      "20251121_141259_cam0_christian.jpg": "(binary)",
      "20251121_141309_cam0_christian.jpg": "(binary)",
      "20251121_141318_cam0_christian.jpg": "(binary)"
    }
  },
  "fix_database.py": "\"\"\"\r\nScript de MigraciÃ³n Completa para Solucionar el Error de created_by\r\nEjecuta esto para agregar la columna faltante a la base de datos\r\n\"\"\"\r\n\r\nimport sqlite3\r\nfrom pathlib import Path\r\nfrom datetime import datetime\r\nimport shutil\r\n\r\ndef backup_database(db_path):\r\n    \"\"\"Crear backup de seguridad antes de la migraciÃ³n\"\"\"\r\n    print(\"\\nðŸ“¦ Creando backup de seguridad...\")\r\n    \r\n    if not db_path.exists():\r\n        print(\"   âš ï¸ Base de datos no existe, no se requiere backup\")\r\n        return None\r\n    \r\n    try:\r\n        timestamp = datetime.now().strftime(\"%Y%m%d_%H%M%S\")\r\n        backup_path = db_path.parent / f\"database_backup_{timestamp}.db\"\r\n        shutil.copy2(db_path, backup_path)\r\n        print(f\"   âœ… Backup creado: {backup_path}\")\r\n        return backup_path\r\n    except Exception as e:\r\n        print(f\"   âŒ Error al crear backup: {e}\")\r\n        return None\r\n\r\ndef check_column_exists(cursor, table_name, column_name):\r\n    \"\"\"Verificar si una columna existe en una tabla\"\"\"\r\n    cursor.execute(f\"PRAGMA table_info({table_name})\")\r\n    columns = [row[1] for row in cursor.fetchall()]\r\n    return column_name in columns\r\n\r\ndef migrate_known_faces_table(db_path):\r\n    \"\"\"Migrar tabla known_faces agregando columna created_by\"\"\"\r\n    print(\"\\nðŸ”§ Migrando tabla known_faces...\")\r\n    \r\n    try:\r\n        conn = sqlite3.connect(db_path)\r\n        cursor = conn.cursor()\r\n        \r\n        # Verificar si la tabla existe\r\n        cursor.execute(\"SELECT name FROM sqlite_master WHERE type='table' AND name='known_faces'\")\r\n        if not cursor.fetchone():\r\n            print(\"   âš ï¸ Tabla known_faces no existe, creando desde cero...\")\r\n            create_known_faces_table(cursor)\r\n            conn.commit()\r\n            conn.close()\r\n            return True\r\n        \r\n        # Verificar columnas existentes\r\n        cursor.execute(\"PRAGMA table_info(known_faces)\")\r\n        existing_columns = {row[1]: row[2] for row in cursor.fetchall()}\r\n        \r\n        print(f\"   ðŸ“‹ Columnas actuales: {', '.join(existing_columns.keys())}\")\r\n        \r\n        # Definir todas las columnas requeridas\r\n        required_columns = {\r\n            'lastname': 'TEXT',\r\n            'age': 'INTEGER',\r\n            'cedula': 'TEXT',\r\n            'birth_date': 'TEXT',\r\n            'crime': 'TEXT',\r\n            'case_number': 'TEXT',\r\n            'created_by': 'INTEGER'  # â† Esta es la columna faltante\r\n        }\r\n        \r\n        # Agregar columnas faltantes\r\n        for col_name, col_type in required_columns.items():\r\n            if col_name not in existing_columns:\r\n                print(f\"   âž• Agregando columna: {col_name} ({col_type})\")\r\n                try:\r\n                    if col_name == 'created_by':\r\n                        # Agregar con FOREIGN KEY\r\n                        cursor.execute(f\"\"\"\r\n                            ALTER TABLE known_faces \r\n                            ADD COLUMN {col_name} {col_type}\r\n                            REFERENCES users(id)\r\n                        \"\"\")\r\n                    else:\r\n                        cursor.execute(f\"ALTER TABLE known_faces ADD COLUMN {col_name} {col_type}\")\r\n                    print(f\"      âœ… Columna {col_name} agregada exitosamente\")\r\n                except sqlite3.OperationalError as e:\r\n                    if \"duplicate column name\" in str(e).lower():\r\n                        print(f\"      âš ï¸ Columna {col_name} ya existe\")\r\n                    else:\r\n                        print(f\"      âŒ Error: {e}\")\r\n                        raise\r\n            else:\r\n                print(f\"   âœ“ Columna {col_name} ya existe\")\r\n        \r\n        # Verificar y popular cÃ©dulas vacÃ­as\r\n        cursor.execute(\"SELECT COUNT(*) FROM known_faces WHERE cedula IS NULL OR cedula = ''\")\r\n        null_cedulas = cursor.fetchone()[0]\r\n        \r\n        if null_cedulas > 0:\r\n            print(f\"\\n   ðŸ”„ Asignando cÃ©dulas automÃ¡ticas a {null_cedulas} registros...\")\r\n            cursor.execute(\"\"\"\r\n                UPDATE known_faces \r\n                SET cedula = 'AUTO_' || printf('%05d', id)\r\n                WHERE cedula IS NULL OR cedula = ''\r\n            \"\"\")\r\n            print(f\"      âœ… CÃ©dulas asignadas\")\r\n        \r\n        # Crear Ã­ndices si no existen\r\n        print(\"\\n   ðŸ“‘ Creando Ã­ndices...\")\r\n        indices = [\r\n            (\"idx_known_faces_cedula\", \"known_faces(cedula)\"),\r\n            (\"idx_known_faces_case_number\", \"known_faces(case_number)\"),\r\n            (\"idx_known_faces_created_by\", \"known_faces(created_by)\")\r\n        ]\r\n        \r\n        for index_name, index_on in indices:\r\n            try:\r\n                cursor.execute(f\"CREATE INDEX IF NOT EXISTS {index_name} ON {index_on}\")\r\n                print(f\"      âœ… Ãndice {index_name} creado\")\r\n            except Exception as e:\r\n                print(f\"      âš ï¸ Ãndice {index_name}: {e}\")\r\n        \r\n        conn.commit()\r\n        \r\n        # Verificar resultado final\r\n        cursor.execute(\"PRAGMA table_info(known_faces)\")\r\n        final_columns = [row[1] for row in cursor.fetchall()]\r\n        print(f\"\\n   âœ… Columnas finales: {', '.join(final_columns)}\")\r\n        \r\n        conn.close()\r\n        return True\r\n        \r\n    except Exception as e:\r\n        print(f\"   âŒ Error durante migraciÃ³n: {e}\")\r\n        return False\r\n\r\ndef create_known_faces_table(cursor):\r\n    \"\"\"Crear tabla known_faces desde cero con todas las columnas\"\"\"\r\n    cursor.execute(\"\"\"\r\n        CREATE TABLE IF NOT EXISTS known_faces (\r\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n            name TEXT NOT NULL,\r\n            lastname TEXT,\r\n            age INTEGER,\r\n            cedula TEXT UNIQUE NOT NULL,\r\n            birth_date TEXT,\r\n            crime TEXT,\r\n            case_number TEXT,\r\n            embedding BLOB NOT NULL,\r\n            image_path TEXT NOT NULL,\r\n            created_at REAL NOT NULL,\r\n            created_by INTEGER,\r\n            FOREIGN KEY (created_by) REFERENCES users(id)\r\n        )\r\n    \"\"\")\r\n    print(\"   âœ… Tabla known_faces creada con todas las columnas\")\r\n\r\ndef verify_migration(db_path):\r\n    \"\"\"Verificar que la migraciÃ³n fue exitosa\"\"\"\r\n    print(\"\\nðŸ” Verificando migraciÃ³n...\")\r\n    \r\n    try:\r\n        conn = sqlite3.connect(db_path)\r\n        cursor = conn.cursor()\r\n        \r\n        # Verificar columnas\r\n        cursor.execute(\"PRAGMA table_info(known_faces)\")\r\n        columns = [row[1] for row in cursor.fetchall()]\r\n        \r\n        required = ['id', 'name', 'lastname', 'age', 'cedula', 'birth_date', \r\n                   'crime', 'case_number', 'embedding', 'image_path', \r\n                   'created_at', 'created_by']\r\n        \r\n        missing = [col for col in required if col not in columns]\r\n        \r\n        if missing:\r\n            print(f\"   âŒ Faltan columnas: {', '.join(missing)}\")\r\n            conn.close()\r\n            return False\r\n        \r\n        print(\"   âœ… Todas las columnas requeridas presentes\")\r\n        \r\n        # Verificar registros\r\n        cursor.execute(\"SELECT COUNT(*) FROM known_faces\")\r\n        count = cursor.fetchone()[0]\r\n        print(f\"   ðŸ“Š Registros en la tabla: {count}\")\r\n        \r\n        # Verificar Ã­ndices\r\n        cursor.execute(\"SELECT name FROM sqlite_master WHERE type='index' AND tbl_name='known_faces'\")\r\n        indices = [row[0] for row in cursor.fetchall()]\r\n        print(f\"   ðŸ“‘ Ãndices creados: {len(indices)}\")\r\n        \r\n        conn.close()\r\n        return True\r\n        \r\n    except Exception as e:\r\n        print(f\"   âŒ Error en verificaciÃ³n: {e}\")\r\n        return False\r\n\r\ndef main():\r\n    \"\"\"Ejecutar migraciÃ³n completa\"\"\"\r\n    print(\"=\" * 80)\r\n    print(\"ðŸ”§ SCRIPT DE MIGRACIÃ“N COMPLETA - FIX DATABASE\")\r\n    print(\"=\" * 80)\r\n    print(\"\\nEste script solucionarÃ¡ el error:\")\r\n    print(\"âŒ 'table known_faces has no column named created_by'\")\r\n    print(\"\\n\" + \"=\" * 80)\r\n    \r\n    db_path = Path('data/database.db')\r\n    \r\n    # 1. Crear backup\r\n    backup_path = backup_database(db_path)\r\n    \r\n    if not db_path.exists():\r\n        print(\"\\nâš ï¸ Base de datos no existe. Se crearÃ¡ al ejecutar main.py\")\r\n        print(\"   Por favor ejecuta: python main.py\")\r\n        return\r\n    \r\n    # 2. Ejecutar migraciÃ³n\r\n    success = migrate_known_faces_table(db_path)\r\n    \r\n    if not success:\r\n        print(\"\\nâŒ La migraciÃ³n fallÃ³\")\r\n        if backup_path:\r\n            print(f\"   Puedes restaurar el backup desde: {backup_path}\")\r\n        return\r\n    \r\n    # 3. Verificar migraciÃ³n\r\n    verified = verify_migration(db_path)\r\n    \r\n    # 4. Mostrar resumen\r\n    print(\"\\n\" + \"=\" * 80)\r\n    print(\"ðŸ“Š RESUMEN DE LA MIGRACIÃ“N\")\r\n    print(\"=\" * 80)\r\n    \r\n    if verified:\r\n        print(\"\\nâœ… Â¡MIGRACIÃ“N COMPLETADA EXITOSAMENTE!\")\r\n        print(\"\\nâœ“ La columna 'created_by' ha sido agregada\")\r\n        print(\"âœ“ Todos los Ã­ndices han sido creados\")\r\n        print(\"âœ“ La base de datos estÃ¡ lista para usar\")\r\n        print(\"\\nðŸŽ‰ Ahora puedes agregar rostros sin problemas\")\r\n        print(\"\\nðŸ“ Siguiente paso: Ejecuta python main.py\")\r\n    else:\r\n        print(\"\\nâš ï¸ La migraciÃ³n completÃ³ con advertencias\")\r\n        print(\"   Revisa los mensajes anteriores para mÃ¡s detalles\")\r\n        if backup_path:\r\n            print(f\"\\nðŸ’¾ Backup disponible en: {backup_path}\")\r\n    \r\n    print(\"\\n\" + \"=\" * 80)\r\n\r\nif __name__ == \"__main__\":\r\n    main()",
  "main.py": "\r\n\r\nimport sys\r\nimport yaml\r\nfrom pathlib import Path\r\nfrom loguru import logger\r\nfrom PyQt5.QtWidgets import QApplication, QSplashScreen, QMessageBox\r\nfrom PyQt5.QtGui import QPixmap\r\nfrom PyQt5.QtCore import Qt, QTimer\r\n\r\nfrom ui.main_window import MainWindow\r\nfrom ui.login_window import LoginWindow\r\nfrom core.auth_manager import AuthManager\r\n\r\ndef load_config(config_path: str) -> dict:\r\n    \"\"\"\r\n    Load application configuration from YAML file.\r\n    \r\n    Args:\r\n        config_path: Path to config.yaml\r\n        \r\n    Returns:\r\n        Configuration dictionary\r\n    \"\"\"\r\n    try:\r\n        with open(config_path, 'r') as f:\r\n            config = yaml.safe_load(f)\r\n            \r\n        # Ensure required directories exist\r\n        Path(config['app']['screenshot_dir']).mkdir(parents=True, exist_ok=True)\r\n        Path(config['app']['known_faces_dir']).mkdir(parents=True, exist_ok=True)\r\n        Path(config['app']['log_dir']).mkdir(parents=True, exist_ok=True)\r\n        \r\n        return config\r\n    except Exception as e:\r\n        logger.error(f\"Failed to load config: {e}\")\r\n        raise\r\n\r\ndef setup_logging(log_dir: str):\r\n    \"\"\"\r\n    Initialize application logging with loguru.\r\n    \r\n    Args:\r\n        log_dir: Directory for log files\r\n    \"\"\"\r\n    logger.add(\r\n        f\"{log_dir}/app.log\",\r\n        rotation=\"10 MB\",\r\n        retention=\"7 days\",\r\n        level=\"INFO\"\r\n    )\r\n    logger.add(\r\n        f\"{log_dir}/error.log\",\r\n        rotation=\"10 MB\",\r\n        retention=\"30 days\",\r\n        level=\"ERROR\"\r\n    )\r\n    logger.add(\r\n        f\"{log_dir}/security.log\",\r\n        rotation=\"10 MB\",\r\n        retention=\"90 days\",\r\n        level=\"WARNING\",\r\n        filter=lambda record: \"auth\" in record[\"extra\"] or \"security\" in record[\"extra\"]\r\n    )\r\n\r\ndef show_splash_screen(config: dict) -> QSplashScreen:\r\n    \"\"\"Create and display splash screen with logo\"\"\"\r\n    try:\r\n        logo_path = config.get('app', {}).get('logo', 'assets/logo.png')\r\n        \r\n        if not Path(logo_path).exists():\r\n            raise FileNotFoundError(f\"Logo file not found: {logo_path}\")\r\n        \r\n        splash_pix = QPixmap(logo_path)\r\n        if splash_pix.isNull():\r\n            raise ValueError(f\"Invalid logo image: {logo_path}\")\r\n            \r\n        splash = QSplashScreen(splash_pix, Qt.WindowStaysOnTopHint)\r\n        splash.setMask(splash_pix.mask())\r\n\r\n        splash.showMessage(\r\n            \"Initializing Face Tracker...\",\r\n            Qt.AlignBottom | Qt.AlignCenter,\r\n            Qt.white\r\n        )\r\n        QApplication.processEvents()\r\n        \r\n        return splash\r\n        \r\n    except Exception as e:\r\n        logger.warning(f\"Error loading splash screen: {e}\")\r\n        return QSplashScreen(QPixmap(800, 400))\r\n\r\ndef main():\r\n    \"\"\"\r\n    Main entry point with authentication.\r\n    \r\n    Flow:\r\n    1. Load configuration and setup logging\r\n    2. Initialize database and auth manager\r\n    3. Show login window\r\n    4. On successful login, show main application\r\n    5. Maintain user session throughout\r\n    \"\"\"\r\n    try:\r\n        # Load configuration\r\n        config = load_config('config/config.yaml')\r\n        \r\n        # Setup logging\r\n        setup_logging(config['app']['log_dir'])\r\n        logger.info(\"=\" * 60)\r\n        logger.info(\"Application starting...\")\r\n        \r\n        # Create application\r\n        app = QApplication(sys.argv)\r\n        app.setApplicationName(config['app']['name'])\r\n        app.setApplicationVersion(config['app']['version'])\r\n        \r\n        # Show splash screen\r\n        splash = show_splash_screen(config)\r\n        splash.show()\r\n        app.processEvents()\r\n        \r\n        # Initialize database (creates tables if needed)\r\n        from core.database import FaceDatabase\r\n        database = FaceDatabase(config['app']['database_path'])\r\n        \r\n        # Initialize authentication manager\r\n        auth_manager = AuthManager(database)\r\n        \r\n        splash.showMessage(\r\n            \"Loading authentication system...\",\r\n            Qt.AlignBottom | Qt.AlignCenter,\r\n            Qt.white\r\n        )\r\n        app.processEvents()\r\n        \r\n        # Show login window\r\n        splash.finish(None)\r\n        login_window = LoginWindow(auth_manager, config)\r\n        \r\n        if login_window.exec_() != LoginWindow.Accepted:\r\n            logger.info(\"Login cancelled by user\")\r\n            return 0\r\n        \r\n        # Get authenticated user\r\n        current_user = auth_manager.get_current_user()\r\n        if not current_user:\r\n            logger.error(\"No authenticated user after login\")\r\n            QMessageBox.critical(\r\n                None, \r\n                \"Authentication Error\", \r\n                \"Failed to establish user session\"\r\n            )\r\n            return 1\r\n        \r\n        logger.info(f\"User '{current_user.username}' (role: {current_user.role}) logged in successfully\")\r\n        \r\n        # Show splash again for main app initialization\r\n        splash.show()\r\n        splash.showMessage(\r\n            \"Loading AI Models...\",\r\n            Qt.AlignBottom | Qt.AlignCenter,\r\n            Qt.white\r\n        )\r\n        app.processEvents()\r\n        \r\n        # Initialize main window with authenticated user\r\n        window = MainWindow(config, auth_manager, database)\r\n        \r\n        # Setup final close timer\r\n        def show_main_window():\r\n            splash.finish(window)\r\n            window.show()\r\n            logger.info(\"Main application window shown\")\r\n        \r\n        QTimer.singleShot(2000, show_main_window)\r\n        \r\n        # Handle application close\r\n        def on_close():\r\n            try:\r\n                logger.info(f\"User '{current_user.username}' logging out\")\r\n                window.camera_manager.stop_all_cameras()\r\n                window.alert_system.shutdown()\r\n                auth_manager.logout()\r\n                logger.info(\"Application shutdown complete\")\r\n            except Exception as e:\r\n                logger.error(f\"Error during shutdown: {e}\")\r\n            finally:\r\n                app.quit()\r\n        \r\n        app.aboutToQuit.connect(on_close)\r\n        \r\n        # Start event loop\r\n        sys.exit(app.exec_())\r\n        \r\n    except Exception as e:\r\n        logger.critical(f\"Application failed to start: {e}\")\r\n        QMessageBox.critical(\r\n            None,\r\n            \"Critical Error\",\r\n            f\"Application failed to start:\\n\\n{str(e)}\\n\\nCheck logs for details.\"\r\n        )\r\n        sys.exit(1)\r\n\r\nif __name__ == \"__main__\":\r\n    main()",
  "migrate_database.py": "\r\nimport sqlite3\r\nfrom pathlib import Path\r\nfrom loguru import logger\r\n\r\ndef migrate_database():\r\n    \"\"\"Migrar base de datos existente\"\"\"\r\n    \r\n    db_path = Path('data/database.db')\r\n    \r\n    if not db_path.exists():\r\n        logger.error(f\"Base de datos no encontrada: {db_path}\")\r\n        print(\"âŒ No se encontrÃ³ la base de datos.\")\r\n        return False\r\n    \r\n    try:\r\n        conn = sqlite3.connect(str(db_path))\r\n        cursor = conn.cursor()\r\n        \r\n        # Verificar si la tabla existe\r\n        cursor.execute(\"SELECT name FROM sqlite_master WHERE type='table' AND name='known_faces'\")\r\n        if not cursor.fetchone():\r\n            logger.info(\"Tabla known_faces no existe, creando...\")\r\n            create_new_table(cursor)\r\n        else:\r\n            logger.info(\"Tabla known_faces existe, verificando columnas...\")\r\n            migrate_existing_table(cursor)\r\n        \r\n        conn.commit()\r\n        conn.close()\r\n        \r\n        logger.success(\"âœ… MigraciÃ³n completada exitosamente\")\r\n        print(\"âœ… Base de datos migrada correctamente\")\r\n        return True\r\n        \r\n    except Exception as e:\r\n        logger.error(f\"Error durante migraciÃ³n: {e}\")\r\n        print(f\"âŒ Error durante migraciÃ³n: {e}\")\r\n        return False\r\n\r\n\r\ndef create_new_table(cursor):\r\n    \"\"\"Crear tabla known_faces desde cero\"\"\"\r\n    cursor.execute('''\r\n        CREATE TABLE IF NOT EXISTS known_faces (\r\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n            name TEXT NOT NULL,\r\n            lastname TEXT,\r\n            age INTEGER,\r\n            cedula TEXT UNIQUE,\r\n            birth_date TEXT,\r\n            crime TEXT,\r\n            case_number TEXT,\r\n            embedding BLOB NOT NULL,\r\n            image_path TEXT NOT NULL,\r\n            created_at REAL NOT NULL,\r\n            created_by INTEGER,\r\n            FOREIGN KEY (created_by) REFERENCES users(id)\r\n        )\r\n    ''')\r\n    \r\n    # Crear Ã­ndices\r\n    cursor.execute('''\r\n        CREATE INDEX IF NOT EXISTS idx_known_faces_cedula \r\n        ON known_faces(cedula)\r\n    ''')\r\n    cursor.execute('''\r\n        CREATE INDEX IF NOT EXISTS idx_known_faces_case_number \r\n        ON known_faces(case_number)\r\n    ''')\r\n    \r\n    logger.info(\"Tabla known_faces creada exitosamente\")\r\n\r\n\r\ndef migrate_existing_table(cursor):\r\n    \"\"\"Migrar tabla existing agregando nuevas columnas\"\"\"\r\n    \r\n    # Obtener informaciÃ³n de las columnas existentes\r\n    cursor.execute(\"PRAGMA table_info(known_faces)\")\r\n    columns = [row[1] for row in cursor.fetchall()]\r\n    \r\n    logger.info(f\"Columnas actuales: {columns}\")\r\n    \r\n    # Definir columnas requeridas\r\n    required_columns = {\r\n        'lastname': 'TEXT',\r\n        'age': 'INTEGER',\r\n        'cedula': 'TEXT UNIQUE',\r\n        'birth_date': 'TEXT',\r\n        'crime': 'TEXT',\r\n        'case_number': 'TEXT'\r\n    }\r\n    \r\n    # Agregar columnas faltantes\r\n    for col_name, col_type in required_columns.items():\r\n        if col_name not in columns:\r\n            logger.info(f\"Agregando columna: {col_name}\")\r\n            try:\r\n                # Para cedula que debe ser UNIQUE, manejar diferente\r\n                if col_name == 'cedula':\r\n                    cursor.execute(f'ALTER TABLE known_faces ADD COLUMN {col_name} {col_type} DEFAULT NULL')\r\n                else:\r\n                    cursor.execute(f'ALTER TABLE known_faces ADD COLUMN {col_name} {col_type}')\r\n                logger.info(f\"âœ… Columna {col_name} agregada\")\r\n            except Exception as e:\r\n                logger.error(f\"Error al agregar columna {col_name}: {e}\")\r\n                # Si falla por ser UNIQUE, agregar sin constraint\r\n                if 'UNIQUE' in col_type:\r\n                    cursor.execute(f'ALTER TABLE known_faces ADD COLUMN {col_name} TEXT')\r\n                    logger.info(f\"âœ… Columna {col_name} agregada (sin UNIQUE constraint)\")\r\n        else:\r\n            logger.info(f\"âœ“ Columna {col_name} ya existe\")\r\n    \r\n    # Crear Ã­ndices si no existen\r\n    try:\r\n        cursor.execute('''\r\n            CREATE INDEX IF NOT EXISTS idx_known_faces_cedula \r\n            ON known_faces(cedula)\r\n        ''')\r\n        logger.info(\"Ãndice cedula creado/verificado\")\r\n    except Exception as e:\r\n        logger.warning(f\"No se pudo crear Ã­ndice cedula: {e}\")\r\n    \r\n    try:\r\n        cursor.execute('''\r\n            CREATE INDEX IF NOT EXISTS idx_known_faces_case_number \r\n            ON known_faces(case_number)\r\n        ''')\r\n        logger.info(\"Ãndice case_number creado/verificado\")\r\n    except Exception as e:\r\n        logger.warning(f\"No se pudo crear Ã­ndice case_number: {e}\")\r\n    \r\n    # Poblar cedula con valores por defecto si estÃ¡n vacÃ­as\r\n    cursor.execute(\"SELECT COUNT(*) FROM known_faces WHERE cedula IS NULL\")\r\n    null_count = cursor.fetchone()[0]\r\n    \r\n    if null_count > 0:\r\n        logger.info(f\"Poblando {null_count} registros con cÃ©dula por defecto...\")\r\n        cursor.execute('''\r\n            UPDATE known_faces \r\n            SET cedula = 'UNKNOWN_' || id\r\n            WHERE cedula IS NULL\r\n        ''')\r\n        logger.info(f\"âœ… {null_count} registros actualizados\")\r\n\r\n\r\ndef backup_database():\r\n    \"\"\"Crear backup de la base de datos antes de migrar\"\"\"\r\n    import shutil\r\n    from datetime import datetime\r\n    \r\n    db_path = Path('data/database.db')\r\n    \r\n    if db_path.exists():\r\n        timestamp = datetime.now().strftime(\"%Y%m%d_%H%M%S\")\r\n        backup_path = Path(f'data/database_backup_{timestamp}.db')\r\n        \r\n        shutil.copy2(db_path, backup_path)\r\n        logger.info(f\"âœ… Backup creado: {backup_path}\")\r\n        print(f\"âœ… Backup creado: {backup_path}\")\r\n        return True\r\n    \r\n    return False\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    import sys\r\n    \r\n    print(\"=\" * 60)\r\n    print(\"ðŸ”„ Script de MigraciÃ³n de Base de Datos\")\r\n    print(\"=\" * 60)\r\n    \r\n    # Crear backup\r\n    print(\"\\nðŸ“¦ Creando backup...\")\r\n    if backup_database():\r\n        print(\"âœ… Backup completado\")\r\n    \r\n    # Ejecutar migraciÃ³n\r\n    print(\"\\nðŸ”„ Ejecutando migraciÃ³n...\")\r\n    success = migrate_database()\r\n    \r\n    if success:\r\n        print(\"\\nâœ… MigraciÃ³n completada exitosamente\")\r\n        print(\"Ahora puedes ejecutar: python main.py\")\r\n        sys.exit(0)\r\n    else:\r\n        print(\"\\nâŒ Error en la migraciÃ³n\")\r\n        print(\"Por favor revisa los logs en logs/error.log\")\r\n        sys.exit(1)",
  "migrate_existing_faces.py": "import sqlite3\r\nfrom pathlib import Path\r\n\r\ndef migrate():\r\n    conn = sqlite3.connect('data/database.db')\r\n    cursor = conn.cursor()\r\n    \r\n    # Para rostros existentes sin datos adicionales\r\n    cursor.execute('''\r\n        UPDATE known_faces \r\n        SET lastname = 'Por definir',\r\n            age = 0,\r\n            birth_date = '1900-01-01',\r\n            crime = 'No especificado',\r\n            case_number = 'N/A'\r\n        WHERE lastname IS NULL\r\n    ''')\r\n    \r\n    conn.commit()\r\n    conn.close()\r\n    print(\"âœ… MigraciÃ³n completada\")\r\n\r\nif __name__ == \"__main__\":\r\n    migrate()\r\n",
  "requirements.txt": "insightface==0.7.3\r\ntorch>=2.0.0\r\ntorchvision>=0.15.0\r\nnumpy==1.24.3\r\nopencv-python>=4.5.0\r\nopencv-contrib-python>=4.5.0\r\nPyQt5>=5.15.0\r\nPyQt5-sip>=12.8.0\r\npyyaml>=5.4.1\r\nscikit-learn>=1.0.0\r\nscipy>=1.7.0\r\npillow>=9.0.0\r\npygame>=2.0.0\r\npython-dotenv>=0.19.0\r\nloguru>=0.6.0\r\nqimage2ndarray>=1.10.0\r\nonnxruntime==1.15.1\r\n\r\n# telegram-bot\r\npython-telegram-bot>=20.0\r\nrequests>=2.28.0\r\n\r\n# Authentication & Security\r\nbcrypt>=4.0.1\r\ncryptography>=41.0.0",
  "ui": {
    "__pycache__": {
      "alert_panel.cpython-310.pyc": "(binary)",
      "face_manager.cpython-310.pyc": "(binary)",
      "history_viewer.cpython-310.pyc": "(binary)",
      "login_window.cpython-310.pyc": "(binary)",
      "main_window.cpython-310.pyc": "(binary)",
      "user_management.cpython-310.pyc": "(binary)"
    },
    "alert_panel.py": "from PyQt5.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QListWidget, QPushButton,\r\n                            QLabel, QCheckBox, QMessageBox, QListWidgetItem, QFrame,\r\n                            QGraphicsDropShadowEffect, QScrollArea, QWidget)\r\nfrom PyQt5.QtCore import Qt, QSize\r\nfrom PyQt5.QtGui import QFont, QColor, QPixmap, QCursor\r\nfrom loguru import logger\r\nimport time\r\nfrom pathlib import Path\r\nimport cv2\r\nfrom datetime import datetime\r\n\r\nclass AlertDetailDialog(QDialog):\r\n    \"\"\"Ventana emergente con informaciÃ³n detallada del registro en formato card\"\"\"\r\n    \r\n    def __init__(self, alert_event, parent=None):\r\n        super().__init__(parent)\r\n        self.alert_event = alert_event\r\n        self.setWindowTitle(f\"Detalle - {alert_event.face_name}\")\r\n        self.setModal(True)\r\n        self.setMinimumSize(800, 700)\r\n        \r\n        self.setup_style()\r\n        self.init_ui()\r\n        \r\n    def setup_style(self):\r\n        \"\"\"Estilo moderno Windows 11\"\"\"\r\n        self.setStyleSheet(\"\"\"\r\n            QDialog {\r\n                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,\r\n                    stop:0 #1a1a2e,\r\n                    stop:1 #16213e);\r\n            }\r\n            QLabel {\r\n                color: white;\r\n            }\r\n            QPushButton {\r\n                background-color: rgba(0, 120, 212, 0.8);\r\n                color: white;\r\n                border: none;\r\n                border-radius: 6px;\r\n                padding: 10px 20px;\r\n                font-size: 13px;\r\n                font-weight: 500;\r\n            }\r\n            QPushButton:hover {\r\n                background-color: rgba(0, 120, 212, 1);\r\n            }\r\n            QPushButton#closeButton {\r\n                background-color: rgba(220, 53, 69, 0.8);\r\n            }\r\n            QPushButton#closeButton:hover {\r\n                background-color: rgba(220, 53, 69, 1);\r\n            }\r\n        \"\"\")\r\n    \r\n    def init_ui(self):\r\n        \"\"\"Crear interfaz con cards\"\"\"\r\n        layout = QVBoxLayout(self)\r\n        layout.setContentsMargins(24, 24, 24, 24)\r\n        layout.setSpacing(20)\r\n        \r\n        # Scroll area para todo el contenido\r\n        scroll = QScrollArea()\r\n        scroll.setWidgetResizable(True)\r\n        scroll.setStyleSheet(\"\"\"\r\n            QScrollArea {\r\n                border: none;\r\n                background-color: transparent;\r\n            }\r\n        \"\"\")\r\n        \r\n        content_widget = QWidget()\r\n        content_layout = QVBoxLayout(content_widget)\r\n        content_layout.setSpacing(20)\r\n        \r\n        # Header Card\r\n        header_card = self.create_header_card()\r\n        content_layout.addWidget(header_card)\r\n        \r\n        # Image Card\r\n        if self.alert_event.screenshot_path:\r\n            image_card = self.create_image_card()\r\n            content_layout.addWidget(image_card)\r\n        \r\n        # Info Card\r\n        info_card = self.create_info_card()\r\n        content_layout.addWidget(info_card)\r\n        \r\n        # Biometric Card (edad y gÃ©nero)\r\n        if self.alert_event.age or self.alert_event.gender:\r\n            bio_card = self.create_biometric_card()\r\n            content_layout.addWidget(bio_card)\r\n        \r\n        # Location Card\r\n        location_card = self.create_location_card()\r\n        content_layout.addWidget(location_card)\r\n        \r\n        content_layout.addStretch()\r\n        \r\n        scroll.setWidget(content_widget)\r\n        layout.addWidget(scroll)\r\n        \r\n        # Close button\r\n        close_btn = QPushButton(\"Cerrar\")\r\n        close_btn.setObjectName(\"closeButton\")\r\n        close_btn.clicked.connect(self.close)\r\n        close_btn.setFixedWidth(150)\r\n        layout.addWidget(close_btn, alignment=Qt.AlignCenter)\r\n    \r\n    def create_card(self, title, icon=\"\"):\r\n        \"\"\"Crear card base con estilo\"\"\"\r\n        card = QFrame()\r\n        card.setStyleSheet(\"\"\"\r\n            QFrame {\r\n                background-color: rgba(255, 255, 255, 0.05);\r\n                border: 1px solid rgba(255, 255, 255, 0.1);\r\n                border-radius: 12px;\r\n                padding: 20px;\r\n            }\r\n        \"\"\")\r\n        \r\n        # Shadow effect\r\n        shadow = QGraphicsDropShadowEffect()\r\n        shadow.setBlurRadius(20)\r\n        shadow.setColor(QColor(0, 0, 0, 80))\r\n        shadow.setOffset(0, 4)\r\n        card.setGraphicsEffect(shadow)\r\n        \r\n        card_layout = QVBoxLayout(card)\r\n        card_layout.setSpacing(16)\r\n        \r\n        # Title\r\n        title_label = QLabel(f\"{icon} {title}\")\r\n        title_label.setStyleSheet(\"\"\"\r\n            font-size: 18px;\r\n            font-weight: 600;\r\n            color: white;\r\n            margin-bottom: 8px;\r\n        \"\"\")\r\n        card_layout.addWidget(title_label)\r\n        \r\n        return card, card_layout\r\n    \r\n    def create_header_card(self):\r\n        \"\"\"Card de header con nombre y estado\"\"\"\r\n        card, layout = self.create_card(\"IdentificaciÃ³n\", \"ðŸ†”\")\r\n        \r\n        # Nombre grande\r\n        name_label = QLabel(self.alert_event.face_name)\r\n        name_label.setStyleSheet(\"\"\"\r\n            font-size: 32px;\r\n            font-weight: bold;\r\n            color: #4CAF50;\r\n            margin: 10px 0;\r\n        \"\"\")\r\n        name_label.setAlignment(Qt.AlignCenter)\r\n        layout.addWidget(name_label)\r\n        \r\n        # Badge de confianza\r\n        confidence_pct = self.alert_event.confidence * 100 if self.alert_event.confidence <= 1 else self.alert_event.confidence\r\n        \r\n        confidence_frame = QFrame()\r\n        confidence_frame.setStyleSheet(f\"\"\"\r\n            QFrame {{\r\n                background-color: {'rgba(76, 175, 80, 0.3)' if confidence_pct >= 80 else 'rgba(255, 193, 7, 0.3)' if confidence_pct >= 60 else 'rgba(244, 67, 54, 0.3)'};\r\n                border-radius: 20px;\r\n                padding: 8px 20px;\r\n            }}\r\n        \"\"\")\r\n        confidence_layout = QHBoxLayout(confidence_frame)\r\n        confidence_layout.setContentsMargins(0, 0, 0, 0)\r\n        \r\n        confidence_label = QLabel(f\"ðŸŽ¯ Confianza: {confidence_pct:.1f}%\")\r\n        confidence_label.setStyleSheet(\"\"\"\r\n            font-size: 16px;\r\n            font-weight: 600;\r\n            color: white;\r\n        \"\"\")\r\n        confidence_label.setAlignment(Qt.AlignCenter)\r\n        confidence_layout.addWidget(confidence_label)\r\n        \r\n        layout.addWidget(confidence_frame, alignment=Qt.AlignCenter)\r\n        \r\n        return card\r\n    \r\n    def create_image_card(self):\r\n        \"\"\"Card con la imagen capturada\"\"\"\r\n        card, layout = self.create_card(\"Captura de CÃ¡mara\", \"ðŸ“·\")\r\n        \r\n        # Cargar imagen\r\n        screenshot_path = Path(self.alert_event.screenshot_path)\r\n        if screenshot_path.exists():\r\n            try:\r\n                image = cv2.imread(str(screenshot_path))\r\n                if image is not None:\r\n                    # Convertir a RGB\r\n                    image_rgb = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)\r\n                    h, w, ch = image_rgb.shape\r\n                    bytes_per_line = ch * w\r\n                    \r\n                    from PyQt5.QtGui import QImage\r\n                    q_image = QImage(image_rgb.data, w, h, bytes_per_line, QImage.Format_RGB888)\r\n                    pixmap = QPixmap.fromImage(q_image)\r\n                    \r\n                    # Image label\r\n                    image_label = QLabel()\r\n                    image_label.setPixmap(pixmap.scaled(\r\n                        700, 400,\r\n                        Qt.KeepAspectRatio,\r\n                        Qt.SmoothTransformation\r\n                    ))\r\n                    image_label.setAlignment(Qt.AlignCenter)\r\n                    image_label.setStyleSheet(\"\"\"\r\n                        QLabel {\r\n                            background-color: rgba(0, 0, 0, 0.3);\r\n                            border-radius: 8px;\r\n                            padding: 10px;\r\n                        }\r\n                    \"\"\")\r\n                    layout.addWidget(image_label)\r\n                    \r\n                    # Info de la imagen\r\n                    img_info = QLabel(f\"ðŸ“ ResoluciÃ³n: {w}x{h} | ðŸ“„ {screenshot_path.name}\")\r\n                    img_info.setStyleSheet(\"\"\"\r\n                        font-size: 11px;\r\n                        color: rgba(255, 255, 255, 0.6);\r\n                        margin-top: 8px;\r\n                    \"\"\")\r\n                    img_info.setAlignment(Qt.AlignCenter)\r\n                    layout.addWidget(img_info)\r\n                    \r\n            except Exception as e:\r\n                logger.error(f\"Error loading image: {e}\")\r\n                error_label = QLabel(\"âŒ Error al cargar la imagen\")\r\n                error_label.setStyleSheet(\"color: #ff6b6b; font-size: 14px;\")\r\n                error_label.setAlignment(Qt.AlignCenter)\r\n                layout.addWidget(error_label)\r\n        else:\r\n            no_image_label = QLabel(\"ðŸ“· Imagen no disponible\")\r\n            no_image_label.setStyleSheet(\"color: rgba(255, 255, 255, 0.5); font-size: 14px;\")\r\n            no_image_label.setAlignment(Qt.AlignCenter)\r\n            layout.addWidget(no_image_label)\r\n        \r\n        return card\r\n    \r\n    def create_info_card(self):\r\n        \"\"\"Card con informaciÃ³n general\"\"\"\r\n        card, layout = self.create_card(\"InformaciÃ³n del Evento\", \"â„¹ï¸\")\r\n        \r\n        # Timestamp\r\n        time_str = datetime.fromtimestamp(self.alert_event.timestamp).strftime(\"%d/%m/%Y %H:%M:%S\")\r\n        \r\n        info_items = [\r\n            (\"ðŸ•’\", \"Fecha y Hora\", time_str),\r\n            (\"ðŸ“¹\", \"CÃ¡mara\", f\"{self.alert_event.camera_name} (ID: {self.alert_event.camera_id})\"),\r\n            (\"ðŸ‘¤\", \"Persona Identificada\", self.alert_event.face_name),\r\n        ]\r\n        \r\n        for icon, label_text, value in info_items:\r\n            item_frame = QFrame()\r\n            item_frame.setStyleSheet(\"\"\"\r\n                QFrame {\r\n                    background-color: rgba(255, 255, 255, 0.03);\r\n                    border-radius: 8px;\r\n                    padding: 12px;\r\n                }\r\n            \"\"\")\r\n            item_layout = QHBoxLayout(item_frame)\r\n            \r\n            # Icon + Label\r\n            label = QLabel(f\"{icon} <b>{label_text}:</b>\")\r\n            label.setStyleSheet(\"font-size: 13px; color: rgba(255, 255, 255, 0.8);\")\r\n            item_layout.addWidget(label)\r\n            \r\n            item_layout.addStretch()\r\n            \r\n            # Value\r\n            value_label = QLabel(value)\r\n            value_label.setStyleSheet(\"font-size: 13px; color: white; font-weight: 600;\")\r\n            item_layout.addWidget(value_label)\r\n            \r\n            layout.addWidget(item_frame)\r\n        \r\n        return card\r\n    \r\n    def create_biometric_card(self):\r\n        \"\"\"Card con datos biomÃ©tricos\"\"\"\r\n        card, layout = self.create_card(\"Datos BiomÃ©tricos\", \"ðŸ§¬\")\r\n        \r\n        bio_layout = QHBoxLayout()\r\n        \r\n        # Age\r\n        if self.alert_event.age:\r\n            age_frame = QFrame()\r\n            age_frame.setStyleSheet(\"\"\"\r\n                QFrame {\r\n                    background: qlineargradient(x1:0, y1:0, x2:1, y2:0,\r\n                        stop:0 rgba(33, 150, 243, 0.3),\r\n                        stop:1 rgba(33, 150, 243, 0.1));\r\n                    border-radius: 12px;\r\n                    padding: 20px;\r\n                }\r\n            \"\"\")\r\n            age_layout = QVBoxLayout(age_frame)\r\n            \r\n            age_icon = QLabel(\"ðŸ‘¶\")\r\n            age_icon.setStyleSheet(\"font-size: 32px;\")\r\n            age_icon.setAlignment(Qt.AlignCenter)\r\n            age_layout.addWidget(age_icon)\r\n            \r\n            age_label = QLabel(f\"{self.alert_event.age}\")\r\n            age_label.setStyleSheet(\"font-size: 36px; font-weight: bold; color: white;\")\r\n            age_label.setAlignment(Qt.AlignCenter)\r\n            age_layout.addWidget(age_label)\r\n            \r\n            age_text = QLabel(\"AÃ±os (estimado)\")\r\n            age_text.setStyleSheet(\"font-size: 12px; color: rgba(255, 255, 255, 0.7);\")\r\n            age_text.setAlignment(Qt.AlignCenter)\r\n            age_layout.addWidget(age_text)\r\n            \r\n            bio_layout.addWidget(age_frame)\r\n        \r\n        # Gender\r\n        if self.alert_event.gender:\r\n            gender_frame = QFrame()\r\n            gender_color = \"rgba(233, 30, 99, 0.3)\" if self.alert_event.gender == \"Female\" else \"rgba(3, 169, 244, 0.3)\"\r\n            gender_frame.setStyleSheet(f\"\"\"\r\n                QFrame {{\r\n                    background: qlineargradient(x1:0, y1:0, x2:1, y2:0,\r\n                        stop:0 {gender_color},\r\n                        stop:1 rgba(255, 255, 255, 0.05));\r\n                    border-radius: 12px;\r\n                    padding: 20px;\r\n                }}\r\n            \"\"\")\r\n            gender_layout = QVBoxLayout(gender_frame)\r\n            \r\n            gender_icon = QLabel(\"ðŸš»\")\r\n            gender_icon.setStyleSheet(\"font-size: 32px;\")\r\n            gender_icon.setAlignment(Qt.AlignCenter)\r\n            gender_layout.addWidget(gender_icon)\r\n            \r\n            gender_label = QLabel(self.alert_event.gender)\r\n            gender_label.setStyleSheet(\"font-size: 28px; font-weight: bold; color: white;\")\r\n            gender_label.setAlignment(Qt.AlignCenter)\r\n            gender_layout.addWidget(gender_label)\r\n            \r\n            gender_text = QLabel(\"GÃ©nero (detectado)\")\r\n            gender_text.setStyleSheet(\"font-size: 12px; color: rgba(255, 255, 255, 0.7);\")\r\n            gender_text.setAlignment(Qt.AlignCenter)\r\n            gender_layout.addWidget(gender_text)\r\n            \r\n            bio_layout.addWidget(gender_frame)\r\n        \r\n        layout.addLayout(bio_layout)\r\n        return card\r\n    \r\n    def create_location_card(self):\r\n        \"\"\"Card con informaciÃ³n de ubicaciÃ³n\"\"\"\r\n        card, layout = self.create_card(\"UbicaciÃ³n de la DetecciÃ³n\", \"ðŸ“\")\r\n        \r\n        # Mapa visual simple\r\n        location_frame = QFrame()\r\n        location_frame.setStyleSheet(\"\"\"\r\n            QFrame {\r\n                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,\r\n                    stop:0 rgba(76, 175, 80, 0.2),\r\n                    stop:1 rgba(76, 175, 80, 0.05));\r\n                border-radius: 8px;\r\n                padding: 16px;\r\n            }\r\n        \"\"\")\r\n        location_layout = QVBoxLayout(location_frame)\r\n        \r\n        camera_info = QLabel(f\"ðŸŽ¥ <b>{self.alert_event.camera_name}</b>\")\r\n        camera_info.setStyleSheet(\"font-size: 16px; color: white;\")\r\n        location_layout.addWidget(camera_info)\r\n        \r\n        camera_id_info = QLabel(f\"ID de CÃ¡mara: {self.alert_event.camera_id}\")\r\n        camera_id_info.setStyleSheet(\"font-size: 13px; color: rgba(255, 255, 255, 0.7);\")\r\n        location_layout.addWidget(camera_id_info)\r\n        \r\n        layout.addWidget(location_frame)\r\n        \r\n        # File path si existe\r\n        if self.alert_event.screenshot_path:\r\n            path_label = QLabel(f\"ðŸ’¾ Archivo: {Path(self.alert_event.screenshot_path).name}\")\r\n            path_label.setStyleSheet(\"\"\"\r\n                font-size: 11px;\r\n                color: rgba(255, 255, 255, 0.5);\r\n                margin-top: 8px;\r\n            \"\"\")\r\n            path_label.setWordWrap(True)\r\n            layout.addWidget(path_label)\r\n        \r\n        return card\r\n\r\n\r\nclass ClickableAlertItem(QListWidgetItem):\r\n    \"\"\"Item de lista clickeable personalizado\"\"\"\r\n    \r\n    def __init__(self, alert_event, *args, **kwargs):\r\n        super().__init__(*args, **kwargs)\r\n        self.alert_event = alert_event\r\n        \r\n        # Estilo de cursor\r\n        self.setFlags(self.flags() | Qt.ItemIsEnabled | Qt.ItemIsSelectable)\r\n\r\n\r\nclass AlertPanel(QDialog):\r\n    def __init__(self, alert_system):\r\n        super().__init__()\r\n        self.alert_system = alert_system\r\n        self.setWindowTitle(\"Panel de Alertas\")\r\n        self.setGeometry(300, 300, 900, 600)\r\n        self.setMinimumSize(800, 500)\r\n        \r\n        self.setup_style()\r\n        self.init_ui()\r\n        self.load_alerts()\r\n        \r\n    def setup_style(self):\r\n        \"\"\"Estilo moderno Windows 11\"\"\"\r\n        self.setStyleSheet(\"\"\"\r\n            QDialog {\r\n                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,\r\n                    stop:0 #1a1a2e,\r\n                    stop:1 #16213e);\r\n            }\r\n            QLabel {\r\n                color: white;\r\n            }\r\n            QListWidget {\r\n                background-color: rgba(255, 255, 255, 0.05);\r\n                border: 1px solid rgba(255, 255, 255, 0.15);\r\n                border-radius: 8px;\r\n                color: white;\r\n                padding: 8px;\r\n                font-size: 13px;\r\n            }\r\n            QListWidget::item {\r\n                background-color: rgba(255, 255, 255, 0.03);\r\n                border: 1px solid rgba(255, 255, 255, 0.08);\r\n                border-radius: 6px;\r\n                padding: 12px;\r\n                margin: 4px 0;\r\n            }\r\n            QListWidget::item:hover {\r\n                background-color: rgba(0, 120, 212, 0.2);\r\n                border: 1px solid rgba(0, 120, 212, 0.4);\r\n                cursor: pointer;\r\n            }\r\n            QListWidget::item:selected {\r\n                background-color: rgba(0, 120, 212, 0.3);\r\n                border: 1px solid rgba(0, 120, 212, 0.5);\r\n            }\r\n            QCheckBox {\r\n                color: rgba(255, 255, 255, 0.9);\r\n                font-size: 13px;\r\n                spacing: 8px;\r\n            }\r\n            QCheckBox::indicator {\r\n                width: 18px;\r\n                height: 18px;\r\n                border-radius: 4px;\r\n                border: 2px solid rgba(255, 255, 255, 0.3);\r\n                background-color: transparent;\r\n            }\r\n            QCheckBox::indicator:checked {\r\n                background-color: #0078d4;\r\n                border-color: #0078d4;\r\n            }\r\n            QPushButton {\r\n                background-color: rgba(0, 120, 212, 0.8);\r\n                color: white;\r\n                border: none;\r\n                border-radius: 6px;\r\n                padding: 10px 20px;\r\n                font-size: 13px;\r\n                font-weight: 500;\r\n            }\r\n            QPushButton:hover {\r\n                background-color: rgba(0, 120, 212, 1);\r\n            }\r\n            QPushButton#clearButton {\r\n                background-color: rgba(220, 53, 69, 0.8);\r\n            }\r\n            QPushButton#clearButton:hover {\r\n                background-color: rgba(220, 53, 69, 1);\r\n            }\r\n        \"\"\")\r\n        \r\n    def init_ui(self):\r\n        \"\"\"Set up and arrange all the UI widgets\"\"\"\r\n        layout = QVBoxLayout(self)\r\n        layout.setContentsMargins(24, 24, 24, 24)\r\n        layout.setSpacing(20)\r\n        \r\n        # Header\r\n        header_frame = QFrame()\r\n        header_frame.setStyleSheet(\"\"\"\r\n            QFrame {\r\n                background-color: rgba(255, 255, 255, 0.03);\r\n                border-radius: 8px;\r\n                padding: 16px;\r\n            }\r\n        \"\"\")\r\n        header_layout = QVBoxLayout(header_frame)\r\n        \r\n        title = QLabel(\"ðŸ”” Panel de Alertas\")\r\n        title.setStyleSheet(\"font-size: 24px; font-weight: bold; color: white;\")\r\n        header_layout.addWidget(title)\r\n        \r\n        subtitle = QLabel(\"Haz clic en cualquier alerta para ver detalles completos\")\r\n        subtitle.setStyleSheet(\"color: rgba(255, 255, 255, 0.7); font-size: 13px;\")\r\n        header_layout.addWidget(subtitle)\r\n        \r\n        layout.addWidget(header_frame)\r\n        \r\n        # Counter label\r\n        self.count_label = QLabel()\r\n        self.count_label.setStyleSheet(\"\"\"\r\n            color: rgba(255, 255, 255, 0.8);\r\n            font-size: 14px;\r\n            font-weight: 600;\r\n            padding: 8px 0;\r\n        \"\"\")\r\n        layout.addWidget(self.count_label)\r\n        \r\n        # Alert list\r\n        self.alert_list = QListWidget()\r\n        self.alert_list.itemClicked.connect(self.on_alert_clicked)\r\n        layout.addWidget(self.alert_list)\r\n        \r\n        # Controls\r\n        controls_layout = QHBoxLayout()\r\n        \r\n        self.enable_alerts_check = QCheckBox(\"Habilitar Alertas Sonoras\")\r\n        self.enable_alerts_check.setChecked(self.alert_system.alert_enabled)\r\n        self.enable_alerts_check.stateChanged.connect(self.toggle_alerts)\r\n        controls_layout.addWidget(self.enable_alerts_check)\r\n        \r\n        self.enable_screenshots_check = QCheckBox(\"Captura AutomÃ¡tica\")\r\n        self.enable_screenshots_check.setChecked(self.alert_system.screenshot_enabled)\r\n        self.enable_screenshots_check.stateChanged.connect(self.toggle_screenshots)\r\n        controls_layout.addWidget(self.enable_screenshots_check)\r\n        \r\n        controls_layout.addStretch()\r\n        \r\n        self.refresh_btn = QPushButton(\"ðŸ”„ Actualizar\")\r\n        self.refresh_btn.clicked.connect(self.load_alerts)\r\n        controls_layout.addWidget(self.refresh_btn)\r\n        \r\n        self.clear_btn = QPushButton(\"ðŸ—‘ï¸ Limpiar\")\r\n        self.clear_btn.setObjectName(\"clearButton\")\r\n        self.clear_btn.clicked.connect(self.clear_alerts)\r\n        controls_layout.addWidget(self.clear_btn)\r\n        \r\n        self.close_btn = QPushButton(\"Cerrar\")\r\n        self.close_btn.clicked.connect(self.close)\r\n        controls_layout.addWidget(self.close_btn)\r\n        \r\n        layout.addLayout(controls_layout)\r\n        \r\n    def load_alerts(self):\r\n        \"\"\"Fetch and display alerts\"\"\"\r\n        self.alert_list.clear()\r\n        alerts = self.alert_system.get_recent_alerts(50)\r\n        \r\n        self.count_label.setText(f\"ðŸ“‹ Total de alertas: {len(alerts)}\")\r\n        \r\n        if not alerts:\r\n            item = QListWidgetItem(\"ðŸ“­ No hay alertas para mostrar\")\r\n            item.setFlags(Qt.ItemIsEnabled)\r\n            self.alert_list.addItem(item)\r\n            return\r\n        \r\n        for alert in alerts:\r\n            time_str = time.strftime(\"%Y-%m-%d %H:%M:%S\", time.localtime(alert.timestamp))\r\n            confidence_pct = alert.confidence * 100 if alert.confidence <= 1 else alert.confidence\r\n            \r\n            # Crear texto con formato mejorado\r\n            item_text = f\"ðŸ•’ {time_str}  |  ðŸ‘¤ {alert.face_name}  |  ðŸ“¹ {alert.camera_name}  |  ðŸŽ¯ {confidence_pct:.1f}%\"\r\n            \r\n            # Agregar info biomÃ©trica si existe\r\n            bio_info = []\r\n            if alert.age:\r\n                bio_info.append(f\"ðŸ‘¶ {alert.age} aÃ±os\")\r\n            if alert.gender:\r\n                bio_info.append(f\"ðŸš» {alert.gender}\")\r\n            \r\n            if bio_info:\r\n                item_text += f\"\\n   {' | '.join(bio_info)}\"\r\n            \r\n            # Crear item clickeable\r\n            item = ClickableAlertItem(alert, item_text)\r\n            \r\n            # Color segÃºn confianza\r\n            if confidence_pct >= 80:\r\n                item.setForeground(QColor(76, 175, 80))  # Verde\r\n            elif confidence_pct >= 60:\r\n                item.setForeground(QColor(255, 193, 7))  # Amarillo\r\n            else:\r\n                item.setForeground(QColor(244, 67, 54))  # Rojo\r\n            \r\n            self.alert_list.addItem(item)\r\n            \r\n    def on_alert_clicked(self, item):\r\n        \"\"\"Handle alert click - show detail dialog\"\"\"\r\n        if isinstance(item, ClickableAlertItem):\r\n            try:\r\n                detail_dialog = AlertDetailDialog(item.alert_event, self)\r\n                detail_dialog.exec_()\r\n            except Exception as e:\r\n                logger.error(f\"Error showing alert detail: {e}\")\r\n                QMessageBox.critical(\r\n                    self,\r\n                    \"Error\",\r\n                    f\"No se pudo mostrar el detalle de la alerta:\\n{str(e)}\"\r\n                )\r\n            \r\n    def toggle_alerts(self, state):\r\n        \"\"\"Enable or disable alerts\"\"\"\r\n        enabled = state == Qt.Checked\r\n        self.alert_system.enable_alerts(enabled)\r\n        status = \"activadas\" if enabled else \"desactivadas\"\r\n        logger.info(f\"Alertas sonoras {status}\")\r\n        \r\n    def toggle_screenshots(self, state):\r\n        \"\"\"Enable or disable screenshots\"\"\"\r\n        enabled = state == Qt.Checked\r\n        self.alert_system.enable_screenshots(enabled)\r\n        status = \"activada\" if enabled else \"desactivada\"\r\n        logger.info(f\"Captura automÃ¡tica {status}\")\r\n        \r\n    def clear_alerts(self):\r\n        \"\"\"Clear all alerts after confirmation\"\"\"\r\n        reply = QMessageBox.question(\r\n            self,\r\n            \"Confirmar Limpieza\",\r\n            \"Â¿EstÃ¡s seguro de que deseas eliminar todas las alertas?\\n\\nEsta acciÃ³n no se puede deshacer.\",\r\n            QMessageBox.Yes | QMessageBox.No,\r\n            QMessageBox.No\r\n        )\r\n            \r\n        if reply == QMessageBox.Yes:\r\n            self.alert_system.clear_alerts()\r\n            self.load_alerts()\r\n            QMessageBox.information(\r\n                self,\r\n                \"Ã‰xito\",\r\n                \"Todas las alertas han sido eliminadas.\"\r\n            )",
    "face_manager.py": "import os\r\nfrom PyQt5.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QListWidget, QPushButton,\r\n                            QLabel, QFileDialog, QMessageBox, QLineEdit, QComboBox, \r\n                            QFrame, QSplitter, QListWidgetItem, QGraphicsDropShadowEffect,\r\n                            QSpinBox, QDateEdit, QScrollArea)\r\nfrom PyQt5.QtCore import Qt, QSize, QDate\r\nfrom PyQt5.QtGui import QPixmap, QFont, QColor, QIcon\r\nfrom loguru import logger\r\nimport cv2\r\nimport numpy as np\r\nfrom pathlib import Path\r\n\r\nfrom core.utils import numpy_to_pixmap, resize_image\r\n\r\nclass FaceManagerDialog(QDialog):\r\n    def __init__(self, face_detector, known_faces_dir, database, auth_manager):\r\n        super().__init__()\r\n        self.face_detector = face_detector\r\n        self.known_faces_dir = known_faces_dir\r\n        self.database = database\r\n        self.auth_manager = auth_manager\r\n        self.current_image = None\r\n        self.selected_face_data = None\r\n        \r\n        self.setWindowTitle(\"Administrador de Rostros\")\r\n        self.setGeometry(150, 100, 1100, 800)\r\n        self.setMinimumSize(900, 700)\r\n        \r\n        self.setup_style()\r\n        self.init_ui()\r\n        self.load_face_list()\r\n        \r\n    def setup_style(self):\r\n        \"\"\"Aplicar estilo Windows 11\"\"\"\r\n        self.setStyleSheet(\"\"\"\r\n            QDialog {\r\n                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,\r\n                    stop:0 #1a1a2e,\r\n                    stop:1 #16213e);\r\n            }\r\n            QLabel {\r\n                color: white;\r\n                font-size: 13px;\r\n            }\r\n            QListWidget {\r\n                background-color: rgba(255, 255, 255, 0.05);\r\n                border: 1px solid rgba(255, 255, 255, 0.15);\r\n                border-radius: 8px;\r\n                color: white;\r\n                padding: 8px;\r\n                font-size: 13px;\r\n            }\r\n            QListWidget::item {\r\n                background-color: rgba(255, 255, 255, 0.03);\r\n                border: 1px solid rgba(255, 255, 255, 0.08);\r\n                border-radius: 6px;\r\n                padding: 10px;\r\n                margin: 3px 0;\r\n            }\r\n            QListWidget::item:hover {\r\n                background-color: rgba(255, 255, 255, 0.08);\r\n                border: 1px solid rgba(255, 255, 255, 0.15);\r\n            }\r\n            QListWidget::item:selected {\r\n                background-color: rgba(0, 120, 212, 0.3);\r\n                border: 1px solid rgba(0, 120, 212, 0.5);\r\n            }\r\n            QLineEdit {\r\n                background-color: rgba(255, 255, 255, 0.08);\r\n                color: white;\r\n                border: 1px solid rgba(255, 255, 255, 0.15);\r\n                border-radius: 6px;\r\n                padding: 10px 14px;\r\n                font-size: 13px;\r\n            }\r\n            QLineEdit:focus {\r\n                background-color: rgba(255, 255, 255, 0.12);\r\n                border: 1px solid rgba(0, 120, 212, 0.8);\r\n            }\r\n            QSpinBox, QDateEdit {\r\n                background-color: rgba(255, 255, 255, 0.08);\r\n                color: white;\r\n                border: 1px solid rgba(255, 255, 255, 0.15);\r\n                border-radius: 6px;\r\n                padding: 8px;\r\n                font-size: 13px;\r\n            }\r\n            QSpinBox:focus, QDateEdit:focus {\r\n                background-color: rgba(255, 255, 255, 0.12);\r\n                border: 1px solid rgba(0, 120, 212, 0.8);\r\n            }\r\n            QPushButton {\r\n                background-color: rgba(0, 120, 212, 0.8);\r\n                color: white;\r\n                border: none;\r\n                border-radius: 6px;\r\n                padding: 10px 20px;\r\n                font-size: 13px;\r\n                font-weight: 500;\r\n                min-width: 120px;\r\n            }\r\n            QPushButton:hover {\r\n                background-color: rgba(0, 120, 212, 1);\r\n            }\r\n            QPushButton:pressed {\r\n                background-color: rgba(0, 100, 180, 1);\r\n            }\r\n            QPushButton#deleteButton {\r\n                background-color: rgba(220, 53, 69, 0.8);\r\n            }\r\n            QPushButton#deleteButton:hover {\r\n                background-color: rgba(220, 53, 69, 1);\r\n            }\r\n            QPushButton#importButton {\r\n                background-color: rgba(40, 167, 69, 0.8);\r\n            }\r\n            QPushButton#importButton:hover {\r\n                background-color: rgba(40, 167, 69, 1);\r\n            }\r\n            QFrame#previewFrame {\r\n                background-color: rgba(0, 0, 0, 0.3);\r\n                border: 2px dashed rgba(255, 255, 255, 0.2);\r\n                border-radius: 12px;\r\n            }\r\n            QFrame#sidePanel {\r\n                background-color: rgba(255, 255, 255, 0.03);\r\n                border-radius: 12px;\r\n                padding: 16px;\r\n            }\r\n        \"\"\")\r\n        \r\n    def init_ui(self):\r\n        layout = QVBoxLayout()\r\n        layout.setContentsMargins(24, 24, 24, 24)\r\n        layout.setSpacing(20)\r\n        \r\n        # Header\r\n        header = QFrame()\r\n        header.setStyleSheet(\"\"\"\r\n            QFrame {\r\n                background-color: rgba(255, 255, 255, 0.03);\r\n                border-radius: 8px;\r\n                padding: 16px;\r\n            }\r\n        \"\"\")\r\n        header_layout = QVBoxLayout(header)\r\n        \r\n        title = QLabel(\"Administrador de Rostros\")\r\n        title_font = QFont()\r\n        title_font.setPointSize(20)\r\n        title_font.setBold(True)\r\n        title.setFont(title_font)\r\n        header_layout.addWidget(title)\r\n        \r\n        subtitle = QLabel(\"Gestiona los rostros conocidos del sistema de reconocimiento\")\r\n        subtitle.setStyleSheet(\"color: rgba(255, 255, 255, 0.7); font-size: 13px;\")\r\n        header_layout.addWidget(subtitle)\r\n        \r\n        layout.addWidget(header)\r\n        \r\n        # Splitter principal\r\n        splitter = QSplitter(Qt.Horizontal)\r\n        \r\n        # Panel izquierdo - Lista de rostros\r\n        left_panel = QFrame()\r\n        left_panel.setObjectName(\"sidePanel\")\r\n        left_layout = QVBoxLayout(left_panel)\r\n        left_layout.setSpacing(12)\r\n        \r\n        list_header = QLabel(\"Rostros Registrados\")\r\n        list_header.setStyleSheet(\"font-size: 14px; font-weight: 600; color: white;\")\r\n        left_layout.addWidget(list_header)\r\n        \r\n        # Contador de rostros\r\n        self.face_count_label = QLabel()\r\n        self.face_count_label.setStyleSheet(\"color: rgba(255, 255, 255, 0.7); font-size: 12px;\")\r\n        left_layout.addWidget(self.face_count_label)\r\n        \r\n        self.face_list = QListWidget()\r\n        self.face_list.currentItemChanged.connect(self.on_face_selected)\r\n        left_layout.addWidget(self.face_list)\r\n        \r\n        splitter.addWidget(left_panel)\r\n        \r\n        # Panel derecho - Vista previa y controles\r\n        right_panel = QFrame()\r\n        right_layout = QVBoxLayout(right_panel)\r\n        right_layout.setSpacing(16)\r\n        \r\n        # Vista previa\r\n        preview_label = QLabel(\"Vista Previa\")\r\n        preview_label.setStyleSheet(\"font-size: 14px; font-weight: 600; color: white;\")\r\n        right_layout.addWidget(preview_label)\r\n        \r\n        preview_frame = QFrame()\r\n        preview_frame.setObjectName(\"previewFrame\")\r\n        preview_frame_layout = QVBoxLayout(preview_frame)\r\n        preview_frame_layout.setContentsMargins(20, 20, 20, 20)\r\n        \r\n        self.face_preview = QLabel()\r\n        self.face_preview.setAlignment(Qt.AlignCenter)\r\n        self.face_preview.setMinimumSize(400, 300)\r\n        self.face_preview.setStyleSheet(\"\"\"\r\n            QLabel {\r\n                background-color: rgba(0, 0, 0, 0.2);\r\n                border-radius: 8px;\r\n                padding: 20px;\r\n            }\r\n        \"\"\")\r\n        \r\n        placeholder_text = \"Selecciona un rostro o importa una imagen\"\r\n        self.face_preview.setText(placeholder_text)\r\n        self.face_preview.setStyleSheet(\"\"\"\r\n            QLabel {\r\n                color: rgba(255, 255, 255, 0.4);\r\n                font-size: 14px;\r\n            }\r\n        \"\"\")\r\n        \r\n        preview_frame_layout.addWidget(self.face_preview)\r\n        right_layout.addWidget(preview_frame)\r\n        \r\n        # InformaciÃ³n del rostro - Scroll area para formulario largo\r\n        scroll_area = QScrollArea()\r\n        scroll_area.setWidgetResizable(True)\r\n        scroll_area.setStyleSheet(\"QScrollArea { background-color: transparent; border: none; }\")\r\n        \r\n        info_widget = QFrame()\r\n        info_widget.setStyleSheet(\"\"\"\r\n            QFrame {\r\n                background-color: rgba(255, 255, 255, 0.05);\r\n                border-radius: 8px;\r\n                padding: 12px;\r\n            }\r\n        \"\"\")\r\n        info_layout = QVBoxLayout(info_widget)\r\n        info_layout.setSpacing(8)\r\n        \r\n        # Nombre\r\n        name_label = QLabel(\"Nombre:\")\r\n        name_label.setStyleSheet(\"font-weight: 600; color: white;\")\r\n        info_layout.addWidget(name_label)\r\n        \r\n        self.name_input = QLineEdit()\r\n        self.name_input.setPlaceholderText(\"Ingresa el nombre de la persona...\")\r\n        info_layout.addWidget(self.name_input)\r\n        \r\n        # Apellido\r\n        surname_label = QLabel(\"Apellido:\")\r\n        surname_label.setStyleSheet(\"font-weight: 600; color: white;\")\r\n        info_layout.addWidget(surname_label)\r\n        \r\n        self.surname_input = QLineEdit()\r\n        self.surname_input.setPlaceholderText(\"Ingresa el apellido...\")\r\n        info_layout.addWidget(self.surname_input)\r\n        \r\n        # Edad\r\n        age_label = QLabel(\"Edad:\")\r\n        age_label.setStyleSheet(\"font-weight: 600; color: white;\")\r\n        info_layout.addWidget(age_label)\r\n        \r\n        self.age_input = QSpinBox()\r\n        self.age_input.setRange(0, 120)\r\n        info_layout.addWidget(self.age_input)\r\n        \r\n        # CÃ©dula\r\n        cedula_label = QLabel(\"CÃ©dula:\")\r\n        cedula_label.setStyleSheet(\"font-weight: 600; color: white;\")\r\n        info_layout.addWidget(cedula_label)\r\n        \r\n        self.cedula_input = QLineEdit()\r\n        self.cedula_input.setPlaceholderText(\"NÃºmero de cÃ©dula...\")\r\n        info_layout.addWidget(self.cedula_input)\r\n        \r\n        # Fecha de Nacimiento\r\n        birth_label = QLabel(\"Fecha de Nacimiento:\")\r\n        birth_label.setStyleSheet(\"font-weight: 600; color: white;\")\r\n        info_layout.addWidget(birth_label)\r\n        \r\n        self.birth_input = QDateEdit()\r\n        self.birth_input.setCalendarPopup(True)\r\n        self.birth_input.setDate(QDate.currentDate())\r\n        info_layout.addWidget(self.birth_input)\r\n        \r\n        # Delito\r\n        crime_label = QLabel(\"Delito:\")\r\n        crime_label.setStyleSheet(\"font-weight: 600; color: white;\")\r\n        info_layout.addWidget(crime_label)\r\n        \r\n        self.crime_input = QLineEdit()\r\n        self.crime_input.setPlaceholderText(\"DescripciÃ³n del delito...\")\r\n        info_layout.addWidget(self.crime_input)\r\n        \r\n        # NÃºmero de Expediente\r\n        case_label = QLabel(\"NÃºmero de Expediente:\")\r\n        case_label.setStyleSheet(\"font-weight: 600; color: white;\")\r\n        info_layout.addWidget(case_label)\r\n        \r\n        self.case_input = QLineEdit()\r\n        self.case_input.setPlaceholderText(\"NÃºmero de expediente...\")\r\n        info_layout.addWidget(self.case_input)\r\n        \r\n        scroll_area.setWidget(info_widget)\r\n        right_layout.addWidget(scroll_area)\r\n        \r\n        # Botones de acciÃ³n\r\n        button_layout = QHBoxLayout()\r\n        button_layout.setSpacing(10)\r\n        \r\n        self.import_btn = QPushButton(\"Importar Imagen\")\r\n        self.import_btn.setObjectName(\"importButton\")\r\n        self.import_btn.clicked.connect(self.import_image)\r\n        button_layout.addWidget(self.import_btn)\r\n        \r\n        self.add_btn = QPushButton(\"Agregar Rostro\")\r\n        self.add_btn.clicked.connect(self.add_face)\r\n        button_layout.addWidget(self.add_btn)\r\n        \r\n        right_layout.addLayout(button_layout)\r\n        \r\n        button_layout2 = QHBoxLayout()\r\n        button_layout2.setSpacing(10)\r\n        \r\n        self.update_btn = QPushButton(\"Actualizar\")\r\n        self.update_btn.clicked.connect(self.update_face)\r\n        button_layout2.addWidget(self.update_btn)\r\n        \r\n        self.delete_btn = QPushButton(\"Eliminar\")\r\n        self.delete_btn.setObjectName(\"deleteButton\")\r\n        self.delete_btn.clicked.connect(self.delete_face)\r\n        button_layout2.addWidget(self.delete_btn)\r\n        \r\n        right_layout.addLayout(button_layout2)\r\n        \r\n        splitter.addWidget(right_panel)\r\n        \r\n        # Proporciones del splitter\r\n        splitter.setStretchFactor(0, 1)\r\n        splitter.setStretchFactor(1, 2)\r\n        \r\n        layout.addWidget(splitter)\r\n        \r\n        # BotÃ³n cerrar\r\n        close_layout = QHBoxLayout()\r\n        close_layout.addStretch()\r\n        \r\n        self.close_btn = QPushButton(\"Cerrar\")\r\n        self.close_btn.clicked.connect(self.close)\r\n        self.close_btn.setMinimumWidth(150)\r\n        close_layout.addWidget(self.close_btn)\r\n        \r\n        layout.addLayout(close_layout)\r\n        \r\n        self.setLayout(layout)\r\n        \r\n    def load_face_list(self):\r\n        \"\"\"Cargar lista de rostros desde la base de datos\"\"\"\r\n        self.face_list.clear()\r\n        \r\n        try:\r\n            known_faces = self.database.get_known_faces()\r\n            \r\n            for face_data in known_faces:\r\n                display_text = f\"ðŸ‘¤ {face_data['name']} {face_data['lastname']} - CÃ©dula: {face_data['cedula']}\"\r\n                item = QListWidgetItem(display_text)\r\n                item.setData(Qt.UserRole, face_data)\r\n                self.face_list.addItem(item)\r\n            \r\n            count = len(known_faces)\r\n            self.face_count_label.setText(f\"{count} rostro{'s' if count != 1 else ''} registrado{'s' if count != 1 else ''}\")\r\n            \r\n            logger.info(f\"Loaded {count} faces from database\")\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error loading faces from database: {e}\")\r\n            self.show_message(\"Error\", f\"Error al cargar rostros: {str(e)}\", QMessageBox.Critical)\r\n        \r\n    def on_face_selected(self, current, previous):\r\n        \"\"\"Manejar selecciÃ³n de rostro\"\"\"\r\n        if current is None:\r\n            self.face_preview.clear()\r\n            self.face_preview.setText(\"Selecciona un rostro o importa una imagen\")\r\n            self.clear_all_fields()\r\n            self.selected_face_data = None\r\n            return\r\n        \r\n        try:\r\n            face_data = current.data(Qt.UserRole)\r\n            self.selected_face_data = face_data\r\n            \r\n            # Llenar campos\r\n            self.name_input.setText(face_data['name'])\r\n            self.surname_input.setText(face_data['lastname'])\r\n            self.age_input.setValue(face_data['age'])\r\n            self.cedula_input.setText(face_data['cedula'])\r\n            \r\n            birth_date = QDate.fromString(face_data['birth_date'], \"yyyy-MM-dd\")\r\n            if birth_date.isValid():\r\n                self.birth_input.setDate(birth_date)\r\n            \r\n            self.crime_input.setText(face_data['crime'])\r\n            self.case_input.setText(face_data['case_number'])\r\n            \r\n            # Cargar y mostrar imagen\r\n            face_path = Path(face_data['image_path'])\r\n            if not face_path.exists():\r\n                self.face_preview.setText(\"ðŸ“· Archivo de imagen no encontrado\")\r\n                return\r\n            \r\n            image = cv2.imread(str(face_path))\r\n            if image is None:\r\n                self.face_preview.setText(\"âŒ Error al cargar la imagen\")\r\n                return\r\n            \r\n            self.current_image = image\r\n            pixmap = numpy_to_pixmap(image)\r\n            \r\n            scaled_pixmap = pixmap.scaled(\r\n                self.face_preview.width() - 40,\r\n                self.face_preview.height() - 40,\r\n                Qt.KeepAspectRatio,\r\n                Qt.SmoothTransformation\r\n            )\r\n            \r\n            self.face_preview.setPixmap(scaled_pixmap)\r\n            self.face_preview.setStyleSheet(\"\"\"\r\n                QLabel {\r\n                    background-color: rgba(0, 0, 0, 0.2);\r\n                    border-radius: 8px;\r\n                }\r\n            \"\"\")\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error loading face data: {e}\")\r\n            self.show_message(\"Error\", f\"Error al cargar datos del rostro: {str(e)}\", QMessageBox.Critical)\r\n    \r\n    def add_face(self):\r\n        \"\"\"Agregar nuevo rostro\"\"\"\r\n        name = self.name_input.text().strip()\r\n        surname = self.surname_input.text().strip()\r\n        age = self.age_input.value()\r\n        cedula = self.cedula_input.text().strip()\r\n        birth_date = self.birth_input.date().toString(\"yyyy-MM-dd\")\r\n        crime = self.crime_input.text().strip()\r\n        case_number = self.case_input.text().strip()\r\n        \r\n        # Validaciones\r\n        if not name:\r\n            self.show_message(\"Error\", \"Por favor ingresa un nombre\", QMessageBox.Warning)\r\n            return\r\n        \r\n        if not surname:\r\n            self.show_message(\"Error\", \"Por favor ingresa un apellido\", QMessageBox.Warning)\r\n            return\r\n        \r\n        if not cedula:\r\n            self.show_message(\"Error\", \"La cÃ©dula es obligatoria\", QMessageBox.Warning)\r\n            return\r\n        \r\n        if self.current_image is None:\r\n            self.show_message(\"Error\", \"Por favor importa o selecciona una imagen primero\", QMessageBox.Warning)\r\n            return\r\n        \r\n        # Verificar si la cÃ©dula ya existe\r\n        existing_faces = self.database.get_known_faces()\r\n        for face in existing_faces:\r\n            if face['cedula'] == cedula:\r\n                self.show_message(\"Error\", f\"Ya existe un rostro con la cÃ©dula '{cedula}'\", QMessageBox.Warning)\r\n                return\r\n        \r\n        # Agregar el rostro\r\n        user = self.auth_manager.get_current_user()\r\n        success = self.face_detector.add_known_face(\r\n            self.current_image, name, surname, age, cedula,\r\n            birth_date, crime, case_number,\r\n            self.known_faces_dir, self.database,\r\n            created_by=user.id if user else None\r\n        )\r\n        \r\n        if success:\r\n            self.show_message(\"Ã‰xito\", \r\n                             f\"Rostro de {name} {surname} agregado correctamente\", \r\n                             QMessageBox.Information)\r\n            self.clear_all_fields()\r\n            self.load_face_list()\r\n        else:\r\n            self.show_message(\"Error\", \"No se pudo agregar el rostro\", QMessageBox.Critical)\r\n    \r\n    def update_face(self):\r\n        \"\"\"Actualizar rostro existente\"\"\"\r\n        if not self.selected_face_data:\r\n            self.show_message(\"Error\", \"Por favor selecciona un rostro para actualizar\", QMessageBox.Warning)\r\n            return\r\n        \r\n        name = self.name_input.text().strip()\r\n        surname = self.surname_input.text().strip()\r\n        age = self.age_input.value()\r\n        cedula = self.cedula_input.text().strip()\r\n        birth_date = self.birth_input.date().toString(\"yyyy-MM-dd\")\r\n        crime = self.crime_input.text().strip()\r\n        case_number = self.case_input.text().strip()\r\n        \r\n        if not name or not surname:\r\n            self.show_message(\"Error\", \"Nombre y apellido son obligatorios\", QMessageBox.Warning)\r\n            return\r\n        \r\n        try:\r\n            import sqlite3\r\n            \r\n            # CORRECCIÃ“N: Usar el path correcto de la base de datos\r\n            conn = sqlite3.connect(str(self.database.db_path))\r\n            cursor = conn.cursor()\r\n            \r\n            # Actualizar el registro\r\n            cursor.execute('''\r\n                UPDATE known_faces \r\n                SET name=?, lastname=?, age=?, birth_date=?, crime=?, case_number=?\r\n                WHERE cedula=?\r\n            ''', (name, surname, age, birth_date, crime, case_number, cedula))\r\n            \r\n            affected_rows = cursor.rowcount\r\n            conn.commit()\r\n            conn.close()\r\n            \r\n            if affected_rows > 0:\r\n                # Recargar rostros en el detector\r\n                self.face_detector.load_known_faces_from_db(self.database)\r\n                \r\n                self.show_message(\"Ã‰xito\", \"Rostro actualizado correctamente\", QMessageBox.Information)\r\n                self.load_face_list()\r\n            else:\r\n                self.show_message(\"Error\", \"No se encontrÃ³ el rostro para actualizar\", QMessageBox.Warning)\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error updating face: {e}\")\r\n            self.show_message(\"Error\", f\"Error al actualizar: {str(e)}\", QMessageBox.Critical)\r\n           \r\n\r\n    def delete_face(self):\r\n        \"\"\"Eliminar rostro\"\"\"\r\n        if not self.selected_face_data:\r\n            self.show_message(\"Error\", \"Por favor selecciona un rostro para eliminar\", QMessageBox.Warning)\r\n            return\r\n        \r\n        cedula = self.selected_face_data['cedula']\r\n        name = f\"{self.selected_face_data['name']} {self.selected_face_data['lastname']}\"\r\n        \r\n        reply = self.show_question(\r\n            \"Confirmar EliminaciÃ³n\",\r\n            f\"Â¿EstÃ¡s seguro de que deseas eliminar el rostro de {name}?\",\r\n            \"Esta acciÃ³n no se puede deshacer.\"\r\n        )\r\n        \r\n        if reply == QMessageBox.No:\r\n            return\r\n        \r\n        try:\r\n            user = self.auth_manager.get_current_user()\r\n            success = self.database.delete_known_face(\r\n                cedula,\r\n                deleted_by=user.id if user else None\r\n            )\r\n            \r\n            if success:\r\n                self.face_detector.load_known_faces_from_db(self.database)\r\n                self.load_face_list()\r\n                self.clear_all_fields()\r\n                \r\n                self.show_message(\"Ã‰xito\", \"Rostro eliminado correctamente\", QMessageBox.Information)\r\n            else:\r\n                self.show_message(\"Error\", \"No se pudo eliminar el rostro\", QMessageBox.Critical)\r\n                \r\n        except Exception as e:\r\n            logger.error(f\"Error deleting face: {e}\")\r\n            self.show_message(\"Error\", f\"Error al eliminar: {str(e)}\", QMessageBox.Critical)\r\n    \r\n    def import_image(self):\r\n        \"\"\"Importar imagen desde archivo\"\"\"\r\n        file_path, _ = QFileDialog.getOpenFileName(\r\n            self, \"Seleccionar Imagen\", \"\",\r\n            \"Archivos de Imagen (*.jpg *.jpeg *.png *.bmp)\")\r\n        \r\n        if not file_path:\r\n            return\r\n        \r\n        try:\r\n            image = cv2.imread(file_path)\r\n            if image is None:\r\n                raise ValueError(\"No se pudo leer la imagen\")\r\n            \r\n            self.current_image = image\r\n            pixmap = numpy_to_pixmap(image)\r\n            \r\n            scaled_pixmap = pixmap.scaled(\r\n                self.face_preview.width() - 40,\r\n                self.face_preview.height() - 40,\r\n                Qt.KeepAspectRatio,\r\n                Qt.SmoothTransformation\r\n            )\r\n            \r\n            self.face_preview.setPixmap(scaled_pixmap)\r\n            self.face_preview.setStyleSheet(\"\"\"\r\n                QLabel {\r\n                    background-color: rgba(0, 0, 0, 0.2);\r\n                    border-radius: 8px;\r\n                }\r\n            \"\"\")\r\n            \r\n        except Exception as e:\r\n            self.show_message(\"Error\", f\"Error al cargar imagen: {str(e)}\", QMessageBox.Critical)\r\n            logger.error(f\"Error importing image: {e}\")\r\n    \r\n    def clear_all_fields(self):\r\n        \"\"\"Limpiar todos los campos del formulario\"\"\"\r\n        self.name_input.clear()\r\n        self.surname_input.clear()\r\n        self.age_input.setValue(0)\r\n        self.cedula_input.clear()\r\n        self.birth_input.setDate(QDate.currentDate())\r\n        self.crime_input.clear()\r\n        self.case_input.clear()\r\n        self.face_preview.clear()\r\n        self.face_preview.setText(\"Selecciona un rostro o importa una imagen\")\r\n        self.current_image = None\r\n        self.selected_face_data = None\r\n    \r\n    def show_message(self, title, text, icon):\r\n        \"\"\"Mostrar mensaje con estilo\"\"\"\r\n        msg = QMessageBox(self)\r\n        msg.setIcon(icon)\r\n        msg.setWindowTitle(title)\r\n        msg.setText(text)\r\n        msg.setStyleSheet(\"\"\"\r\n            QMessageBox {\r\n                background-color: #2d2d3d;\r\n            }\r\n            QMessageBox QLabel {\r\n                color: white;\r\n                font-size: 13px;\r\n            }\r\n            QPushButton {\r\n                background-color: rgba(0, 120, 212, 0.8);\r\n                color: white;\r\n                border: none;\r\n                border-radius: 4px;\r\n                padding: 8px 20px;\r\n                min-width: 80px;\r\n            }\r\n            QPushButton:hover {\r\n                background-color: rgba(0, 120, 212, 1);\r\n            }\r\n        \"\"\")\r\n        msg.exec_()\r\n    \r\n    def show_question(self, title, text, informative_text):\r\n        \"\"\"Mostrar diÃ¡logo de confirmaciÃ³n\"\"\"\r\n        msg = QMessageBox(self)\r\n        msg.setIcon(QMessageBox.Question)\r\n        msg.setWindowTitle(title)\r\n        msg.setText(text)\r\n        msg.setInformativeText(informative_text)\r\n        msg.setStandardButtons(QMessageBox.Yes | QMessageBox.No)\r\n        msg.setDefaultButton(QMessageBox.No)\r\n        msg.setStyleSheet(\"\"\"\r\n            QMessageBox {\r\n                background-color: #2d2d3d;\r\n            }\r\n            QMessageBox QLabel {\r\n                color: white;\r\n                font-size: 13px;\r\n            }\r\n            QPushButton {\r\n                background-color: rgba(0, 120, 212, 0.8);\r\n                color: white;\r\n                border: none;\r\n                border-radius: 4px;\r\n                padding: 8px 20px;\r\n                min-width: 80px;\r\n            }\r\n            QPushButton:hover {\r\n                background-color: rgba(0, 120, 212, 1);\r\n            }\r\n        \"\"\")\r\n        return msg.exec_()",
    "history_viewer.py": "from pathlib import Path\r\nfrom PyQt5.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout, QListWidget, QPushButton,\r\n                            QLabel, QDateEdit, QComboBox, QSpacerItem, QSizePolicy,\r\n                            QSplitter, QFrame, QMessageBox, QDialog)\r\nfrom PyQt5.QtCore import Qt, QDate, QDateTime\r\nfrom PyQt5.QtGui import QPixmap\r\nfrom loguru import logger\r\nimport time\r\nfrom datetime import datetime, timedelta\r\nfrom typing import List, Optional\r\nimport cv2\r\n\r\nfrom core.database import FaceDatabase, FaceLogEntry\r\nfrom core.utils import numpy_to_pixmap\r\n\r\nclass HistoryViewer(QWidget):\r\n    def __init__(self, database, config):\r\n        \"\"\"Initialize the HistoryViewer with database and configuration, set up UI and load initial data.\"\"\"\r\n        super().__init__()\r\n        self.database = database\r\n        self.config = config\r\n        self.current_entry = None\r\n        \r\n        self.setup_ui()\r\n        self.load_camera_list()\r\n        self.load_face_list()\r\n        \r\n        # Cargar historial despuÃ©s de que todo estÃ© configurado\r\n        logger.info(\"Initializing HistoryViewer and loading history...\")\r\n        self.refresh_history()\r\n        \r\n    def setup_ui(self):\r\n        \"\"\"Set up all UI components including filters, list view, and detail view for history entries.\"\"\"\r\n        main_layout = QVBoxLayout()\r\n        main_layout.setContentsMargins(32, 32, 32, 32)\r\n        main_layout.setSpacing(20)\r\n        \r\n        # TÃ­tulo\r\n        title = QLabel(\"ðŸ“Š Historial de Detecciones\")\r\n        title.setStyleSheet(\"\"\"\r\n            font-size: 28px;\r\n            font-weight: bold;\r\n            color: white;\r\n            margin-bottom: 16px;\r\n        \"\"\")\r\n        main_layout.addWidget(title)\r\n        \r\n        # Filter controls en una tarjeta\r\n        filter_frame = QFrame()\r\n        filter_frame.setStyleSheet(\"\"\"\r\n            QFrame {\r\n                background-color: rgba(255, 255, 255, 0.05);\r\n                border: 1px solid rgba(255, 255, 255, 0.1);\r\n                border-radius: 12px;\r\n                padding: 16px;\r\n            }\r\n        \"\"\")\r\n        filter_layout = QHBoxLayout(filter_frame)\r\n        filter_layout.setSpacing(16)\r\n        \r\n        # Date range filters\r\n        date_group = QFrame()\r\n        date_layout = QVBoxLayout(date_group)\r\n        date_layout.setSpacing(8)\r\n        \r\n        date_label = QLabel(\"ðŸ“… Rango de Fechas:\")\r\n        date_label.setStyleSheet(\"color: white; font-weight: 600; font-size: 13px;\")\r\n        date_layout.addWidget(date_label)\r\n        \r\n        date_range_layout = QHBoxLayout()\r\n        \r\n        self.start_date = QDateEdit()\r\n        self.start_date.setDate(QDate.currentDate().addDays(-7))\r\n        self.start_date.setCalendarPopup(True)\r\n        self.start_date.setDisplayFormat(\"yyyy-MM-dd\")\r\n        self.start_date.setStyleSheet(\"\"\"\r\n            QDateEdit {\r\n                background-color: rgba(255, 255, 255, 0.08);\r\n                color: white;\r\n                border: 1px solid rgba(255, 255, 255, 0.15);\r\n                border-radius: 6px;\r\n                padding: 8px;\r\n                min-width: 120px;\r\n            }\r\n        \"\"\")\r\n        date_range_layout.addWidget(self.start_date)\r\n        \r\n        date_range_layout.addWidget(QLabel(\"â†’\"))\r\n        \r\n        self.end_date = QDateEdit()\r\n        self.end_date.setDate(QDate.currentDate())\r\n        self.end_date.setCalendarPopup(True)\r\n        self.end_date.setDisplayFormat(\"yyyy-MM-dd\")\r\n        self.end_date.setStyleSheet(self.start_date.styleSheet())\r\n        date_range_layout.addWidget(self.end_date)\r\n        \r\n        date_layout.addLayout(date_range_layout)\r\n        filter_layout.addWidget(date_group)\r\n        \r\n        # Camera filter\r\n        camera_group = QFrame()\r\n        camera_layout = QVBoxLayout(camera_group)\r\n        camera_layout.setSpacing(8)\r\n        \r\n        camera_label = QLabel(\"ðŸ“¹ CÃ¡mara:\")\r\n        camera_label.setStyleSheet(\"color: white; font-weight: 600; font-size: 13px;\")\r\n        camera_layout.addWidget(camera_label)\r\n        \r\n        self.camera_combo = QComboBox()\r\n        self.camera_combo.addItem(\"Todas las CÃ¡maras\", None)\r\n        self.camera_combo.setStyleSheet(\"\"\"\r\n            QComboBox {\r\n                background-color: rgba(255, 255, 255, 0.08);\r\n                color: white;\r\n                border: 1px solid rgba(255, 255, 255, 0.15);\r\n                border-radius: 6px;\r\n                padding: 8px;\r\n                min-width: 150px;\r\n            }\r\n        \"\"\")\r\n        camera_layout.addWidget(self.camera_combo)\r\n        filter_layout.addWidget(camera_group)\r\n        \r\n        # Face filter\r\n        face_group = QFrame()\r\n        face_layout = QVBoxLayout(face_group)\r\n        face_layout.setSpacing(8)\r\n        \r\n        face_label = QLabel(\"ðŸ‘¤ Persona:\")\r\n        face_label.setStyleSheet(\"color: white; font-weight: 600; font-size: 13px;\")\r\n        face_layout.addWidget(face_label)\r\n        \r\n        self.face_combo = QComboBox()\r\n        self.face_combo.addItem(\"Todas las Personas\", None)\r\n        self.face_combo.setStyleSheet(self.camera_combo.styleSheet())\r\n        face_layout.addWidget(self.face_combo)\r\n        filter_layout.addWidget(face_group)\r\n        \r\n        # Refresh button\r\n        self.refresh_btn = QPushButton(\"ðŸ”„ Actualizar\")\r\n        self.refresh_btn.clicked.connect(self.refresh_history)\r\n        self.refresh_btn.setStyleSheet(\"\"\"\r\n            QPushButton {\r\n                background-color: rgba(0, 120, 212, 0.8);\r\n                color: white;\r\n                border: none;\r\n                border-radius: 6px;\r\n                padding: 10px 20px;\r\n                font-size: 13px;\r\n                font-weight: 500;\r\n                min-width: 120px;\r\n            }\r\n            QPushButton:hover {\r\n                background-color: rgba(0, 120, 212, 1);\r\n            }\r\n        \"\"\")\r\n        filter_layout.addWidget(self.refresh_btn, 0, Qt.AlignBottom)\r\n        \r\n        filter_layout.addStretch()\r\n        main_layout.addWidget(filter_frame)\r\n        \r\n        # Contador de resultados\r\n        self.count_label = QLabel(\"Cargando...\")\r\n        self.count_label.setStyleSheet(\"color: rgba(255, 255, 255, 0.7); font-size: 13px; margin: 8px 0;\")\r\n        main_layout.addWidget(self.count_label)\r\n        \r\n        # Splitter for history list and details\r\n        splitter = QSplitter(Qt.Horizontal)\r\n        \r\n        # History list en una tarjeta\r\n        list_frame = QFrame()\r\n        list_frame.setStyleSheet(\"\"\"\r\n            QFrame {\r\n                background-color: rgba(255, 255, 255, 0.05);\r\n                border: 1px solid rgba(255, 255, 255, 0.1);\r\n                border-radius: 12px;\r\n                padding: 16px;\r\n            }\r\n        \"\"\")\r\n        list_layout = QVBoxLayout(list_frame)\r\n        \r\n        list_title = QLabel(\"ðŸ“‹ Registros\")\r\n        list_title.setStyleSheet(\"color: white; font-weight: 600; font-size: 14px; margin-bottom: 8px;\")\r\n        list_layout.addWidget(list_title)\r\n        \r\n        self.history_list = QListWidget()\r\n        self.history_list.setStyleSheet(\"\"\"\r\n            QListWidget {\r\n                background-color: rgba(0, 0, 0, 0.2);\r\n                border: 1px solid rgba(255, 255, 255, 0.1);\r\n                border-radius: 8px;\r\n                color: white;\r\n                padding: 4px;\r\n            }\r\n            QListWidget::item {\r\n                padding: 12px;\r\n                border-radius: 6px;\r\n                margin: 2px 0;\r\n            }\r\n            QListWidget::item:hover {\r\n                background-color: rgba(255, 255, 255, 0.05);\r\n            }\r\n            QListWidget::item:selected {\r\n                background-color: rgba(0, 120, 212, 0.3);\r\n                border: 1px solid rgba(0, 120, 212, 0.5);\r\n            }\r\n        \"\"\")\r\n        self.history_list.currentItemChanged.connect(self.on_history_item_selected)\r\n        list_layout.addWidget(self.history_list)\r\n        \r\n        splitter.addWidget(list_frame)\r\n        \r\n        # Details panel\r\n        details_frame = QFrame()\r\n        details_frame.setStyleSheet(list_frame.styleSheet())\r\n        details_layout = QVBoxLayout(details_frame)\r\n        \r\n        details_title = QLabel(\"ðŸ” Detalles\")\r\n        details_title.setStyleSheet(\"color: white; font-weight: 600; font-size: 14px; margin-bottom: 8px;\")\r\n        details_layout.addWidget(details_title)\r\n        \r\n        # Image display\r\n        self.image_label = QLabel(\"Selecciona un registro para ver detalles\")\r\n        self.image_label.setAlignment(Qt.AlignCenter)\r\n        self.image_label.setMinimumSize(400, 300)\r\n        self.image_label.setStyleSheet(\"\"\"\r\n            QLabel {\r\n                background-color: rgba(0, 0, 0, 0.3);\r\n                border-radius: 8px;\r\n                padding: 20px;\r\n                color: rgba(255, 255, 255, 0.5);\r\n            }\r\n        \"\"\")\r\n        details_layout.addWidget(self.image_label)\r\n        \r\n        # Details text\r\n        self.details_label = QLabel()\r\n        self.details_label.setWordWrap(True)\r\n        self.details_label.setStyleSheet(\"\"\"\r\n            QLabel {\r\n                color: white;\r\n                background-color: rgba(0, 0, 0, 0.2);\r\n                border-radius: 8px;\r\n                padding: 12px;\r\n                font-size: 13px;\r\n                line-height: 1.6;\r\n            }\r\n        \"\"\")\r\n        details_layout.addWidget(self.details_label)\r\n        \r\n        # Screenshot button\r\n        self.view_screenshot_btn = QPushButton(\"ðŸ“· Ver Captura Completa\")\r\n        self.view_screenshot_btn.clicked.connect(self.view_screenshot)\r\n        self.view_screenshot_btn.setEnabled(False)\r\n        self.view_screenshot_btn.setStyleSheet(\"\"\"\r\n            QPushButton {\r\n                background-color: rgba(40, 167, 69, 0.8);\r\n                color: white;\r\n                border: none;\r\n                border-radius: 6px;\r\n                padding: 10px 20px;\r\n                font-size: 13px;\r\n            }\r\n            QPushButton:hover {\r\n                background-color: rgba(40, 167, 69, 1);\r\n            }\r\n            QPushButton:disabled {\r\n                background-color: rgba(40, 167, 69, 0.3);\r\n                color: rgba(255, 255, 255, 0.4);\r\n            }\r\n        \"\"\")\r\n        details_layout.addWidget(self.view_screenshot_btn)\r\n        \r\n        splitter.addWidget(details_frame)\r\n        \r\n        splitter.setStretchFactor(0, 1)\r\n        splitter.setStretchFactor(1, 1)\r\n        main_layout.addWidget(splitter)\r\n        \r\n        self.setLayout(main_layout)\r\n        \r\n    def load_camera_list(self):\r\n        \"\"\"Load the list of available cameras from the configuration file into the camera filter dropdown.\"\"\"\r\n        try:\r\n            with open('config/camera_config.yaml', 'r') as f:\r\n                import yaml\r\n                config = yaml.safe_load(f)\r\n                \r\n            for camera in config.get('cameras', []):\r\n                self.camera_combo.addItem(\r\n                    f\"CÃ¡mara {camera['id']}: {camera.get('name', '')}\",\r\n                    camera['id']\r\n                )\r\n            logger.info(f\"Loaded {self.camera_combo.count() - 1} cameras into filter\")\r\n                \r\n        except Exception as e:\r\n            logger.error(f\"Error loading camera config: {e}\")\r\n            \r\n    def load_face_list(self):\r\n        \"\"\"Load the list of known faces from the database into the face filter dropdown.\"\"\"\r\n        try:\r\n            known_faces = self.database.get_known_faces()\r\n            for face in known_faces:\r\n                self.face_combo.addItem(face['name'], face['name'])\r\n            logger.info(f\"Loaded {len(known_faces)} known faces into filter\")\r\n                \r\n        except Exception as e:\r\n            logger.error(f\"Error loading known faces: {e}\")\r\n\r\n    def refresh_history(self):\r\n        \"\"\"Fetch and display filtered history entries from the database in the history list.\"\"\"\r\n        try:\r\n            logger.info(\"Refreshing history...\")\r\n            \r\n            # Get filter values\r\n            start_date = self.start_date.date().toPyDate()\r\n            end_date = self.end_date.date().toPyDate() + timedelta(days=1)  # Include entire end day\r\n            \r\n            start_timestamp = datetime.combine(start_date, datetime.min.time()).timestamp()\r\n            end_timestamp = datetime.combine(end_date, datetime.min.time()).timestamp()\r\n            \r\n            camera_id = self.camera_combo.currentData()\r\n            face_name = self.face_combo.currentData()\r\n            \r\n            logger.info(f\"Filters - Start: {start_date}, End: {end_date}, Camera: {camera_id}, Face: {face_name}\")\r\n            \r\n            # Get filtered history\r\n            entries = self.database.get_face_logs(\r\n                limit=1000,\r\n                camera_id=camera_id,\r\n                face_name=face_name,\r\n                start_time=start_timestamp,\r\n                end_time=end_timestamp\r\n            )\r\n            \r\n            logger.info(f\"Retrieved {len(entries)} entries from database\")\r\n            \r\n            # Populate list\r\n            self.history_list.clear()\r\n            \r\n            if not entries:\r\n                self.count_label.setText(\"âŒ No se encontraron registros con los filtros seleccionados\")\r\n                self.history_list.addItem(\"No hay registros para mostrar\")\r\n                return\r\n            \r\n            for entry in entries:\r\n                try:\r\n                    # Convertir timestamp a datetime de manera segura\r\n                    if isinstance(entry.timestamp, (bytes, str)):\r\n                        timestamp = float(entry.timestamp)\r\n                    else:\r\n                        timestamp = entry.timestamp\r\n                    \r\n                    time_str = datetime.fromtimestamp(timestamp).strftime(\"%Y-%m-%d %H:%M:%S\")\r\n                    \r\n                    # Formato mejorado del item\r\n                    confidence_pct = entry.confidence * 100 if entry.confidence <= 1 else entry.confidence\r\n                    item_text = f\"ðŸ•’ {time_str} | ðŸ‘¤ {entry.face_name} | ðŸ“¹ {entry.camera_name} | ðŸŽ¯ {confidence_pct:.1f}%\"\r\n                    \r\n                    item = self.history_list.addItem(item_text)\r\n                    self.history_list.item(self.history_list.count() - 1).setData(Qt.UserRole, entry)\r\n                    \r\n                except Exception as e:\r\n                    logger.error(f\"Error processing history entry: {e}\")\r\n                    logger.error(f\"Entry data: {entry}\")\r\n                    continue\r\n            \r\n            self.count_label.setText(f\"âœ… Se encontraron {len(entries)} registro(s)\")\r\n            logger.info(f\"Successfully loaded {len(entries)} entries into list\")\r\n                    \r\n        except Exception as e:\r\n            logger.error(f\"Error refreshing history: {e}\", exc_info=True)\r\n            self.count_label.setText(f\"âŒ Error al cargar historial: {str(e)}\")\r\n            QMessageBox.critical(\r\n                self,\r\n                \"Error\",\r\n                f\"No se pudo cargar el historial:\\n\\n{str(e)}\\n\\nRevisa los logs para mÃ¡s detalles.\"\r\n            )\r\n\r\n    def on_history_item_selected(self, current, previous):\r\n        \"\"\"Handle display of detailed information when a history list item is selected.\"\"\"\r\n        try:\r\n            if current is None:\r\n                self.current_entry = None\r\n                self.image_label.clear()\r\n                self.image_label.setText(\"Selecciona un registro para ver detalles\")\r\n                self.details_label.clear()\r\n                self.view_screenshot_btn.setEnabled(False)\r\n                return\r\n                \r\n            entry = current.data(Qt.UserRole)\r\n            if not isinstance(entry, FaceLogEntry):\r\n                logger.warning(f\"Invalid entry type: {type(entry)}\")\r\n                return\r\n                \r\n            self.current_entry = entry\r\n            \r\n            # Safely format the timestamp\r\n            try:\r\n                timestamp = float(entry.timestamp) if isinstance(entry.timestamp, (bytes, str)) else entry.timestamp\r\n                time_str = datetime.fromtimestamp(timestamp).strftime(\"%Y-%m-%d %H:%M:%S\")\r\n            except (TypeError, ValueError) as e:\r\n                logger.warning(f\"Invalid timestamp format: {entry.timestamp}\")\r\n                time_str = \"Hora desconocida\"\r\n            \r\n            # Safely format confidence\r\n            try:\r\n                confidence = float(entry.confidence)\r\n                confidence_pct = confidence * 100 if confidence <= 1 else confidence\r\n                confidence_str = f\"{confidence_pct:.1f}%\"\r\n            except (TypeError, ValueError):\r\n                confidence_str = \"N/A\"\r\n            \r\n            # Display details with better formatting\r\n            details_text = f\"\"\"\r\n            <div style='line-height: 1.8;'>\r\n                <p><b>ðŸ•’ Fecha y Hora:</b> {time_str}</p>\r\n                <p><b>ðŸ“¹ CÃ¡mara:</b> {entry.camera_name} (ID: {entry.camera_id})</p>\r\n                <p><b>ðŸ‘¤ Persona:</b> {entry.face_name}</p>\r\n                <p><b>ðŸŽ¯ Confianza:</b> {confidence_str}</p>\r\n                <p><b>ðŸ‘¶ Edad Estimada:</b> {entry.age if entry.age else 'No disponible'}</p>\r\n                <p><b>ðŸš» GÃ©nero:</b> {entry.gender if entry.gender else 'No disponible'}</p>\r\n            </div>\r\n            \"\"\"\r\n            self.details_label.setText(details_text)\r\n            \r\n            # Load and display thumbnail if screenshot exists\r\n            if entry.screenshot_path and len(str(entry.screenshot_path)) > 0:\r\n                screenshot_path = Path(entry.screenshot_path)\r\n                if screenshot_path.exists():\r\n                    try:\r\n                        image = cv2.imread(str(screenshot_path))\r\n                        if image is not None:\r\n                            pixmap = numpy_to_pixmap(image)\r\n                            scaled_pixmap = pixmap.scaled(\r\n                                self.image_label.width() - 40,\r\n                                self.image_label.height() - 40,\r\n                                Qt.KeepAspectRatio,\r\n                                Qt.SmoothTransformation\r\n                            )\r\n                            self.image_label.setPixmap(scaled_pixmap)\r\n                            self.image_label.setStyleSheet(\"\"\"\r\n                                QLabel {\r\n                                    background-color: rgba(0, 0, 0, 0.3);\r\n                                    border-radius: 8px;\r\n                                }\r\n                            \"\"\")\r\n                            self.view_screenshot_btn.setEnabled(True)\r\n                        else:\r\n                            raise ValueError(\"Could not load image\")\r\n                    except Exception as e:\r\n                        logger.error(f\"Error loading thumbnail: {e}\")\r\n                        self.image_label.setText(\"âŒ Error al cargar imagen\")\r\n                        self.view_screenshot_btn.setEnabled(False)\r\n                else:\r\n                    self.image_label.setText(\"ðŸ“· Captura no encontrada\")\r\n                    self.view_screenshot_btn.setEnabled(False)\r\n            else:\r\n                self.image_label.setText(\"ðŸ“· Sin captura disponible\")\r\n                self.view_screenshot_btn.setEnabled(False)\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error displaying history item: {e}\", exc_info=True)\r\n            self.details_label.setText(f\"<p style='color: #ff6b6b;'>Error al cargar detalles: {str(e)}</p>\")\r\n            self.view_screenshot_btn.setEnabled(False)\r\n\r\n    def view_screenshot(self):\r\n        \"\"\"Open a dialog to display the screenshot associated with the selected history entry.\"\"\"\r\n        if self.current_entry is None or not self.current_entry.screenshot_path:\r\n            QMessageBox.information(self, \"Sin Captura\", \"No hay captura disponible para este registro\")\r\n            return\r\n            \r\n        try:\r\n            # Check if file exists\r\n            screenshot_path = Path(self.current_entry.screenshot_path)\r\n            if not screenshot_path.exists():\r\n                QMessageBox.warning(self, \"Archivo No Encontrado\", f\"No se encontrÃ³ la captura: {screenshot_path}\")\r\n                return\r\n                \r\n            image = cv2.imread(str(screenshot_path))\r\n            if image is None:\r\n                raise ValueError(\"No se pudo leer la captura\")\r\n                \r\n            pixmap = numpy_to_pixmap(image)\r\n            \r\n            # Create a dialog to show the screenshot\r\n            dialog = QDialog(self)\r\n            dialog.setWindowTitle(\"Captura Completa\")\r\n            dialog.setStyleSheet(\"\"\"\r\n                QDialog {\r\n                    background-color: #1a1a2e;\r\n                }\r\n                QLabel {\r\n                    background-color: rgba(0, 0, 0, 0.5);\r\n                    border-radius: 8px;\r\n                }\r\n            \"\"\")\r\n            layout = QVBoxLayout(dialog)\r\n            layout.setContentsMargins(20, 20, 20, 20)\r\n            \r\n            image_label = QLabel()\r\n            image_label.setAlignment(Qt.AlignCenter)\r\n            image_label.setPixmap(pixmap.scaled(\r\n                1000, 750, Qt.KeepAspectRatio, Qt.SmoothTransformation))\r\n            layout.addWidget(image_label)\r\n            \r\n            close_btn = QPushButton(\"Cerrar\")\r\n            close_btn.setStyleSheet(\"\"\"\r\n                QPushButton {\r\n                    background-color: rgba(0, 120, 212, 0.8);\r\n                    color: white;\r\n                    border: none;\r\n                    border-radius: 6px;\r\n                    padding: 10px 20px;\r\n                    font-size: 13px;\r\n                }\r\n                QPushButton:hover {\r\n                    background-color: rgba(0, 120, 212, 1);\r\n                }\r\n            \"\"\")\r\n            close_btn.clicked.connect(dialog.close)\r\n            layout.addWidget(close_btn)\r\n            \r\n            dialog.resize(1050, 850)\r\n            dialog.exec_()\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error viewing screenshot: {e}\")\r\n            QMessageBox.critical(self, \"Error\", f\"No se pudo cargar la captura:\\n\\n{str(e)}\")",
    "login_window.py": "from PyQt5.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QLabel, QLineEdit,\r\n                            QPushButton, QCheckBox, QFrame, QGraphicsDropShadowEffect,\r\n                            QMessageBox, QWidget)\r\nfrom PyQt5.QtCore import Qt, pyqtSignal, QPropertyAnimation, QEasingCurve, QRect, QPoint\r\nfrom PyQt5.QtGui import QFont, QPixmap, QIcon, QPalette, QColor, QKeyEvent\r\nfrom loguru import logger\r\n\r\nclass LoginWindow(QDialog):\r\n    login_successful = pyqtSignal(object)  # Emits User object on successful login\r\n    \r\n    def __init__(self, auth_manager, config):\r\n        super().__init__()\r\n        self.auth_manager = auth_manager\r\n        self.config = config\r\n        self.setWindowTitle(\"Face Recognition System - Login\")\r\n        self.setFixedSize(450, 680)\r\n        self.setWindowFlags(Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint)\r\n        self.setAttribute(Qt.WA_TranslucentBackground)\r\n        \r\n        self.setup_ui()\r\n        self.setup_animations()\r\n        \r\n    def setup_ui(self):\r\n        \"\"\"Setup modern login UI\"\"\"\r\n        # Main container\r\n        main_layout = QVBoxLayout(self)\r\n        main_layout.setContentsMargins(0, 0, 0, 0)\r\n        \r\n        # Card container\r\n        card = QFrame()\r\n        card.setObjectName(\"loginCard\")\r\n        card.setStyleSheet(\"\"\"\r\n            QFrame#loginCard {\r\n                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,\r\n                    stop:0 rgba(30, 30, 45, 0.95),\r\n                    stop:1 rgba(22, 33, 62, 0.95));\r\n                border-radius: 20px;\r\n                border: 1px solid rgba(255, 255, 255, 0.1);\r\n            }\r\n        \"\"\")\r\n        \r\n        # Add shadow effect\r\n        shadow = QGraphicsDropShadowEffect()\r\n        shadow.setBlurRadius(40)\r\n        shadow.setColor(QColor(0, 0, 0, 180))\r\n        shadow.setOffset(0, 10)\r\n        card.setGraphicsEffect(shadow)\r\n        \r\n        card_layout = QVBoxLayout(card)\r\n        card_layout.setContentsMargins(30, 30, 30, 30)\r\n        card_layout.setSpacing(12)\r\n        \r\n        # Logo\r\n        logo_label = QLabel()\r\n        logo_path = self.config['app'].get('logo', 'assets/logo.png')\r\n        \r\n        try:\r\n            pixmap = QPixmap(logo_path)\r\n            if not pixmap.isNull():\r\n                pixmap = pixmap.scaled(65, 65, Qt.KeepAspectRatio, Qt.SmoothTransformation)\r\n                logo_label.setPixmap(pixmap)\r\n            else:\r\n                raise FileNotFoundError\r\n        except:\r\n            logo_label.setText(\"ðŸ”\")\r\n            logo_label.setStyleSheet(\"font-size: 64px;\")\r\n        \r\n        logo_label.setAlignment(Qt.AlignCenter)\r\n        card_layout.addWidget(logo_label)\r\n        \r\n        # Title\r\n        title = QLabel(\"Face Recognition System\")\r\n        title.setAlignment(Qt.AlignCenter)\r\n        title.setStyleSheet(\"\"\"\r\n            font-size: 24px;\r\n            font-weight: bold;\r\n            color: white;\r\n            margin-top: 10px;\r\n        \"\"\")\r\n        card_layout.addWidget(title)\r\n        \r\n        # Subtitle\r\n        subtitle = QLabel(\"Please sign in to continue\")\r\n        subtitle.setAlignment(Qt.AlignCenter)\r\n        subtitle.setStyleSheet(\"\"\"\r\n            font-size: 13px;\r\n            color: rgba(255, 255, 255, 0.6);\r\n            margin-bottom: 20px;\r\n        \"\"\")\r\n        card_layout.addWidget(subtitle)\r\n        \r\n        # Username field\r\n        username_label = QLabel(\"Username\")\r\n        username_label.setStyleSheet(\"color: rgba(255, 255, 255, 0.8); font-size: 13px; font-weight: 500;\")\r\n        card_layout.addWidget(username_label)\r\n        \r\n        self.username_input = QLineEdit()\r\n        self.username_input.setPlaceholderText(\"Enter your username\")\r\n        self.username_input.setStyleSheet(\"\"\"\r\n            QLineEdit {\r\n                background-color: rgba(255, 255, 255, 0.08);\r\n                color: white;\r\n                border: 1px solid rgba(255, 255, 255, 0.15);\r\n                border-radius: 6px;\r\n                padding: 10px 14px;\r\n                font-size: 14px;\r\n            }\r\n            QLineEdit:focus {\r\n                background-color: rgba(255, 255, 255, 0.12);\r\n                border: 1px solid rgba(0, 120, 212, 0.8);\r\n            }\r\n        \"\"\")\r\n        card_layout.addWidget(self.username_input)\r\n        \r\n        # Password field\r\n        password_label = QLabel(\"Password\")\r\n        password_label.setStyleSheet(\"color: rgba(255, 255, 255, 0.8); font-size: 13px; font-weight: 500; margin-top: 10px;\")\r\n        card_layout.addWidget(password_label)\r\n        \r\n        self.password_input = QLineEdit()\r\n        self.password_input.setPlaceholderText(\"Enter your password\")\r\n        self.password_input.setEchoMode(QLineEdit.Password)\r\n        self.username_input.setMinimumHeight(42)\r\n        self.password_input.setMinimumHeight(42)\r\n        self.password_input.setStyleSheet(\"\"\"\r\n            QLineEdit {\r\n                background-color: rgba(255, 255, 255, 0.08);\r\n                color: white;\r\n                border: 1px solid rgba(255, 255, 255, 0.15);\r\n                border-radius: 8px;\r\n                padding: 12px 16px;\r\n                font-size: 14px;\r\n            }\r\n            QLineEdit:focus {\r\n                background-color: rgba(255, 255, 255, 0.12);\r\n                border: 1px solid rgba(0, 120, 212, 0.8);\r\n            }\r\n        \"\"\")\r\n        card_layout.addWidget(self.password_input)\r\n        \r\n        # Connect Enter key navigation\r\n        self.username_input.returnPressed.connect(self.password_input.setFocus)\r\n        self.password_input.returnPressed.connect(self.login)\r\n        \r\n        # Remember me & Forgot password\r\n        options_layout = QHBoxLayout()\r\n        \r\n        self.remember_checkbox = QCheckBox(\"Remember me\")\r\n        self.remember_checkbox.setStyleSheet(\"\"\"\r\n            QCheckBox {\r\n                color: rgba(255, 255, 255, 0.7);\r\n                font-size: 12px;\r\n            }\r\n            QCheckBox::indicator {\r\n                width: 18px;\r\n                height: 18px;\r\n                border-radius: 4px;\r\n                border: 2px solid rgba(255, 255, 255, 0.3);\r\n                background-color: transparent;\r\n            }\r\n            QCheckBox::indicator:checked {\r\n                background-color: #0078d4;\r\n                border-color: #0078d4;\r\n            }\r\n        \"\"\")\r\n        options_layout.addWidget(self.remember_checkbox)\r\n        options_layout.addStretch()\r\n        \r\n        forgot_btn = QPushButton(\"Forgot password?\")\r\n        forgot_btn.setFlat(True)\r\n        forgot_btn.setCursor(Qt.PointingHandCursor)\r\n        forgot_btn.setStyleSheet(\"\"\"\r\n            QPushButton {\r\n                color: #0078d4;\r\n                background-color: transparent;\r\n                border: none;\r\n                font-size: 12px;\r\n                text-decoration: underline;\r\n            }\r\n            QPushButton:hover {\r\n                color: #1e90ff;\r\n            }\r\n        \"\"\")\r\n        forgot_btn.clicked.connect(self.forgot_password)\r\n        options_layout.addWidget(forgot_btn)\r\n        \r\n        card_layout.addLayout(options_layout)\r\n        \r\n        # Error label\r\n        self.error_label = QLabel()\r\n        self.error_label.setWordWrap(True)\r\n        self.error_label.setAlignment(Qt.AlignCenter)\r\n        self.error_label.setStyleSheet(\"\"\"\r\n            color: #ff6b6b;\r\n            font-size: 12px;\r\n            padding: 8px;\r\n            background-color: rgba(255, 107, 107, 0.1);\r\n            border-radius: 6px;\r\n        \"\"\")\r\n        self.error_label.hide()\r\n        card_layout.addWidget(self.error_label)\r\n        \r\n        # Login button\r\n        self.login_btn = QPushButton(\"Sign In\")\r\n        self.login_btn.setCursor(Qt.PointingHandCursor)\r\n        self.login_btn.setStyleSheet(\"\"\"\r\n            QPushButton {\r\n                background-color: #0078d4;\r\n                color: white;\r\n                border: none;\r\n                border-radius: 8px;\r\n                padding: 14px;\r\n                font-size: 15px;\r\n                font-weight: 600;\r\n            }\r\n            QPushButton:hover {\r\n                background-color: #1e90ff;\r\n            }\r\n            QPushButton:pressed {\r\n                background-color: #005a9e;\r\n            }\r\n            QPushButton:disabled {\r\n                background-color: rgba(0, 120, 212, 0.3);\r\n            }\r\n        \"\"\")\r\n        self.login_btn.clicked.connect(self.login)\r\n        card_layout.addWidget(self.login_btn)\r\n        \r\n        # Close button\r\n        close_btn = QPushButton(\"Exit\")\r\n        close_btn.setCursor(Qt.PointingHandCursor)\r\n        close_btn.setStyleSheet(\"\"\"\r\n            QPushButton {\r\n                background-color: rgba(255, 255, 255, 0.05);\r\n                color: rgba(255, 255, 255, 0.7);\r\n                border: 1px solid rgba(255, 255, 255, 0.15);\r\n                border-radius: 8px;\r\n                padding: 12px;\r\n                font-size: 13px;\r\n            }\r\n            QPushButton:hover {\r\n                background-color: rgba(255, 255, 255, 0.08);\r\n                color: white;\r\n            }\r\n        \"\"\")\r\n        close_btn.clicked.connect(self.reject)\r\n        card_layout.addWidget(close_btn)\r\n        \r\n        # Version info\r\n        version_label = QLabel(f\"Version {self.config['app']['version']}\")\r\n        version_label.setAlignment(Qt.AlignCenter)\r\n        version_label.setStyleSheet(\"\"\"\r\n            color: rgba(255, 255, 255, 0.4);\r\n            font-size: 11px;\r\n            margin-top: 10px;\r\n        \"\"\")\r\n        card_layout.addWidget(version_label)\r\n        \r\n        main_layout.addWidget(card)\r\n        \r\n        # Focus on username\r\n        self.username_input.setFocus()\r\n        \r\n    def setup_animations(self):\r\n        \"\"\"Setup entrance animation\"\"\"\r\n        self.animation = QPropertyAnimation(self, b\"windowOpacity\")\r\n        self.animation.setDuration(300)\r\n        self.animation.setStartValue(0.0)\r\n        self.animation.setEndValue(1.0)\r\n        self.animation.setEasingCurve(QEasingCurve.OutCubic)\r\n        self.animation.start()\r\n    \r\n    def login(self):\r\n        \"\"\"Handle login attempt\"\"\"\r\n        username = self.username_input.text().strip()\r\n        password = self.password_input.text()\r\n\r\n        # Validate inputs\r\n        if not username or not password:\r\n            self.show_error(\"Please enter both username and password\")\r\n            return\r\n\r\n        # Disable button during login\r\n        self.login_btn.setEnabled(False)\r\n        self.login_btn.setText(\"Signing in...\")\r\n\r\n        try:\r\n            # Attempt login\r\n            success, message, user = self.auth_manager.login(username, password)\r\n\r\n            if success:\r\n                logger.info(f\"Login successful for user: {username}\")\r\n                self.login_successful.emit(user)\r\n                self.accept()\r\n                return\r\n            else:\r\n                logger.warning(f\"Login failed for user: {username} - {message}\")\r\n                # show_error maneja la animaciÃ³n y el label\r\n                self.show_error(message)\r\n                # limpiar password y preparar reintento\r\n                self.password_input.clear()\r\n                self.password_input.setFocus()\r\n\r\n        except Exception as e:\r\n            logger.exception(f\"Unexpected error during login: {e}\")\r\n            # Mostrar un mensaje de error genÃ©rico al usuario\r\n            try:\r\n                self.show_error(\"Unexpected error occurred. Check logs.\")\r\n            except Exception:\r\n                pass\r\n            \r\n        finally:\r\n            # Si no se aceptÃ³ (login fallido) re-habilitar botones para reintento\r\n            if not getattr(self, \"_accepted\", False):\r\n                try:\r\n                    self.login_btn.setEnabled(True)\r\n                    self.login_btn.setText(\"Sign In\")\r\n                except Exception:\r\n                    pass\r\n\r\n    \r\n    def show_error(self, message: str):\r\n        \"\"\"Display error message\"\"\"\r\n        self.error_label.setText(message)\r\n        self.error_label.show()\r\n        \r\n        # Shake animation\r\n        original_pos = self.pos()\r\n        shake_animation = QPropertyAnimation(self, b\"pos\")\r\n        shake_animation.setDuration(250)\r\n        shake_animation.setLoopCount(1)\r\n        \r\n        \r\n        \r\n        positions = [\r\n            QPoint(original_pos.x() - 8, original_pos.y()),\r\n            QPoint(original_pos.x() + 8, original_pos.y()),\r\n        ]\r\n        \r\n        for i, pos in enumerate(positions):\r\n            shake_animation.setKeyValueAt(i / len(positions), pos)\r\n        \r\n        offset = 8\r\n        shake_animation.setKeyValueAt(0.0, original_pos)\r\n        shake_animation.setKeyValueAt(0.10, QPoint(original_pos.x() - offset, original_pos.y()))\r\n        shake_animation.setKeyValueAt(0.30, QPoint(original_pos.x() + offset, original_pos.y()))\r\n        shake_animation.setKeyValueAt(0.50, QPoint(original_pos.x() - offset, original_pos.y()))\r\n        shake_animation.setKeyValueAt(0.70, QPoint(original_pos.x() + offset, original_pos.y()))\r\n        shake_animation.setKeyValueAt(1.0, original_pos)\r\n        \r\n        # Guardar referencia para que no sea recolectada\r\n        self._shake_animation = shake_animation\r\n\r\n    # Iniciar la animaciÃ³n en un try/except para evitar fallos de render en Windows\r\n        try:\r\n            self._shake_animation.start()\r\n        except Exception as e:\r\n            logger.warning(f\"Shake animation failed: {e}\")\r\n        \r\n        \r\n    def forgot_password(self):\r\n        \"\"\"Handle forgot password\"\"\"\r\n        QMessageBox.information(\r\n            self,\r\n            \"Forgot Password\",\r\n            \"Please contact your system administrator to reset your password.\\n\\n\"\r\n            \"Default admin credentials:\\n\"\r\n            \"Username: admin\\n\"\r\n            \"Password: admin123\",\r\n            QMessageBox.Ok\r\n        )\r\n    \r\n    def keyPressEvent(self, event: QKeyEvent):\r\n        \"\"\"Handle key press events\"\"\"\r\n        if event.key() == Qt.Key_Escape:\r\n            self.reject()\r\n        else:\r\n            super().keyPressEvent(event)",
    "main_window.py": "import sys\r\nimport time\r\nfrom concurrent.futures import ThreadPoolExecutor, Future\r\nfrom PyQt5.QtWidgets import (QMainWindow, QApplication, QWidget, QVBoxLayout, QHBoxLayout,\r\n                            QLabel, QPushButton, QTabWidget, QScrollArea, QGridLayout,\r\n                            QMessageBox, QFileDialog, QComboBox, QSlider, QSpinBox,\r\n                            QStackedWidget, QFrame, QGraphicsDropShadowEffect)\r\nfrom PyQt5.QtCore import Qt, QTimer, pyqtSignal, QSize, QPropertyAnimation, QEasingCurve, QRect, QPoint\r\nfrom PyQt5.QtGui import QPixmap, QImage, QIcon, QPalette, QColor, QPainter, QLinearGradient, QPen\r\nfrom loguru import logger\r\nfrom typing import Dict, Optional, Tuple\r\nimport numpy as np\r\nimport cv2\r\nfrom pathlib import Path\r\n\r\nfrom core.face_detection import FaceDetector\r\nfrom core.camera_manager import CameraManager\r\nfrom core.alert_system import AlertEvent, AlertSystem\r\nfrom core.database import FaceDatabase\r\nfrom core.utils import numpy_to_pixmap, resize_image, draw_face_info\r\nfrom ui.face_manager import FaceManagerDialog\r\nfrom ui.alert_panel import AlertPanel\r\nfrom ui.history_viewer import HistoryViewer\r\n\r\n\r\nclass ModernButton(QPushButton):\r\n    \"\"\"Botones modernos\"\"\"\r\n    def __init__(self, icon_text=\"\", text=\"\", parent=None):\r\n        super().__init__(parent)\r\n        self.icon_text = icon_text\r\n        self.button_text = text\r\n        self.is_active = False\r\n        self.setMinimumHeight(50)\r\n        self.setCursor(Qt.PointingHandCursor)\r\n        self.update_style()\r\n        \r\n        super().setText(f\"{self.icon_text}  {self.button_text}\")\r\n        \r\n        self.update_style()\r\n        \r\n    def update_style(self):\r\n        active_bg = \"rgba(255, 255, 255, 0.1)\" if self.is_active else \"transparent\"\r\n        self.setStyleSheet(f\"\"\"\r\n            ModernButton {{\r\n                background-color: {active_bg};\r\n                border: none;\r\n                border-radius: 8px;\r\n                color: white;\r\n                text-align: left;\r\n                padding: 12px 16px;\r\n                font-size: 14px;\r\n                font-weight: 500;\r\n            }}\r\n            ModernButton:hover {{\r\n                background-color: rgba(255, 255, 255, 0.08);\r\n            }}\r\n            ModernButton:pressed {{\r\n                background-color: rgba(255, 255, 255, 0.05);\r\n            }}\r\n            ModernButton:disabled {{\r\n                background-color: transparent;\r\n                color: rgba(255, 255, 255, 0.3);\r\n            }}\r\n        \"\"\")\r\n        \r\n    def set_active(self, active):\r\n        self.is_active = active\r\n        self.update_style()\r\n        \r\n    def setText(self, text):\r\n        self.button_text = text\r\n        super().setText(f\"  {self.icon_text} {self.button_text}\")\r\n\r\n\r\nclass SidebarWidget(QWidget):\r\n    \"\"\"Barra lateral estilo Windows 11\"\"\"\r\n    page_changed = pyqtSignal(int)\r\n    \r\n    def __init__(self, parent=None):\r\n        super().__init__(parent)\r\n        self.buttons = []\r\n        self.current_index = 0\r\n        self.setup_ui()\r\n        \r\n    def setup_ui(self):\r\n        self.setFixedWidth(280)\r\n        \r\n        self.setStyleSheet(\"\"\"\r\n            SidebarWidget {\r\n                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,\r\n                    stop:0 rgba(32, 32, 42, 0.95),\r\n                    stop:1 rgba(28, 28, 38, 0.95));\r\n                border-right: 1px solid rgba(255, 255, 255, 0.1);\r\n            }\r\n        \"\"\")\r\n        \r\n        layout = QVBoxLayout(self)\r\n        layout.setContentsMargins(16, 24, 16, 24)\r\n        layout.setSpacing(8)\r\n        \r\n        # Logo y tÃ­tulo\r\n        header = QWidget()\r\n        header_layout = QVBoxLayout(header)\r\n        header_layout.setSpacing(8)\r\n        \r\n        logo_label = QLabel(\"ðŸŽ¥\")\r\n        logo_label.setStyleSheet(\"font-size: 32px; padding: 8px;\")\r\n        logo_label.setAlignment(Qt.AlignCenter)\r\n        \r\n        title_label = QLabel(\"Face Recognition\")\r\n        title_label.setStyleSheet(\"\"\"\r\n            color: white;\r\n            font-size: 18px;\r\n            font-weight: bold;\r\n            padding: 0px 8px;\r\n        \"\"\")\r\n        title_label.setAlignment(Qt.AlignCenter)\r\n        \r\n        subtitle_label = QLabel(\"v1.0.0\")\r\n        subtitle_label.setStyleSheet(\"\"\"\r\n            color: rgba(255, 255, 255, 0.6);\r\n            font-size: 12px;\r\n            padding: 0px 8px 16px 8px;\r\n        \"\"\")\r\n        subtitle_label.setAlignment(Qt.AlignCenter)\r\n        \r\n        header_layout.addWidget(logo_label)\r\n        header_layout.addWidget(title_label)\r\n        header_layout.addWidget(subtitle_label)\r\n        \r\n        layout.addWidget(header)\r\n        \r\n        # Separador\r\n        separator = QFrame()\r\n        separator.setFrameShape(QFrame.HLine)\r\n        separator.setStyleSheet(\"background-color: rgba(255, 255, 255, 0.1); max-height: 1px;\")\r\n        layout.addWidget(separator)\r\n        layout.addSpacing(8)\r\n        \r\n        # Botones de navegaciÃ³n\r\n        self.add_nav_button(\"ðŸ“¹\", \"Monitor\", 0)\r\n        self.add_nav_button(\"âš™ï¸\", \"Controles\", 1)\r\n        self.add_nav_button(\"ðŸ“Š\", \"Historial\", 2)\r\n        self.add_nav_button(\"ðŸ‘¤\", \"Administrar Rostros\", 3)\r\n        self.add_nav_button(\"ðŸ””\", \"Alertas\", 4)\r\n        \r\n        layout.addStretch()\r\n        \r\n    def add_nav_button(self, icon, text, index):\r\n        btn = ModernButton(icon, text)\r\n        btn.clicked.connect(lambda: self.switch_page(index))\r\n        self.buttons.append(btn)\r\n        self.layout().insertWidget(self.layout().count() - 1, btn)\r\n        \r\n        if index == 0:\r\n            btn.set_active(True)\r\n            \r\n    def switch_page(self, index):\r\n        for i, btn in enumerate(self.buttons):\r\n            btn.set_active(i == index)\r\n        self.current_index = index\r\n        self.page_changed.emit(index)\r\n\r\n\r\nclass ModernCard(QFrame):\r\n    \"\"\"Tarjeta con efecto acrÃ­lico de Windows 11\"\"\"\r\n    def __init__(self, parent=None):\r\n        super().__init__(parent)\r\n        self.setStyleSheet(\"\"\"\r\n            ModernCard {\r\n                background-color: rgba(255, 255, 255, 0.05);\r\n                border: 1px solid rgba(255, 255, 255, 0.1);\r\n                border-radius: 12px;\r\n                padding: 16px;\r\n            }\r\n        \"\"\")\r\n        \r\n        shadow = QGraphicsDropShadowEffect(self)\r\n        shadow.setBlurRadius(20)\r\n        shadow.setColor(QColor(0, 0, 0, 60))\r\n        shadow.setOffset(0, 4)\r\n        self.setGraphicsEffect(shadow)\r\n\r\n\r\nclass MainWindow(QMainWindow):\r\n    # Signal para actualizaciÃ³n de frames procesados\r\n    frame_processed = pyqtSignal(int, np.ndarray)\r\n    \r\n    def __init__(self, config, auth_manager, database):\r\n        super().__init__()\r\n        self.config = config\r\n        self.auth_manager = auth_manager\r\n        self.database_instance = database\r\n        \r\n        self.setWindowTitle(f\"{config['app']['name']} v{config['app']['version']}\")\r\n        self.setWindowIcon(QIcon(config['app']['logo']))\r\n        self.setGeometry(100, 100, 1400, 900)\r\n        \r\n        self.processing_interval = 0.5\r\n        \r\n        # Thread pool para procesamiento paralelo\r\n        self.executor = ThreadPoolExecutor(max_workers=4, thread_name_prefix=\"FrameProcessor\")\r\n        self.processing_futures: Dict[int, Future] = {}\r\n        \r\n        # Cache de frames procesados\r\n        self.processed_frames_cache: Dict[int, Tuple[np.ndarray, float]] = {}\r\n        self.cache_timeout = 0.1  # 100ms cache\r\n        \r\n        # Inicializar componentes core\r\n        self.face_detector = FaceDetector(config)\r\n        self.camera_manager = CameraManager('config/camera_config.yaml')\r\n        self.alert_system = AlertSystem(config)\r\n        self.database = FaceDatabase(config['app']['database_path'])\r\n        \r\n        self.face_detector.load_known_faces_from_db(database)\r\n        \r\n        # Conectar seÃ±al de frames procesados\r\n        self.frame_processed.connect(self.on_frame_processed)\r\n        \r\n        # Configurar tema oscuro\r\n        self.setup_theme()\r\n        \r\n        # UI\r\n        self.init_ui()\r\n        \r\n        # Aplicar permisos basados en rol\r\n        self.apply_permissions()\r\n        \r\n        # Mostrar usuario logueado\r\n        self.update_user_display()\r\n        \r\n        # Iniciar cÃ¡maras\r\n        self.camera_manager.start_all_cameras()\r\n        \r\n        # Timer de actualizaciÃ³n (reducido a 50ms para mejor fluidez)\r\n        self.update_timer = QTimer(self)\r\n        self.update_timer.timeout.connect(self.update)\r\n        self.update_timer.start(50)\r\n        \r\n        self.last_processed: Dict[int, float] = {}\r\n        \r\n        # EstadÃ­sticas de rendimiento\r\n        self.frame_times: Dict[int, list] = {}\r\n        self.max_frame_time_samples = 30\r\n        \r\n    def apply_permissions(self):\r\n        \"\"\"Apply UI restrictions based on user role\"\"\"\r\n        user = self.auth_manager.get_current_user()\r\n        if not user:\r\n            return\r\n        \r\n        logger.info(f\"Applying permissions for role: {user.role}\")\r\n        \r\n        # Viewer: solo puede ver cÃ¡maras, sin control\r\n        if user.role == 'viewer':\r\n            if hasattr(self, 'start_btn'):\r\n                self.start_btn.setEnabled(False)\r\n                self.start_btn.setToolTip(\"Permission denied: Viewers cannot control cameras\")\r\n            if hasattr(self, 'stop_btn'):\r\n                self.stop_btn.setEnabled(False)\r\n                self.stop_btn.setToolTip(\"Permission denied: Viewers cannot control cameras\")\r\n            \r\n            if hasattr(self, 'threshold_slider'):\r\n                self.threshold_slider.setEnabled(False)\r\n            if hasattr(self, 'interval_spin'):\r\n                self.interval_spin.setEnabled(False)\r\n            \r\n            if hasattr(self, 'sidebar') and len(self.sidebar.buttons) > 3:\r\n                self.sidebar.buttons[3].setEnabled(False)\r\n                self.sidebar.buttons[3].setToolTip(\"Permission denied: Viewers cannot manage faces\")\r\n    \r\n    def update_user_display(self):\r\n        \"\"\"Display current user info in status bar\"\"\"\r\n        user = self.auth_manager.get_current_user()\r\n        if user:\r\n            role_icons = {\r\n                'admin': 'ðŸ‘‘',\r\n                'operator': 'âš™ï¸',\r\n                'viewer': 'ðŸ‘ï¸'\r\n            }\r\n            icon = role_icons.get(user.role, 'ðŸ‘¤')\r\n            user_info = QLabel(f\"{icon} {user.username} ({user.role})\")\r\n            user_info.setStyleSheet(\"color: rgba(255, 255, 255, 0.9); padding: 0 10px;\")\r\n            self.statusBar().addPermanentWidget(user_info)\r\n            \r\n            # BotÃ³n de logout\r\n            logout_btn = QPushButton(\"Logout\")\r\n            logout_btn.setStyleSheet(\"\"\"\r\n                QPushButton {\r\n                    background-color: rgba(220, 53, 69, 0.8);\r\n                    color: white;\r\n                    border: none;\r\n                    border-radius: 4px;\r\n                    padding: 4px 12px;\r\n                    font-size: 11px;\r\n                }\r\n                QPushButton:hover {\r\n                    background-color: rgba(220, 53, 69, 1);\r\n                }\r\n            \"\"\")\r\n            logout_btn.clicked.connect(self.handle_logout)\r\n            self.statusBar().addPermanentWidget(logout_btn)\r\n    \r\n    def handle_logout(self):\r\n        \"\"\"Handle user logout\"\"\"\r\n        reply = QMessageBox.question(\r\n            self,\r\n            \"Confirm Logout\",\r\n            \"Are you sure you want to logout?\",\r\n            QMessageBox.Yes | QMessageBox.No,\r\n            QMessageBox.No\r\n        )\r\n        \r\n        if reply == QMessageBox.Yes:\r\n            user = self.auth_manager.get_current_user()\r\n            if user:\r\n                logger.info(f\"User {user.username} logged out\")\r\n            self.close()\r\n\r\n    def setup_theme(self):\r\n        \"\"\"Configurar tema oscuro estilo Windows 11\"\"\"\r\n        self.setStyleSheet(\"\"\"\r\n            QMainWindow {\r\n                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,\r\n                    stop:0 #1a1a2e,\r\n                    stop:1 #16213e);\r\n            }\r\n            QLabel {\r\n                color: white;\r\n            }\r\n            QScrollArea {\r\n                border: none;\r\n                background-color: transparent;\r\n            }\r\n            QPushButton {\r\n                background-color: rgba(0, 120, 212, 0.8);\r\n                color: white;\r\n                border: none;\r\n                border-radius: 6px;\r\n                padding: 10px 20px;\r\n                font-size: 13px;\r\n                font-weight: 500;\r\n            }\r\n            QPushButton:hover {\r\n                background-color: rgba(0, 120, 212, 1);\r\n            }\r\n            QPushButton:pressed {\r\n                background-color: rgba(0, 100, 180, 1);\r\n            }\r\n            QPushButton:disabled {\r\n                background-color: rgba(0, 120, 212, 0.3);\r\n                color: rgba(255, 255, 255, 0.4);\r\n            }\r\n            QComboBox {\r\n                background-color: rgba(255, 255, 255, 0.08);\r\n                color: white;\r\n                border: 1px solid rgba(255, 255, 255, 0.15);\r\n                border-radius: 6px;\r\n                padding: 8px 12px;\r\n                font-size: 13px;\r\n            }\r\n            QComboBox:hover {\r\n                background-color: rgba(255, 255, 255, 0.12);\r\n            }\r\n            QComboBox::drop-down {\r\n                border: none;\r\n                width: 30px;\r\n            }\r\n            QComboBox QAbstractItemView {\r\n                background-color: rgba(32, 32, 42, 0.98);\r\n                color: white;\r\n                border: 1px solid rgba(255, 255, 255, 0.15);\r\n                selection-background-color: rgba(0, 120, 212, 0.5);\r\n                border-radius: 6px;\r\n                padding: 4px;\r\n            }\r\n            QSlider::groove:horizontal {\r\n                background-color: rgba(255, 255, 255, 0.1);\r\n                height: 4px;\r\n                border-radius: 2px;\r\n            }\r\n            QSlider::handle:horizontal {\r\n                background-color: #0078d4;\r\n                width: 16px;\r\n                height: 16px;\r\n                margin: -6px 0;\r\n                border-radius: 8px;\r\n            }\r\n            QSlider::handle:horizontal:hover {\r\n                background-color: #1e90ff;\r\n            }\r\n            QSpinBox {\r\n                background-color: rgba(255, 255, 255, 0.08);\r\n                color: white;\r\n                border: 1px solid rgba(255, 255, 255, 0.15);\r\n                border-radius: 6px;\r\n                padding: 8px 12px;\r\n                font-size: 13px;\r\n            }\r\n            QSpinBox:hover {\r\n                background-color: rgba(255, 255, 255, 0.12);\r\n            }\r\n        \"\"\")\r\n        \r\n    def init_ui(self):\r\n        central_widget = QWidget()\r\n        self.setCentralWidget(central_widget)\r\n        \r\n        main_layout = QHBoxLayout(central_widget)\r\n        main_layout.setContentsMargins(0, 0, 0, 0)\r\n        main_layout.setSpacing(0)\r\n        \r\n        # Barra lateral\r\n        self.sidebar = SidebarWidget()\r\n        self.sidebar.page_changed.connect(self.switch_page)\r\n        main_layout.addWidget(self.sidebar)\r\n        \r\n        # Ãrea de contenido\r\n        self.content_stack = QStackedWidget()\r\n        main_layout.addWidget(self.content_stack)\r\n        \r\n        # PÃ¡ginas\r\n        self.setup_monitor_page()\r\n        self.setup_controls_page()\r\n        self.setup_history_page()\r\n        self.setup_face_manager_page()\r\n        self.setup_alerts_page()\r\n        \r\n        # Status bar moderno\r\n        self.statusBar().setStyleSheet(\"\"\"\r\n            QStatusBar {\r\n                background-color: rgba(32, 32, 42, 0.8);\r\n                color: rgba(255, 255, 255, 0.7);\r\n                border-top: 1px solid rgba(255, 255, 255, 0.1);\r\n                font-size: 12px;\r\n                padding: 4px 16px;\r\n            }\r\n        \"\"\")\r\n        self.status_label = QLabel(\"Sistema listo\")\r\n        self.statusBar().addWidget(self.status_label)\r\n        \r\n    def setup_monitor_page(self):\r\n        page = QWidget()\r\n        layout = QVBoxLayout(page)\r\n        layout.setContentsMargins(32, 32, 32, 32)\r\n        layout.setSpacing(24)\r\n        \r\n        # TÃ­tulo con estadÃ­sticas de rendimiento\r\n        header_layout = QHBoxLayout()\r\n        \r\n        title = QLabel(\"Monitor de CÃ¡maras\")\r\n        title.setStyleSheet(\"\"\"\r\n            font-size: 28px;\r\n            font-weight: bold;\r\n            color: white;\r\n            margin-bottom: 8px;\r\n        \"\"\")\r\n        header_layout.addWidget(title)\r\n        \r\n        header_layout.addStretch()\r\n        \r\n        # Label de FPS\r\n        self.fps_label = QLabel(\"FPS: --\")\r\n        self.fps_label.setStyleSheet(\"\"\"\r\n            font-size: 14px;\r\n            color: rgba(255, 255, 255, 0.8);\r\n            padding: 8px 16px;\r\n            background-color: rgba(0, 120, 212, 0.3);\r\n            border-radius: 6px;\r\n        \"\"\")\r\n        header_layout.addWidget(self.fps_label)\r\n        \r\n        layout.addLayout(header_layout)\r\n        \r\n        # Scroll para cÃ¡maras\r\n        scroll = QScrollArea()\r\n        scroll.setWidgetResizable(True)\r\n        scroll.setStyleSheet(\"QScrollArea { background-color: transparent; }\")\r\n        \r\n        self.camera_container = QWidget()\r\n        self.camera_grid = QGridLayout(self.camera_container)\r\n        self.camera_grid.setSpacing(20)\r\n        \r\n        scroll.setWidget(self.camera_container)\r\n        layout.addWidget(scroll)\r\n        \r\n        # Agregar labels de cÃ¡maras en tarjetas\r\n        self.camera_labels = {}\r\n        for cam_id in self.camera_manager.cameras:\r\n            card = ModernCard()\r\n            card_layout = QVBoxLayout(card)\r\n            card_layout.setContentsMargins(8, 8, 8, 8)\r\n            \r\n            cam_label = QLabel()\r\n            cam_label.setAlignment(Qt.AlignCenter)\r\n            cam_label.setMinimumSize(500, 375)\r\n            cam_label.setStyleSheet(\"\"\"\r\n                background-color: rgba(0, 0, 0, 0.3);\r\n                border-radius: 8px;\r\n            \"\"\")\r\n            \r\n            cam_title = QLabel(f\"ðŸ“¹ CÃ¡mara {cam_id}\")\r\n            cam_title.setStyleSheet(\"\"\"\r\n                font-size: 14px;\r\n                font-weight: 600;\r\n                color: white;\r\n                padding: 8px;\r\n            \"\"\")\r\n            \r\n            card_layout.addWidget(cam_label)\r\n            card_layout.addWidget(cam_title)\r\n            \r\n            self.camera_labels[cam_id] = cam_label\r\n            self.camera_grid.addWidget(card, (cam_id // 2), (cam_id % 2))\r\n        \r\n        self.content_stack.addWidget(page)\r\n        \r\n    def setup_controls_page(self):\r\n        page = QWidget()\r\n        layout = QVBoxLayout(page)\r\n        layout.setContentsMargins(32, 32, 32, 32)\r\n        layout.setSpacing(24)\r\n        \r\n        # TÃ­tulo\r\n        title = QLabel(\"Panel de Control\")\r\n        title.setStyleSheet(\"\"\"\r\n            font-size: 28px;\r\n            font-weight: bold;\r\n            color: white;\r\n            margin-bottom: 8px;\r\n        \"\"\")\r\n        layout.addWidget(title)\r\n        \r\n        # Tarjeta de control de cÃ¡maras\r\n        camera_card = ModernCard()\r\n        camera_layout = QVBoxLayout(camera_card)\r\n        camera_layout.setSpacing(16)\r\n        \r\n        cam_title = QLabel(\"ðŸŽ¥ Control de CÃ¡maras\")\r\n        cam_title.setStyleSheet(\"font-size: 18px; font-weight: 600; color: white;\")\r\n        camera_layout.addWidget(cam_title)\r\n        \r\n        self.camera_combo = QComboBox()\r\n        for cam_id, cam_config in self.camera_manager.cameras.items():\r\n            self.camera_combo.addItem(f\"CÃ¡mara {cam_id}: {cam_config.name}\", cam_id)\r\n        camera_layout.addWidget(self.camera_combo)\r\n        \r\n        btn_layout = QHBoxLayout()\r\n        self.start_btn = QPushButton(\"â–¶ï¸ Iniciar\")\r\n        self.start_btn.clicked.connect(self.start_selected_camera)\r\n        self.stop_btn = QPushButton(\"â¸ï¸ Detener\")\r\n        self.stop_btn.clicked.connect(self.stop_selected_camera)\r\n        btn_layout.addWidget(self.start_btn)\r\n        btn_layout.addWidget(self.stop_btn)\r\n        camera_layout.addLayout(btn_layout)\r\n        \r\n        layout.addWidget(camera_card)\r\n        \r\n        # Tarjeta de configuraciÃ³n\r\n        config_card = ModernCard()\r\n        config_layout = QVBoxLayout(config_card)\r\n        config_layout.setSpacing(16)\r\n        \r\n        config_title = QLabel(\"âš™ï¸ ConfiguraciÃ³n de Reconocimiento\")\r\n        config_title.setStyleSheet(\"font-size: 18px; font-weight: 600; color: white;\")\r\n        config_layout.addWidget(config_title)\r\n        \r\n        # Threshold\r\n        threshold_layout = QHBoxLayout()\r\n        threshold_label = QLabel(\"Umbral de Reconocimiento:\")\r\n        threshold_label.setStyleSheet(\"color: rgba(255, 255, 255, 0.9);\")\r\n        threshold_layout.addWidget(threshold_label)\r\n        \r\n        self.threshold_slider = QSlider(Qt.Horizontal)\r\n        self.threshold_slider.setRange(50, 100)\r\n        self.threshold_slider.setValue(int(self.config['recognition']['recognition_threshold'] * 100))\r\n        self.threshold_slider.valueChanged.connect(self.update_threshold)\r\n        threshold_layout.addWidget(self.threshold_slider)\r\n        \r\n        self.threshold_value = QLabel(f\"{self.threshold_slider.value() / 100:.2f}\")\r\n        self.threshold_value.setStyleSheet(\"color: #0078d4; font-weight: bold; min-width: 40px;\")\r\n        threshold_layout.addWidget(self.threshold_value)\r\n        \r\n        config_layout.addLayout(threshold_layout)\r\n        \r\n        # Intervalo de procesamiento\r\n        interval_layout = QHBoxLayout()\r\n        interval_label = QLabel(\"Intervalo de Procesamiento (ms):\")\r\n        interval_label.setStyleSheet(\"color: rgba(255, 255, 255, 0.9);\")\r\n        interval_layout.addWidget(interval_label)\r\n        \r\n        self.interval_spin = QSpinBox()\r\n        self.interval_spin.setRange(100, 5000)\r\n        self.interval_spin.setValue(int(self.processing_interval * 1000))\r\n        self.interval_spin.valueChanged.connect(self.update_processing_interval)\r\n        interval_layout.addWidget(self.interval_spin)\r\n        interval_layout.addStretch()\r\n        \r\n        config_layout.addLayout(interval_layout)\r\n        \r\n        layout.addWidget(config_card)\r\n        \r\n        # Tarjeta de estado\r\n        status_card = ModernCard()\r\n        status_layout = QVBoxLayout(status_card)\r\n        \r\n        status_title = QLabel(\"ðŸ“Š Estado del Sistema\")\r\n        status_title.setStyleSheet(\"font-size: 18px; font-weight: 600; color: white;\")\r\n        status_layout.addWidget(status_title)\r\n        \r\n        self.status_display = QLabel(\"Cargando...\")\r\n        self.status_display.setWordWrap(True)\r\n        self.status_display.setStyleSheet(\"color: rgba(255, 255, 255, 0.8); font-size: 13px; line-height: 1.5;\")\r\n        status_layout.addWidget(self.status_display)\r\n        \r\n        layout.addWidget(status_card)\r\n        layout.addStretch()\r\n        \r\n        self.content_stack.addWidget(page)\r\n        \r\n    def setup_history_page(self):\r\n        self.history_viewer = HistoryViewer(self.database, self.config)\r\n        self.content_stack.addWidget(self.history_viewer)\r\n        \r\n    def setup_face_manager_page(self):\r\n        page = QWidget()\r\n        layout = QVBoxLayout(page)\r\n        layout.setContentsMargins(32, 32, 32, 32)\r\n        layout.setSpacing(20)\r\n        \r\n        title = QLabel(\"AdministraciÃ³n de Rostros\")\r\n        title.setStyleSheet(\"font-size: 28px; font-weight: bold; color: white; margin-bottom: 16px;\")\r\n        layout.addWidget(title)\r\n        \r\n        btn_layout = QHBoxLayout()\r\n        \r\n        face_btn = QPushButton(\"Gestionar Rostros Conocidos\")\r\n        face_btn.clicked.connect(self.open_face_manager)\r\n        face_btn.setFixedWidth(300)\r\n        btn_layout.addWidget(face_btn)\r\n        \r\n        # BotÃ³n de gestiÃ³n de usuarios (solo admin)\r\n        user = self.auth_manager.get_current_user()\r\n        if user and user.role == 'admin':\r\n            user_btn = QPushButton(\"Gestionar Usuarios\")\r\n            user_btn.clicked.connect(self.open_user_manager)\r\n            user_btn.setFixedWidth(300)\r\n            user_btn.setStyleSheet(\"\"\"\r\n                QPushButton {\r\n                    background-color: rgba(108, 92, 231, 0.8);\r\n                }\r\n                QPushButton:hover {\r\n                    background-color: rgba(108, 92, 231, 1);\r\n                }\r\n            \"\"\")\r\n            btn_layout.addWidget(user_btn)\r\n        \r\n        btn_layout.addStretch()\r\n        layout.addLayout(btn_layout)\r\n        layout.addStretch()\r\n        \r\n        self.content_stack.addWidget(page)\r\n        \r\n    def setup_alerts_page(self):\r\n        page = QWidget()\r\n        layout = QVBoxLayout(page)\r\n        layout.setContentsMargins(32, 32, 32, 32)\r\n        \r\n        title = QLabel(\"Panel de Alertas\")\r\n        title.setStyleSheet(\"font-size: 28px; font-weight: bold; color: white; margin-bottom: 16px;\")\r\n        layout.addWidget(title)\r\n        \r\n        btn = QPushButton(\"Abrir Panel de Alertas\")\r\n        btn.clicked.connect(self.open_alert_panel)\r\n        btn.setFixedWidth(300)\r\n        layout.addWidget(btn)\r\n        layout.addStretch()\r\n        \r\n        self.content_stack.addWidget(page)\r\n        \r\n    def switch_page(self, index):\r\n        self.content_stack.setCurrentIndex(index)\r\n        \r\n    def open_face_manager(self):\r\n        if not self.auth_manager.has_permission('operator'):\r\n            QMessageBox.warning(\r\n                self,\r\n                \"Permission Denied\",\r\n                \"Only operators and administrators can manage faces.\"\r\n            )\r\n            return\r\n        \r\n        dialog = FaceManagerDialog(self.face_detector, self.config['app']['known_faces_dir'], self.database,  self.auth_manager)\r\n        dialog.exec_()\r\n        self.face_detector.load_known_faces_from_db(self.database)\r\n        self.face_detector.load_known_faces(self.config['app']['known_faces_dir'])\r\n    \r\n    def open_user_manager(self):\r\n        \"\"\"Open user management dialog (admin only)\"\"\"\r\n        if not self.auth_manager.has_permission('admin'):\r\n            QMessageBox.warning(\r\n                self,\r\n                \"Permission Denied\",\r\n                \"Only administrators can manage users.\"\r\n            )\r\n            return\r\n        \r\n        from ui.user_management import UserManagementDialog\r\n        dialog = UserManagementDialog(self.database, self.auth_manager, self)\r\n        dialog.exec_()\r\n        \r\n    def open_alert_panel(self):\r\n        dialog = AlertPanel(self.alert_system)\r\n        dialog.exec_()\r\n        \r\n    def start_selected_camera(self):\r\n        cam_id = self.camera_combo.currentData()\r\n        if self.camera_manager.start_camera(cam_id):\r\n            self.status_label.setText(f\"âœ… CÃ¡mara {cam_id} iniciada\")\r\n            \r\n    def stop_selected_camera(self):\r\n        cam_id = self.camera_combo.currentData()\r\n        if self.camera_manager.stop_camera(cam_id):\r\n            self.status_label.setText(f\"â¸ï¸ CÃ¡mara {cam_id} detenida\")\r\n            \r\n    def update_threshold(self, value):\r\n        threshold = value / 100\r\n        self.face_detector.recognition_threshold = threshold\r\n        self.threshold_value.setText(f\"{threshold:.2f}\")\r\n        \r\n    def update_processing_interval(self, value):\r\n        self.processing_interval = value / 1000\r\n        \r\n    def update(self):\r\n            try:\r\n                # Check if session is still valid\r\n                if not self.auth_manager.is_authenticated():\r\n                    logger.warning(\"Session expired, closing application\")\r\n                    QMessageBox.warning(\r\n                        self,\r\n                        \"Session Expired\",\r\n                        \"Your session has expired. Please login again.\"\r\n                    )\r\n                    self.close()\r\n                    return\r\n                \r\n                frames = self.camera_manager.get_all_frames()\r\n                \r\n                for cam_id, frame in frames.items():\r\n                    if frame is None:\r\n                        continue\r\n                    \r\n                    current_time = time.time()\r\n                    \r\n                    # Verificar si hay un procesamiento en curso\r\n                    if cam_id in self.processing_futures:\r\n                        future = self.processing_futures[cam_id]\r\n                        if future.done():\r\n                            # Procesamiento completado, obtener resultado\r\n                            try:\r\n                                del self.processing_futures[cam_id]\r\n                            except Exception as e:\r\n                                logger.error(f\"Error removing future for camera {cam_id}: {e}\")\r\n                        else:\r\n                            # TodavÃ­a procesando, mostrar frame sin procesar\r\n                            self.display_frame(cam_id, frame)\r\n                            continue\r\n                    \r\n                    # Verificar cache\r\n                    if cam_id in self.processed_frames_cache:\r\n                        cached_frame, cache_time = self.processed_frames_cache[cam_id]\r\n                        if current_time - cache_time < self.cache_timeout:\r\n                            self.display_frame(cam_id, cached_frame)\r\n                            continue\r\n                    \r\n                    # Verificar intervalo de procesamiento\r\n                    last_time = self.last_processed.get(cam_id, 0)\r\n                    if current_time - last_time < self.processing_interval:\r\n                        self.display_frame(cam_id, frame)\r\n                        continue\r\n                    \r\n                    # Enviar a procesamiento asÃ­ncrono\r\n                    self.last_processed[cam_id] = current_time\r\n                    future = self.executor.submit(\r\n                        self.process_frame_async,\r\n                        cam_id,\r\n                        frame.copy()  # Importante: copiar el frame\r\n                    )\r\n                    self.processing_futures[cam_id] = future\r\n                    \r\n                    # Mostrar frame original mientras se procesa\r\n                    self.display_frame(cam_id, frame)\r\n                \r\n                # Actualizar estadÃ­sticas\r\n                self.update_status()\r\n                self.update_fps_display()\r\n                \r\n            except Exception as e:\r\n                logger.error(f\"Error in update loop: {e}\")\r\n                self.status_label.setText(f\"âŒ Error: {str(e)}\")\r\n    \r\n    def process_frame_async(self, cam_id: int, frame: np.ndarray) -> Tuple[int, np.ndarray, bool]:\r\n        \"\"\"\r\n        Procesar frame de manera asÃ­ncrona en thread pool.\r\n        Retorna: (cam_id, processed_frame, alert_triggered)\r\n        \"\"\"\r\n        start_time = time.time()\r\n        alert_triggered = False\r\n        \r\n        try:\r\n            faces = self.face_detector.detect_faces(frame)\r\n            \r\n            if not faces:\r\n                return (cam_id, frame, False)\r\n            \r\n            recognized_faces = self.face_detector.recognize_faces(faces)\r\n            camera_name = self.camera_manager.cameras[cam_id].name\r\n            \r\n            for face, known_face, confidence in recognized_faces:\r\n                if known_face:\r\n                    frame = draw_face_info(\r\n                        frame, face.bbox,\r\n                        name=known_face.name,\r\n                        confidence=confidence,\r\n                        camera_name=camera_name,\r\n                        age=face.age,\r\n                        gender=face.gender,\r\n                        timestamp=time.time()\r\n                    )\r\n                    \r\n                    # Trigger alert (esto es thread-safe)\r\n                    alert_event = self.alert_system.trigger_alert(\r\n                        cam_id, camera_name,\r\n                        known_face.name, face, confidence,\r\n                        frame\r\n                    )\r\n                    alert_triggered = True\r\n                    \r\n                    # Log to database (usar QTimer para ejecutar en main thread)\r\n                    user = self.auth_manager.get_current_user()\r\n                    QTimer.singleShot(0, lambda e=alert_event, u=user: self.log_face_event_safe(e, u))\r\n                    \r\n                else:\r\n                    frame = draw_face_info(\r\n                        frame, face.bbox,\r\n                        name=\"Desconocido\",\r\n                        confidence=confidence,\r\n                        camera_name=camera_name,\r\n                        timestamp=time.time()\r\n                    )\r\n            \r\n            # Registrar tiempo de procesamiento\r\n            processing_time = time.time() - start_time\r\n            self.record_frame_time(cam_id, processing_time)\r\n            \r\n            # Actualizar cache\r\n            self.processed_frames_cache[cam_id] = (frame, time.time())\r\n            \r\n            # Emitir seÃ±al para actualizar UI (thread-safe)\r\n            self.frame_processed.emit(cam_id, frame)\r\n            \r\n            return (cam_id, frame, alert_triggered)\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error processing frame for camera {cam_id}: {e}\")\r\n            return (cam_id, frame, False)\r\n    \r\n    def log_face_event_safe(self, event, user):\r\n        \"\"\"Log face event de manera thread-safe\"\"\"\r\n        try:\r\n            self.database.log_face_event(\r\n                event,\r\n                user_id=user.id if user else None\r\n            )\r\n        except Exception as e:\r\n            logger.error(f\"Error logging face event: {e}\")\r\n    \r\n    def on_frame_processed(self, cam_id: int, frame: np.ndarray):\r\n        \"\"\"Callback cuando un frame ha sido procesado (ejecutado en main thread)\"\"\"\r\n        try:\r\n            self.display_frame(cam_id, frame)\r\n        except Exception as e:\r\n            logger.error(f\"Error displaying processed frame: {e}\")\r\n    \r\n    def record_frame_time(self, cam_id: int, processing_time: float):\r\n        \"\"\"Registrar tiempo de procesamiento para estadÃ­sticas\"\"\"\r\n        if cam_id not in self.frame_times:\r\n            self.frame_times[cam_id] = []\r\n        \r\n        self.frame_times[cam_id].append(processing_time)\r\n        \r\n        # Mantener solo las Ãºltimas N muestras\r\n        if len(self.frame_times[cam_id]) > self.max_frame_time_samples:\r\n            self.frame_times[cam_id].pop(0)\r\n    \r\n    def get_average_frame_time(self, cam_id: int) -> float:\r\n        \"\"\"Obtener tiempo promedio de procesamiento\"\"\"\r\n        if cam_id not in self.frame_times or not self.frame_times[cam_id]:\r\n            return 0.0\r\n        return sum(self.frame_times[cam_id]) / len(self.frame_times[cam_id])\r\n    \r\n    def update_fps_display(self):\r\n        \"\"\"Actualizar display de FPS\"\"\"\r\n        try:\r\n            total_fps = 0\r\n            active_cameras = 0\r\n            \r\n            for cam_id in self.camera_manager.cameras:\r\n                if cam_id in self.frame_times and self.frame_times[cam_id]:\r\n                    avg_time = self.get_average_frame_time(cam_id)\r\n                    if avg_time > 0:\r\n                        fps = 1.0 / avg_time\r\n                        total_fps += fps\r\n                        active_cameras += 1\r\n            \r\n            if active_cameras > 0:\r\n                avg_fps = total_fps / active_cameras\r\n                self.fps_label.setText(f\"FPS: {avg_fps:.1f}\")\r\n                \r\n                # Cambiar color basado en rendimiento\r\n                if avg_fps >= 20:\r\n                    color = \"rgba(40, 167, 69, 0.3)\"  # Verde\r\n                elif avg_fps >= 10:\r\n                    color = \"rgba(255, 193, 7, 0.3)\"  # Amarillo\r\n                else:\r\n                    color = \"rgba(220, 53, 69, 0.3)\"  # Rojo\r\n                \r\n                self.fps_label.setStyleSheet(f\"\"\"\r\n                    font-size: 14px;\r\n                    color: rgba(255, 255, 255, 0.9);\r\n                    padding: 8px 16px;\r\n                    background-color: {color};\r\n                    border-radius: 6px;\r\n                    font-weight: 600;\r\n                \"\"\")\r\n            else:\r\n                self.fps_label.setText(\"FPS: --\")\r\n                \r\n        except Exception as e:\r\n            logger.error(f\"Error updating FPS display: {e}\")\r\n    \r\n    def display_frame(self, cam_id: int, frame: np.ndarray):\r\n        \"\"\"Mostrar frame en la UI (optimizado)\"\"\"\r\n        try:\r\n            if frame is None or cam_id not in self.camera_labels:\r\n                return\r\n            \r\n            # Convertir a pixmap (operaciÃ³n costosa, hacerla eficiente)\r\n            pixmap = numpy_to_pixmap(frame)\r\n            \r\n            # Escalar solo si es necesario\r\n            label_size = self.camera_labels[cam_id].size()\r\n            if pixmap.width() > label_size.width() or pixmap.height() > label_size.height():\r\n                pixmap = pixmap.scaled(\r\n                    label_size,\r\n                    Qt.KeepAspectRatio,\r\n                    Qt.FastTransformation  # Usar transformaciÃ³n rÃ¡pida\r\n                )\r\n            \r\n            self.camera_labels[cam_id].setPixmap(pixmap)\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error displaying frame for camera {cam_id}: {e}\")\r\n    \r\n    def update_status(self):\r\n        \"\"\"Actualizar display de estado\"\"\"\r\n        try:\r\n            status_text = []\r\n            \r\n            # User info\r\n            user = self.auth_manager.get_current_user()\r\n            if user:\r\n                status_text.append(f\"ðŸ‘¤ <b>Logged in as:</b> {user.username} ({user.role})\")\r\n            \r\n            status_text.append(\"<br>ðŸ“¹ <b>Estado de CÃ¡maras</b>\")\r\n            for cam_id, cam_config in self.camera_manager.cameras.items():\r\n                running = cam_id in self.camera_manager.capture_threads\r\n                icon = \"ðŸŸ¢\" if running else \"ðŸ”´\"\r\n                \r\n                # Agregar informaciÃ³n de rendimiento\r\n                if running and cam_id in self.frame_times and self.frame_times[cam_id]:\r\n                    avg_time = self.get_average_frame_time(cam_id)\r\n                    fps = 1.0 / avg_time if avg_time > 0 else 0\r\n                    status_text.append(\r\n                        f\"{icon} CÃ¡mara {cam_id} ({cam_config.name}): \"\r\n                        f\"Activa - {fps:.1f} FPS - {avg_time*1000:.0f}ms\"\r\n                    )\r\n                else:\r\n                    status_text.append(f\"{icon} CÃ¡mara {cam_id} ({cam_config.name}): {'Activa' if running else 'Detenida'}\")\r\n            \r\n            status_text.append(\"<br>ðŸ‘¤ <b>Base de Datos</b>\")\r\n            status_text.append(f\"Rostros conocidos: {len(self.face_detector.known_faces)}\")\r\n            \r\n            # EstadÃ­sticas del thread pool\r\n            status_text.append(\"<br>âš¡ <b>Rendimiento</b>\")\r\n            active_tasks = len([f for f in self.processing_futures.values() if not f.done()])\r\n            status_text.append(f\"Tareas activas: {active_tasks}/{self.executor._max_workers}\")\r\n            \r\n            status_text.append(\"<br>ðŸ”” <b>Alertas Recientes</b>\")\r\n            recent_alerts = self.alert_system.get_recent_alerts(3)\r\n            if recent_alerts:\r\n                for alert in recent_alerts:\r\n                    time_str = time.strftime(\"%H:%M:%S\", time.localtime(alert.timestamp))\r\n                    status_text.append(f\"â€¢ {time_str}: {alert.face_name} en {alert.camera_name} ({alert.confidence:.2f})\")\r\n            else:\r\n                status_text.append(\"Sin alertas recientes\")\r\n            \r\n            self.status_display.setText(\"<br>\".join(status_text))\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error updating status: {e}\")\r\n    \r\n    def closeEvent(self, event):\r\n        \"\"\"Cleanup al cerrar la aplicaciÃ³n\"\"\"\r\n        try:\r\n            user = self.auth_manager.get_current_user()\r\n            if user:\r\n                logger.info(f\"Application closing - User: {user.username}\")\r\n            \r\n            # Detener timer\r\n            self.update_timer.stop()\r\n            \r\n            # Detener cÃ¡maras\r\n            self.camera_manager.stop_all_cameras()\r\n            \r\n            # Esperar a que terminen las tareas de procesamiento\r\n            logger.info(\"Waiting for processing tasks to complete...\")\r\n            self.executor.shutdown(wait=True, timeout=5.0)\r\n            \r\n            # Limpiar cache\r\n            self.processed_frames_cache.clear()\r\n            self.processing_futures.clear()\r\n            \r\n            event.accept()\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error during shutdown: {e}\")\r\n            event.accept()",
    "user_management.py": "from PyQt5.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QTableWidget, \r\n                            QTableWidgetItem, QPushButton, QLabel, QLineEdit, \r\n                            QComboBox, QMessageBox, QHeaderView, QFrame, QGroupBox)\r\nfrom PyQt5.QtCore import Qt\r\nfrom PyQt5.QtGui import QColor\r\nfrom loguru import logger\r\nfrom typing import Optional\r\n\r\nclass UserManagementDialog(QDialog):\r\n    def __init__(self, database, auth_manager, parent=None):\r\n        super().__init__(parent)\r\n        self.database = database\r\n        self.auth_manager = auth_manager\r\n        \r\n        self.setWindowTitle(\"User Management\")\r\n        self.setGeometry(200, 100, 1000, 600)\r\n        self.setMinimumSize(900, 500)\r\n        \r\n        self.setup_style()\r\n        self.init_ui()\r\n        self.load_users()\r\n        \r\n    def setup_style(self):\r\n        \"\"\"Apply modern styling\"\"\"\r\n        self.setStyleSheet(\"\"\"\r\n            QDialog {\r\n                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,\r\n                    stop:0 #1a1a2e,\r\n                    stop:1 #16213e);\r\n            }\r\n            QLabel {\r\n                color: white;\r\n                font-size: 13px;\r\n            }\r\n            QLineEdit, QComboBox {\r\n                background-color: rgba(255, 255, 255, 0.08);\r\n                color: white;\r\n                border: 1px solid rgba(255, 255, 255, 0.15);\r\n                border-radius: 6px;\r\n                padding: 8px 12px;\r\n                font-size: 13px;\r\n            }\r\n            QLineEdit:focus, QComboBox:focus {\r\n                background-color: rgba(255, 255, 255, 0.12);\r\n                border: 1px solid rgba(0, 120, 212, 0.8);\r\n            }\r\n            QPushButton {\r\n                background-color: rgba(0, 120, 212, 0.8);\r\n                color: white;\r\n                border: none;\r\n                border-radius: 6px;\r\n                padding: 10px 20px;\r\n                font-size: 13px;\r\n                font-weight: 500;\r\n            }\r\n            QPushButton:hover {\r\n                background-color: rgba(0, 120, 212, 1);\r\n            }\r\n            QPushButton#deleteButton {\r\n                background-color: rgba(220, 53, 69, 0.8);\r\n            }\r\n            QPushButton#deleteButton:hover {\r\n                background-color: rgba(220, 53, 69, 1);\r\n            }\r\n            QTableWidget {\r\n                background-color: rgba(255, 255, 255, 0.05);\r\n                border: 1px solid rgba(255, 255, 255, 0.15);\r\n                border-radius: 8px;\r\n                color: white;\r\n                gridline-color: rgba(255, 255, 255, 0.1);\r\n            }\r\n            QTableWidget::item {\r\n                padding: 8px;\r\n            }\r\n            QTableWidget::item:selected {\r\n                background-color: rgba(0, 120, 212, 0.3);\r\n            }\r\n            QHeaderView::section {\r\n                background-color: rgba(0, 120, 212, 0.5);\r\n                color: white;\r\n                padding: 8px;\r\n                border: none;\r\n                font-weight: 600;\r\n            }\r\n            QGroupBox {\r\n                color: white;\r\n                border: 1px solid rgba(255, 255, 255, 0.15);\r\n                border-radius: 8px;\r\n                margin-top: 12px;\r\n                padding-top: 12px;\r\n                font-weight: 600;\r\n            }\r\n            QGroupBox::title {\r\n                subcontrol-origin: margin;\r\n                left: 10px;\r\n                padding: 0 5px;\r\n            }\r\n        \"\"\")\r\n        \r\n    def init_ui(self):\r\n        layout = QVBoxLayout(self)\r\n        layout.setContentsMargins(24, 24, 24, 24)\r\n        layout.setSpacing(20)\r\n        \r\n        # Title\r\n        title = QLabel(\"User Management\")\r\n        title.setStyleSheet(\"font-size: 24px; font-weight: bold; color: white;\")\r\n        layout.addWidget(title)\r\n        \r\n        # User form\r\n        form_group = QGroupBox(\"Add/Edit User\")\r\n        form_layout = QVBoxLayout(form_group)\r\n        form_layout.setSpacing(12)\r\n        \r\n        # Username\r\n        username_layout = QHBoxLayout()\r\n        username_layout.addWidget(QLabel(\"Username:\"))\r\n        self.username_input = QLineEdit()\r\n        self.username_input.setPlaceholderText(\"Enter username\")\r\n        username_layout.addWidget(self.username_input)\r\n        form_layout.addLayout(username_layout)\r\n        \r\n        # Email\r\n        email_layout = QHBoxLayout()\r\n        email_layout.addWidget(QLabel(\"Email:\"))\r\n        self.email_input = QLineEdit()\r\n        self.email_input.setPlaceholderText(\"user@example.com\")\r\n        email_layout.addWidget(self.email_input)\r\n        form_layout.addLayout(email_layout)\r\n        \r\n        # Password\r\n        password_layout = QHBoxLayout()\r\n        password_layout.addWidget(QLabel(\"Password:\"))\r\n        self.password_input = QLineEdit()\r\n        self.password_input.setEchoMode(QLineEdit.Password)\r\n        self.password_input.setPlaceholderText(\"Minimum 8 characters\")\r\n        password_layout.addWidget(self.password_input)\r\n        form_layout.addLayout(password_layout)\r\n        \r\n        # Role\r\n        role_layout = QHBoxLayout()\r\n        role_layout.addWidget(QLabel(\"Role:\"))\r\n        self.role_combo = QComboBox()\r\n        self.role_combo.addItems([\"viewer\", \"operator\", \"admin\"])\r\n        role_layout.addWidget(self.role_combo)\r\n        form_layout.addLayout(role_layout)\r\n        \r\n        # Buttons\r\n        button_layout = QHBoxLayout()\r\n        \r\n        self.add_btn = QPushButton(\"Add User\")\r\n        self.add_btn.clicked.connect(self.add_user)\r\n        button_layout.addWidget(self.add_btn)\r\n        \r\n        self.update_btn = QPushButton(\"Update User\")\r\n        self.update_btn.clicked.connect(self.update_user)\r\n        self.update_btn.setEnabled(False)\r\n        button_layout.addWidget(self.update_btn)\r\n        \r\n        self.clear_btn = QPushButton(\"Clear Form\")\r\n        self.clear_btn.clicked.connect(self.clear_form)\r\n        button_layout.addWidget(self.clear_btn)\r\n        \r\n        button_layout.addStretch()\r\n        form_layout.addLayout(button_layout)\r\n        \r\n        layout.addWidget(form_group)\r\n        \r\n        # Users table\r\n        table_label = QLabel(\"Existing Users\")\r\n        table_label.setStyleSheet(\"font-size: 16px; font-weight: 600; color: white;\")\r\n        layout.addWidget(table_label)\r\n        \r\n        self.users_table = QTableWidget()\r\n        self.users_table.setColumnCount(6)\r\n        self.users_table.setHorizontalHeaderLabels([\r\n            \"ID\", \"Username\", \"Email\", \"Role\", \"Status\", \"Last Login\"\r\n        ])\r\n        self.users_table.horizontalHeader().setSectionResizeMode(QHeaderView.Stretch)\r\n        self.users_table.setSelectionBehavior(QTableWidget.SelectRows)\r\n        self.users_table.setSelectionMode(QTableWidget.SingleSelection)\r\n        self.users_table.itemSelectionChanged.connect(self.on_user_selected)\r\n        layout.addWidget(self.users_table)\r\n        \r\n        # Action buttons\r\n        action_layout = QHBoxLayout()\r\n        \r\n        self.refresh_btn = QPushButton(\"Refresh\")\r\n        self.refresh_btn.clicked.connect(self.load_users)\r\n        action_layout.addWidget(self.refresh_btn)\r\n        \r\n        self.toggle_status_btn = QPushButton(\"Enable/Disable\")\r\n        self.toggle_status_btn.clicked.connect(self.toggle_user_status)\r\n        self.toggle_status_btn.setEnabled(False)\r\n        action_layout.addWidget(self.toggle_status_btn)\r\n        \r\n        self.delete_btn = QPushButton(\"Delete User\")\r\n        self.delete_btn.setObjectName(\"deleteButton\")\r\n        self.delete_btn.clicked.connect(self.delete_user)\r\n        self.delete_btn.setEnabled(False)\r\n        action_layout.addWidget(self.delete_btn)\r\n        \r\n        action_layout.addStretch()\r\n        \r\n        self.close_btn = QPushButton(\"Close\")\r\n        self.close_btn.clicked.connect(self.close)\r\n        action_layout.addWidget(self.close_btn)\r\n        \r\n        layout.addLayout(action_layout)\r\n        \r\n    def load_users(self):\r\n        \"\"\"Load all users into table\"\"\"\r\n        try:\r\n            users = self.database.get_all_users()\r\n            self.users_table.setRowCount(len(users))\r\n            \r\n            for row, user in enumerate(users):\r\n                self.users_table.setItem(row, 0, QTableWidgetItem(str(user['id'])))\r\n                self.users_table.setItem(row, 1, QTableWidgetItem(user['username']))\r\n                self.users_table.setItem(row, 2, QTableWidgetItem(user['email']))\r\n                self.users_table.setItem(row, 3, QTableWidgetItem(user['role']))\r\n                \r\n                # Status with color\r\n                status_item = QTableWidgetItem(\"Active\" if user['is_active'] else \"Disabled\")\r\n                if user['is_active']:\r\n                    status_item.setForeground(QColor(0, 200, 0))\r\n                else:\r\n                    status_item.setForeground(QColor(255, 100, 100))\r\n                self.users_table.setItem(row, 4, status_item)\r\n                \r\n                # Last login\r\n                if user['last_login']:\r\n                    from datetime import datetime\r\n                    last_login = datetime.fromtimestamp(user['last_login']).strftime(\"%Y-%m-%d %H:%M\")\r\n                else:\r\n                    last_login = \"Never\"\r\n                self.users_table.setItem(row, 5, QTableWidgetItem(last_login))\r\n                \r\n                # Make ID column read-only\r\n                self.users_table.item(row, 0).setFlags(Qt.ItemIsEnabled)\r\n                \r\n            logger.info(f\"Loaded {len(users)} users\")\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error loading users: {e}\")\r\n            QMessageBox.critical(self, \"Error\", f\"Failed to load users: {str(e)}\")\r\n    \r\n    def on_user_selected(self):\r\n        \"\"\"Handle user selection\"\"\"\r\n        selected_rows = self.users_table.selectedItems()\r\n        if not selected_rows:\r\n            self.update_btn.setEnabled(False)\r\n            self.toggle_status_btn.setEnabled(False)\r\n            self.delete_btn.setEnabled(False)\r\n            return\r\n        \r\n        # Enable buttons\r\n        self.update_btn.setEnabled(True)\r\n        self.toggle_status_btn.setEnabled(True)\r\n        self.delete_btn.setEnabled(True)\r\n        \r\n        # Load user data into form\r\n        row = self.users_table.currentRow()\r\n        self.username_input.setText(self.users_table.item(row, 1).text())\r\n        self.email_input.setText(self.users_table.item(row, 2).text())\r\n        self.password_input.clear()\r\n        self.password_input.setPlaceholderText(\"Leave empty to keep current password\")\r\n        \r\n        role = self.users_table.item(row, 3).text()\r\n        index = self.role_combo.findText(role)\r\n        if index >= 0:\r\n            self.role_combo.setCurrentIndex(index)\r\n    \r\n    def add_user(self):\r\n        \"\"\"Add new user\"\"\"\r\n        username = self.username_input.text().strip()\r\n        email = self.email_input.text().strip()\r\n        password = self.password_input.text()\r\n        role = self.role_combo.currentText()\r\n        \r\n        # Validate\r\n        if not username or not email or not password:\r\n            QMessageBox.warning(self, \"Validation Error\", \"Please fill in all fields\")\r\n            return\r\n        \r\n        if len(password) < 8:\r\n            QMessageBox.warning(self, \"Validation Error\", \"Password must be at least 8 characters\")\r\n            return\r\n        \r\n        # Check permission\r\n        if not self.auth_manager.has_permission('admin'):\r\n            QMessageBox.warning(self, \"Permission Denied\", \"Only admins can create users\")\r\n            return\r\n        \r\n        try:\r\n            # Hash password\r\n            password_hash = self.auth_manager.hash_password(password)\r\n            \r\n            # Create user\r\n            current_user = self.auth_manager.get_current_user()\r\n            user_id = self.database.create_user(\r\n                username, email, password_hash, role,\r\n                created_by=current_user.id if current_user else None\r\n            )\r\n            \r\n            if user_id:\r\n                QMessageBox.information(self, \"Success\", f\"User '{username}' created successfully\")\r\n                self.clear_form()\r\n                self.load_users()\r\n            else:\r\n                QMessageBox.warning(self, \"Error\", \"Username or email already exists\")\r\n                \r\n        except Exception as e:\r\n            logger.error(f\"Error creating user: {e}\")\r\n            QMessageBox.critical(self, \"Error\", f\"Failed to create user: {str(e)}\")\r\n    \r\n    def update_user(self):\r\n        \"\"\"Update selected user\"\"\"\r\n        row = self.users_table.currentRow()\r\n        if row < 0:\r\n            return\r\n        \r\n        user_id = int(self.users_table.item(row, 0).text())\r\n        email = self.email_input.text().strip()\r\n        role = self.role_combo.currentText()\r\n        password = self.password_input.text()\r\n        \r\n        # Check permission\r\n        if not self.auth_manager.has_permission('admin'):\r\n            QMessageBox.warning(self, \"Permission Denied\", \"Only admins can update users\")\r\n            return\r\n        \r\n        try:\r\n            # Update email and role\r\n            self.database.update_user(user_id, email=email, role=role)\r\n            \r\n            # Update password if provided\r\n            if password:\r\n                if len(password) < 8:\r\n                    QMessageBox.warning(self, \"Validation Error\", \"Password must be at least 8 characters\")\r\n                    return\r\n                password_hash = self.auth_manager.hash_password(password)\r\n                self.database.update_user_password(user_id, password_hash)\r\n            \r\n            QMessageBox.information(self, \"Success\", \"User updated successfully\")\r\n            self.clear_form()\r\n            self.load_users()\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error updating user: {e}\")\r\n            QMessageBox.critical(self, \"Error\", f\"Failed to update user: {str(e)}\")\r\n    \r\n    def toggle_user_status(self):\r\n        \"\"\"Enable/disable selected user\"\"\"\r\n        row = self.users_table.currentRow()\r\n        if row < 0:\r\n            return\r\n        \r\n        user_id = int(self.users_table.item(row, 0).text())\r\n        username = self.users_table.item(row, 1).text()\r\n        current_status = self.users_table.item(row, 4).text() == \"Active\"\r\n        \r\n        # Check permission\r\n        if not self.auth_manager.has_permission('admin'):\r\n            QMessageBox.warning(self, \"Permission Denied\", \"Only admins can change user status\")\r\n            return\r\n        \r\n        # Prevent disabling self\r\n        current_user = self.auth_manager.get_current_user()\r\n        if current_user and current_user.id == user_id:\r\n            QMessageBox.warning(self, \"Error\", \"You cannot disable your own account\")\r\n            return\r\n        \r\n        try:\r\n            new_status = not current_status\r\n            self.database.update_user(user_id, is_active=new_status)\r\n            \r\n            status_text = \"enabled\" if new_status else \"disabled\"\r\n            QMessageBox.information(self, \"Success\", f\"User '{username}' {status_text}\")\r\n            self.load_users()\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"Error toggling user status: {e}\")\r\n            QMessageBox.critical(self, \"Error\", f\"Failed to change status: {str(e)}\")\r\n    \r\n    def delete_user(self):\r\n        \"\"\"Delete selected user\"\"\"\r\n        row = self.users_table.currentRow()\r\n        if row < 0:\r\n            return\r\n        \r\n        user_id = int(self.users_table.item(row, 0).text())\r\n        username = self.users_table.item(row, 1).text()\r\n        \r\n        # Check permission\r\n        if not self.auth_manager.has_permission('admin'):\r\n            QMessageBox.warning(self, \"Permission Denied\", \"Only admins can delete users\")\r\n            return\r\n        \r\n        # Prevent deleting self\r\n        current_user = self.auth_manager.get_current_user()\r\n        if current_user and current_user.id == user_id:\r\n            QMessageBox.warning(self, \"Error\", \"You cannot delete your own account\")\r\n            return\r\n        \r\n        # Confirm deletion\r\n        reply = QMessageBox.question(\r\n            self, \"Confirm Deletion\",\r\n            f\"Are you sure you want to delete user '{username}'?\\n\\n\"\r\n            \"This will deactivate the account.\",\r\n            QMessageBox.Yes | QMessageBox.No,\r\n            QMessageBox.No\r\n        )\r\n        \r\n        if reply == QMessageBox.Yes:\r\n            try:\r\n                if self.database.delete_user(user_id):\r\n                    QMessageBox.information(self, \"Success\", f\"User '{username}' deleted\")\r\n                    self.clear_form()\r\n                    self.load_users()\r\n                else:\r\n                    QMessageBox.warning(self, \"Error\", \"Failed to delete user\")\r\n                    \r\n            except Exception as e:\r\n                logger.error(f\"Error deleting user: {e}\")\r\n                QMessageBox.critical(self, \"Error\", f\"Failed to delete user: {str(e)}\")\r\n    \r\n    def clear_form(self):\r\n        \"\"\"Clear input form\"\"\"\r\n        self.username_input.clear()\r\n        self.email_input.clear()\r\n        self.password_input.clear()\r\n        self.password_input.setPlaceholderText(\"Minimum 8 characters\")\r\n        self.role_combo.setCurrentIndex(0)\r\n        self.users_table.clearSelection()\r\n        self.update_btn.setEnabled(False)\r\n        self.toggle_status_btn.setEnabled(False)\r\n        self.delete_btn.setEnabled(False)"
  }
}